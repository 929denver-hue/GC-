<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿®å¾©æ™‚å…‰ï½œäº’æƒ ä¹‹ç´„</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* é…è‰²ï¼šæ£®ç³»å¢¨ç¶ ã€å¤éŠ…é‡‘ã€ç´™å¼µç±³è‰² */
            --primary-deep: #1a3c34; --primary-muted: #6a8d83; --accent-bronze: #a68b5b;
            --bg-cream: #f5f2ed; --text-dark: #2c2c2c; --text-light: #666666; --white-soft: #ffffff;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-cream);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            color: var(--text-dark); margin: 0; padding: 40px 20px 80px 20px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; letter-spacing: 0.05em;
        }

        h1, h2, h3, h4 { font-family: 'Noto Serif TC', serif; }
        .container { max-width: 550px; width: 100%; transition: opacity 0.5s; }

        /* å‰è¨€å¡ç‰‡ */
        .intro-card {
            background: var(--white-soft); padding: 40px 30px; border-radius: 4px;
            box-shadow: 0 10px 30px rgba(26, 60, 52, 0.05); margin-bottom: 50px;
            text-align: center; position: relative; border-top: 3px solid var(--accent-bronze);
        }
        .intro-divider { height: 1px; width: 60px; background: var(--accent-bronze); margin: 20px auto; }
        .intro-title { font-size: 1.6em; color: var(--primary-deep); margin: 0 0 10px 0; font-weight: 700; letter-spacing: 0.1em; }
        .intro-subtitle { font-family: 'Noto Serif TC', serif; font-size: 0.9em; color: var(--accent-bronze); margin-bottom: 25px; font-style: italic; }
        .intro-text { font-size: 0.95em; line-height: 2; color: var(--text-light); text-align: justify; font-weight: 300; }
        .highlight { color: var(--primary-deep); font-weight: 500; border-bottom: 1px dotted var(--accent-bronze); }

        /* è½‰ç›¤æ¨£å¼ */
        .wheel-wrapper {
            position: relative; width: 320px; height: 320px; margin: 0 auto 40px; padding: 12px;
            background: var(--white-soft); border-radius: 50%;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05), inset 0 0 15px rgba(166, 139, 91, 0.1); 
            border: 1px solid var(--accent-bronze);
        }
        canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .pointer-container { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); z-index: 10; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.1)); }
        .pointer-jewel { width: 20px; height: 20px; background: var(--primary-deep); border-radius: 50%; border: 2px solid var(--accent-bronze); margin: 0 auto; }
        .pointer-arrow { width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-top: 25px solid var(--primary-deep); margin-top: -5px; }
        .center-knob { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: radial-gradient(circle at 30% 30%, var(--accent-bronze), #8c734b); border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 5; border: 2px solid var(--white-soft); }
        .btn-spin {
            display: block; margin: 0 auto; background: var(--primary-deep); color: var(--accent-bronze);
            border: 1px solid var(--accent-bronze); padding: 15px 50px; font-size: 1.1em; border-radius: 2px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(26, 60, 52, 0.15); transition: all 0.3s ease; letter-spacing: 0.15em; font-family: 'Noto Serif TC', serif;
        }
        .btn-spin:hover { background: var(--accent-bronze); color: var(--primary-deep); box-shadow: 0 8px 20px rgba(166, 139, 91, 0.2); }

        /* æ‰‹å‹•é¸æ“‡æ¸…å–® */
        .manual-section { margin-top: 60px; }
        .section-header { text-align: center; margin-bottom: 30px; }
        .section-title { font-size: 1.1em; color: var(--primary-deep); font-weight: normal; }
        .section-line { width: 30px; height: 1px; background: var(--accent-bronze); margin: 15px auto; }
        .card-grid { display: grid; gap: 15px; }
        .card {
            background: var(--white-soft); padding: 25px; border-radius: 4px;
            border: 1px solid #eee; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%; background: var(--accent-bronze); opacity: 0.5; transition: all 0.3s; }
        .card:hover { border-color: var(--accent-bronze); box-shadow: 0 10px 25px rgba(166, 139, 91, 0.1); transform: translateY(-2px); }
        .card:hover::before { opacity: 1; }
        .card h4 { margin: 0 0 10px 0; color: var(--primary-deep); font-size: 1.1em; letter-spacing: 0.05em; }
        .card p { margin: 0; font-size: 0.9em; color: var(--text-light); line-height: 1.6; }

        /* é ç´„å€å¡Š */
        .booking-section {
            margin-top: 60px; background: linear-gradient(145deg, #ffffff, #f9f9f9); padding: 35px 30px;
            border-radius: 8px; border: 1px solid #e0e0e0; text-align: center; position: relative;
        }
        .booking-section::after {
            content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 1px dashed var(--accent-bronze); pointer-events: none; border-radius: 4px; opacity: 0.3;
        }
        .booking-title { font-size: 1.3em; color: var(--primary-deep); margin-bottom: 10px; font-weight: 700; }
        .booking-desc { font-size: 0.9em; color: var(--text-light); margin-bottom: 25px; }

        .slots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; position: relative; z-index: 2; }
        .slot-btn {
            background: white; border: 1px solid #dcdcdc; color: var(--text-dark); padding: 12px 5px;
            border-radius: 4px; font-size: 0.95em; cursor: pointer; transition: all 0.3s;
            font-family: 'Noto Sans TC', sans-serif; letter-spacing: 0.05em;
        }
        .slot-btn:hover { border-color: var(--primary-muted); color: var(--primary-deep); }
        .slot-btn.active { background: var(--primary-deep); color: var(--accent-bronze); border-color: var(--primary-deep); box-shadow: 0 5px 15px rgba(26, 60, 52, 0.2); font-weight: bold; }
        .slot-btn.removing { transform: scale(0); opacity: 0; margin: 0; padding: 0; height: 0; overflow: hidden; border: none; }

        .name-input-group { margin-bottom: 25px; position: relative; z-index: 2; text-align: left; max-width: 300px; margin-left: auto; margin-right: auto; display: none; }
        .name-label { display: block; font-size: 0.9em; color: var(--primary-deep); margin-bottom: 8px; font-weight: bold; }
        .name-input { width: 100%; padding: 12px; border: 1px solid #dcdcdc; border-radius: 4px; font-size: 1em; font-family: 'Noto Sans TC', sans-serif; box-sizing: border-box; transition: 0.3s; }
        .name-input:focus { outline: none; border-color: var(--accent-bronze); box-shadow: 0 0 8px rgba(166, 139, 91, 0.1); }

        .btn-book {
            background: var(--accent-bronze); color: white; border: none; padding: 14px 40px;
            font-size: 1em; border-radius: 2px; cursor: pointer; box-shadow: 0 5px 15px rgba(166, 139, 91, 0.3);
            transition: all 0.3s; font-family: 'Noto Serif TC', serif; letter-spacing: 0.1em; position: relative; z-index: 2;
        }
        .btn-book:hover { background: #8c734b; transform: translateY(-2px); }
        .btn-book:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }

        .full-booked-text { color: var(--primary-deep); font-size: 1.1em; line-height: 1.8; padding: 20px; border: 1px solid var(--accent-bronze); border-radius: 8px; background: rgba(255,255,255,0.5); }

        /* å¤±æ•ˆé€£çµçš„æº«é¦¨å‘Šç¤ºå¡ */
        .expired-overlay {
            display: none; /* é è¨­éš±è— */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-cream); z-index: 2000;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        .expired-card {
            background: white; padding: 40px 30px; border-radius: 8px;
            box-shadow: 0 20px 50px rgba(26, 60, 52, 0.1);
            border-top: 5px solid var(--accent-bronze);
            max-width: 400px; width: 100%;
        }
        .expired-icon { font-size: 3em; color: var(--primary-muted); margin-bottom: 20px; display: block; }
        .expired-title { font-family: 'Noto Serif TC', serif; font-size: 1.5em; color: var(--primary-deep); margin-bottom: 15px; font-weight: bold; }
        .expired-desc { color: var(--text-light); line-height: 1.8; margin-bottom: 30px; font-size: 1em; }

        /* ä¸€èˆ¬å½ˆçª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 60, 52, 0.7); backdrop-filter: blur(5px); z-index: 1000; animation: fadeIn 0.4s ease; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--white-soft); padding: 50px 40px; border-radius: 4px; width: 85%; max-width: 360px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.3); border-top: 4px solid var(--accent-bronze); }
        .close-icon { position: absolute; top: 20px; right: 20px; font-size: 24px; color: #ccc; cursor: pointer; transition: color 0.2s; font-family: sans-serif; }
        .close-icon:hover { color: var(--primary-deep); }
        .modal h2 { color: var(--primary-deep); margin: 15px 0; font-size: 1.6em; }
        .modal-divider { width: 40px; height: 2px; background: var(--accent-bronze); margin: 20px auto; }
        .modal-desc { margin: 25px 0; line-height: 1.8; color: var(--text-dark); font-size: 1em; }
        .btn-line { background: #06c755; color: white; border: none; padding: 15px 0; width: 100%; border-radius: 2px; font-size: 1em; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; text-decoration: none; font-weight: 500; margin-top: 30px; transition: background 0.3s; }
        .btn-line:hover { background: #05a546; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="expired-view" class="expired-overlay">
    <div class="expired-card">
        <span class="expired-icon">â³</span>
        <h2 class="expired-title">é€£çµå·²æ›´æ–°</h2>
        <div class="expired-desc">
            è¦ªæ„›çš„å¥½å‹ï¼Œé ç´„ä»£ç¢¼å·²å¤±æ•ˆã€‚<br>
            å¦‚æƒ³é ç´„ä¿®å¾©æ™‚å…‰ï¼Œè«‹ç§è¨Šç´¢å–æœ¬æœˆä»½æœ€æ–°çš„é€£çµã€‚
        </div>
        <a href="https://line.me/R/msg/text/?Hi%20å°æ´µï¼ŒåŸæœ¬çš„é€£çµå¥½åƒæ›´æ–°äº†ï¼Œæˆ‘æƒ³ç´¢å–é€™å€‹æœˆæ–°çš„é ç´„é€£çµï¼è¬è¬ğŸŒ¿" target="_blank" class="btn-line" style="margin-top:0;">
            <span>ğŸ’¬ ç§è¨Šç´¢å–æ–°é€£çµ</span>
        </a>
    </div>
</div>

<div class="container" id="main-container">
    <div class="intro-card">
        <h2 class="intro-title">ä¿®å¾©æ™‚å…‰ â€§ äº’æƒ ä¹‹ç´„</h2>
        <p class="intro-subtitle">Reciprocity & Healing Journey</p>
        <div class="intro-divider"></div>
        <div class="intro-text">
            <p>çœ‹è¦‹å¥½å‹å€‘èˆ’å±•çœ‰é ­ã€èº«å¿ƒè¼•ç›ˆï¼Œä¾¿æ˜¯æˆ‘æœ€æ·±çš„æ»¿è¶³ã€‚</p>
            <p>é€™éé—œå·¥ä½œï¼Œè€Œæ˜¯æºæ–¼å°<span class="highlight">GCè´ˆç‰©ç¶² äº’æƒ ç²¾ç¥</span>çš„ç†±æ„›èˆ‡å»¶çºŒã€‚æˆ‘å€‘ä¹‹é–“ä¸è«‡é‡‘éŒ¢ï¼Œåªè«–å¿ƒæ„æµå‹•ã€‚</p>
            <p>ç‚ºäº†è®“é€™ä»½ç¾å¥½èƒ½é•·ä¹…å¾ªç’°ï¼Œæˆ‘æº–å‚™äº†é€™ä»½ã€äº’æƒ ä¹‹ç´„ã€‘ã€‚è«‹éš¨å¿ƒè½‰å‹•ç¾…ç›¤ï¼Œæˆ–å¾ä¸‹æ–¹ç®‹è¨€ä¸­æ“‡ä¸€ï¼Œä½œç‚ºæˆ‘å€‘ä¹‹é–“äº¤æ›çš„æ–¹å¼ã€‚æ‚¨çš„å›é¥‹ï¼Œæ˜¯æˆ‘æŒçºŒç²¾é€²çš„å‹•åŠ›ğŸŒ¿</p>
        </div>
    </div>

    <div class="wheel-wrapper">
        <div class="pointer-container"><div class="pointer-jewel"></div><div class="pointer-arrow"></div></div>
        <div class="center-knob"></div>
        <canvas id="wheel" width="640" height="640"></canvas>
    </div>
    <button class="btn-spin" onclick="spinWheel()">å•Ÿå‹•äº’æƒ ç¾…ç›¤</button>

    <div class="manual-section">
        <div class="section-header">
            <h3 class="section-title">æˆ–è€…ï¼Œé¸æ“‡æ‚¨å±¬æ„çš„æ–¹å¼</h3>
            <div class="section-line"></div>
        </div>
        <div class="card-grid" id="card-list"></div>
    </div>

    <div class="booking-section">
        <h3 class="booking-title">é ç´„ä¸‹ä¸€æ¬¡ä¿®å¾©</h3>
        <p class="booking-desc" id="booking-subtitle">è«‹é»é¸æ™‚æ®µä¸¦è¼¸å…¥æ‚¨çš„ç¨±å‘¼</p>
        <div class="slots-grid" id="slots-container">
            <p style="color:#a68b5b;">æ­£åœ¨è®€å–é ç´„æœ¬...</p>
        </div>
        <div class="name-input-group" id="name-group">
            <label class="name-label">é ç´„å¤§å/ç¨±å‘¼</label>
            <input type="text" id="user-name" class="name-input" placeholder="ä¾‹å¦‚ï¼šChris">
        </div>
        <button id="book-btn" class="btn-book" onclick="submitBooking()">è«‹å…ˆé¸æ“‡æ™‚æ®µ</button>
    </div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <span class="close-icon" onclick="closeModal()">Ã—</span>
        <p style="font-size: 0.9em; color: var(--accent-bronze); margin-bottom: 5px; font-family: 'Noto Serif TC', serif; font-style: italic;">The Covenant</p>
        <h2 id="result-title"></h2>
        <div class="modal-divider"></div>
        <div id="result-desc" class="modal-desc"></div>
        <a id="line-btn" href="#" class="btn-line" target="_blank"><span>ğŸ’¬ å‚³é€ Line èˆ‡å°æ´µç¢ºèª</span></a>
    </div>
</div>

<script>
    // â˜…â˜…â˜… API ç¶²å€ (ç¢ºèªæ˜¯æ–°çš„) â˜…â˜…â˜…
    const API_URL = "https://script.google.com/macros/s/AKfycbzYv-P9YaCoVcXUkK1lRMV6phksO_kefa52om5viq7vxaHAzr5Z-aTU8FlVT_utIzOONw/exec";

    // å¾ç¶²å€ç²å–é‡‘é‘° (Key)
    const urlParams = new URLSearchParams(window.location.search);
    const accessKey = urlParams.get('key'); 

    // è½‰ç›¤é‚è¼¯ (è³‡æ–™å·²æ›´æ–°)
    const options = [
        { title: "ç”Ÿæ´»å°ç¢ºå¹¸", desc: "è«‹æˆ‘å–ä¸€æ¯ä½ æœ€è¿‘å¿ƒé ­å¥½çš„é£²æ–™ã€‚ï¼ˆè²¼å¿ƒå‚™è¨»ï¼šæˆ‘åå¥½ç„¡ç³–å£å‘³ï¼‰", color: "#f0f5f3" }, 
        { title: "å°ˆæ¥­æ‡‰æ´", desc: "å›å®¶å¾Œéœå¿ƒæ„Ÿå—èº«é«”çš„ç´°å¾®è®ŠåŒ–ï¼Œå‚³ Line çµ¦æˆ‘è©³ç´°å›é¥‹ï¼ŒåŠ©æˆ‘ç²¾é€²æŠ€è¡“ã€‚", color: "#f7f4ef" }, 
        { title: "æŠ€èƒ½äº¤æ›", desc: "æ“”ä»»æˆ‘çš„ä¸€æ—¥å°å¸«ï¼åˆ†äº«ä¸€å€‹æ‚¨æ“…é•·çš„å°ˆæ¥­é ˜åŸŸï¼Œæˆ–æœ€è¿‘ç¿’å¾—çš„æ–°çŸ¥ã€‚", color: "#f2f4f7" }, 
        // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šè´ŠåŠ©GC é¸é … (åŠ å…¥ link å±¬æ€§) â˜…â˜…â˜…
        { title: "è´ŠåŠ© GCè´ˆç‰©ç¶² ", desc: "æ”¯æŒåˆ†äº«èˆ‡å…±äº«çš„ç¾å¥½å¾ªç’°ï¼Œè®“æ¯ä¸€ä»½å¿ƒæ„æŒçºŒå‰µé€ åƒ¹å€¼ã€‚", color: "#fcf7f2", link: "https://www.give-circle.com/heartwallwords" }, 
        { title: "èº«å¿ƒä¿®å¾©", desc: "ä»Šæ™šè«‹å¿ƒç„¡ç½£ç¤™åœ°æ·±å±¤ç¡çœ ï¼Œæ‚¨å……æ»¿å…ƒæ°£çš„æ¨£å­ï¼Œå°±æ˜¯å°æˆ‘æ‰‹è—æœ€é«˜çš„è®šç¾ã€‚", color: "#f4f0f5" }  
    ];
    
    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    function drawWheel() {
        const arc = (2 * Math.PI) / options.length; const radius = 320; ctx.translate(320, 320); 
        options.forEach((opt, i) => {
            const angle = i * arc; ctx.beginPath(); ctx.moveTo(0, 0); ctx.arc(0, 0, radius, angle, angle + arc);
            ctx.fillStyle = opt.color; ctx.fill(); ctx.strokeStyle = "#a68b5b"; ctx.lineWidth = 1; ctx.stroke();
            ctx.save(); ctx.rotate(angle + arc / 2); ctx.textAlign = "right"; ctx.fillStyle = "#1a3c34"; ctx.font = "500 26px 'Noto Serif TC'"; 
            ctx.fillText(opt.title, 270, 10); ctx.restore();
        });
        ctx.beginPath(); ctx.arc(0, 0, radius - 5, 0, 2 * Math.PI); ctx.strokeStyle = "rgba(166, 139, 91, 0.3)"; ctx.lineWidth = 10; ctx.stroke();
    }
    const listContainer = document.getElementById('card-list');
    options.forEach(opt => {
        const div = document.createElement('div'); div.className = 'card';
        div.innerHTML = `<div class="card-content"><h4>${opt.title}</h4><p>${opt.desc}</p></div>`;
        div.onclick = () => showResult(opt); listContainer.appendChild(div);
    });
    let rotation = 0;
    function spinWheel() {
        const randomDeg = Math.floor(Math.random() * 360); const totalDeg = 1800 + randomDeg; rotation += totalDeg; 
        canvas.style.transform = `rotate(${rotation}deg)`;
        setTimeout(() => { showResult(options[Math.floor((360 - (rotation % 360) + 270) % 360 / (360 / options.length)) % options.length]); }, 5000);
    }
    
    // â˜…â˜…â˜… å½ˆçª—é‚è¼¯ä¿®æ”¹ï¼šæ”¯æ´é€£çµè·³è½‰ â˜…â˜…â˜…
    function showResult(opt) {
        document.getElementById('result-title').innerText = opt.title; 
        document.getElementById('result-desc').innerText = opt.desc;
        
        const lineBtn = document.getElementById('line-btn');
        
        // å¦‚æœé€™å€‹é¸é …æœ‰è¨­å®šé€£çµ (GC è´ŠåŠ©)ï¼Œå°±æ”¹æˆå‰å¾€ç¶²é 
        if (opt.link) {
            lineBtn.href = opt.link;
            lineBtn.innerHTML = '<span>â¤ï¸ å‰å¾€æ”¯æŒé é¢</span>';
        } else {
            // ä¸€èˆ¬é¸é …ï¼šç”¢ç”Ÿä¹¾æ·¨çš„ Line è¨Šæ¯
            let message = `Hi å°æ´µï¼Œæ„Ÿè¬ä»Šæ—¥çš„å°ˆæ¥­ä¿®å¾©ï¼\næˆ‘é¸æ“‡äº†ã€${opt.title}ã€‘ã€‚\nå…§å®¹ï¼šã€Œ${opt.desc}ã€`;
            lineBtn.href = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            lineBtn.innerHTML = '<span>ğŸ’¬ å‚³é€ Line èˆ‡å°æ´µç¢ºèª</span>';
        }
        
        document.getElementById('modal').style.display = 'block';
    }

    // é ç´„èˆ‡é©—è­‰åŠŸèƒ½
    let selectedSlot = null;
    async function loadAvailableTimes() {
        const container = document.getElementById('slots-container');
        const nameGroup = document.getElementById('name-group');
        const bookBtn = document.getElementById('book-btn');
        const subtitle = document.getElementById('booking-subtitle');
        const mainContainer = document.getElementById('main-container');
        const expiredView = document.getElementById('expired-view');

        try {
            const response = await fetch(`${API_URL}?action=getSlots&key=${encodeURIComponent(accessKey || "")}`);
            const data = await response.json();
            
            container.innerHTML = ''; 

            if (data.error === "InvalidKey") {
                mainContainer.style.display = 'none'; 
                expiredView.style.display = 'flex';   
                return;
            }
            
            if (data.length === 0) {
                // é¡æ»¿
                container.innerHTML = '<div class="full-booked-text">æœ¬æœŸé ç´„å·²å…¨æ•¸é¡æ»¿åš•ï½<br>è«‹ç•™æ„å°æ´µçš„å¾ŒçºŒå…¬å‘Šï¼ŒæœŸå¾…ä¸‹æ¬¡èˆ‡æ‚¨ç›¸è¦‹ã€‚ğŸŒ¿</div>';
                nameGroup.style.display = 'none'; bookBtn.style.display = 'none'; subtitle.style.display = 'none';
            } else {
                // æœ‰ç©ºä½ (åªé¡¯ç¤ºç©ºä½æŒ‰éˆ•ï¼Œä¸é¡¯ç¤ºç§è¨ŠæŒ‰éˆ•)
                nameGroup.style.display = 'block'; bookBtn.style.display = 'inline-block'; subtitle.style.display = 'block';
                data.forEach(time => {
                    const btn = document.createElement('button'); btn.className = 'slot-btn'; btn.innerText = time;
                    btn.onclick = () => selectSlot(btn, time); container.appendChild(btn);
                });
            }
        } catch (error) {
            console.error(error); container.innerHTML = '<p style="color:red;">ç³»çµ±é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
        }
    }

    function selectSlot(btn, time) {
        document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active'); selectedSlot = time; checkForm(); 
    }
    document.getElementById('user-name').addEventListener('input', checkForm);
    
    function checkForm() {
        const name = document.getElementById('user-name').value.trim(); const bookBtn = document.getElementById('book-btn');
        if (!selectedSlot) { bookBtn.innerText = "è«‹å…ˆé¸æ“‡æ™‚æ®µ"; bookBtn.disabled = true; return; }
        if (!name) { bookBtn.innerText = "è«‹è¼¸å…¥é ç´„å¤§å"; bookBtn.disabled = true; return; }
        bookBtn.disabled = false; bookBtn.innerText = "ç¢ºèªé ç´„æ­¤æ™‚æ®µ";
    }

    async function submitBooking() {
        if (!selectedSlot) return;
        const userName = document.getElementById('user-name').value.trim(); const bookBtn = document.getElementById('book-btn');
        
        bookBtn.disabled = true; bookBtn.innerText = "é ç´„é–å®šä¸­...";
        try {
            await fetch(`${API_URL}?action=bookSlot&key=${encodeURIComponent(accessKey || "")}&time=${encodeURIComponent(selectedSlot)}&name=${encodeURIComponent(userName)}`, { method: 'POST', mode: 'no-cors' });
            const activeBtn = document.querySelector('.slot-btn.active');
            if (activeBtn) { activeBtn.classList.add('removing'); setTimeout(() => { activeBtn.style.display = 'none'; activeBtn.classList.remove('active'); }, 500); }
            openLineAndModal(selectedSlot, userName);
            document.getElementById('user-name').value = ''; selectedSlot = null; bookBtn.innerText = "è«‹é¸æ“‡å…¶ä»–æ™‚æ®µ";
        } catch (error) {
            alert("é€£ç·šç•°å¸¸ï¼Œè«‹ç›´æ¥ç§è¨Šç¢ºèªã€‚"); bookBtn.disabled = false; bookBtn.innerText = "ç¢ºèªé ç´„æ­¤æ™‚æ®µ";
        }
    }

    function openLineAndModal(timeSlot, name) {
        document.getElementById('result-title').innerText = "é ç´„è«‹æ±‚ç¢ºèª";
        document.getElementById('result-desc').innerText = `ç³»çµ±å·²é–å®šæ™‚æ®µï¼š\n${timeSlot}\n\né ç´„äººï¼š${name}\n\nè«‹å‹™å¿…æŒ‰ä¸‹æŒ‰éˆ•ï¼Œå‚³é€ Line è¨Šæ¯çµ¦æˆ‘æ‰ç®—å®Œæˆå–”ï¼`;
        
        // â˜…â˜…â˜… ç´”æ–‡å­—è¨Šæ¯ï¼Œä¸å«ç¶²å€ â˜…â˜…â˜…
        let message = `Hi å°æ´µï¼Œæˆ‘æ˜¯ ${name}ï¼Œæˆ‘å·²åœ¨ç¶²é ä¸Šé–å®šé ç´„ï¼ğŸŒ¿\n\næ™‚æ®µï¼šã€${timeSlot}ã€‘\n\nè«‹å¹«æˆ‘ä¿ç•™ï¼Œè¬è¬ï¼`;
        
        const lineBtn = document.getElementById('line-btn');
        lineBtn.href = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
        lineBtn.innerHTML = '<span>ğŸ’¬ å‚³é€ Line èˆ‡å°æ´µç¢ºèª</span>'; // ç¢ºä¿é€™è£¡æ˜¯é ç´„ç¢ºèªæ–‡å­—
        
        document.getElementById('modal').style.display = 'block';
    }
    
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    document.fonts.ready.then(function () { drawWheel(); });
    document.addEventListener('DOMContentLoaded', loadAvailableTimes);
</script>

</body>
</html>
