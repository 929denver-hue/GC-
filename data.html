<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² ç‰©æµæœˆåº¦ç‡Ÿé‹çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .kpi-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .kpi-card h3 { margin: 0; color: #7f8c8d; font-size: 0.9rem; }
        .kpi-value { font-size: 1.8rem; font-weight: bold; margin-top: 10px; color: #2c3e50; }
        .chart-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }
        .tag-ibox { color: #3498db; font-weight: bold; }
        .tag-hilife { color: #e67e22; font-weight: bold; }
        .tag-fami { color: #27ae60; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š ç‰©æµç‡Ÿé‹æœˆåº¦çœ‹æ¿</h1>
        <button onclick="fetchData()" style="padding: 10px 20px; cursor: pointer;">é‡æ–°æ•´ç†æ•¸æ“š</button>
    </div>

    <div class="kpi-container">
        <div class="kpi-card"><h3>æœ¬æœˆç¸½åˆ©æ½¤ (é ä¼°)</h3><div id="kpi-profit" class="kpi-value">$0</div></div>
        <div class="kpi-card"><h3>ç¸½ç‰©æµé‡</h3><div id="kpi-vol" class="kpi-value">0</div></div>
        <div class="kpi-card"><h3>æœ€é«˜åˆ©æ½¤é€šè·¯</h3><div id="kpi-best" class="kpi-value">-</div></div>
    </div>

    <div class="chart-card">
        <h3>ğŸ“ˆ å„æœˆç‰©æµæç›Šè¶¨å‹¢</h3>
        <canvas id="trendChart" height="100"></canvas>
    </div>

    <div class="chart-card">
        <h3>ğŸ“‹ ç•¶æœˆæ˜ç´°è³‡æ–™</h3>
        <table>
            <thead>
                <tr>
                    <th>æœˆä»½</th>
                    <th>ç‰©æµå•†</th>
                    <th>ä»¶æ•¸</th>
                    <th>å–®ä»¶æ·¨åˆ© (CM)</th>
                    <th>å°è¨ˆåˆ©æ½¤</th>
                </tr>
            </thead>
            <tbody id="data-table">
                </tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = 'YOUR_API_URL_HERE'; // å¡«å…¥ä½ çš„ Google Apps Script URL

    async function fetchData() {
        try {
            const response = await fetch(API_URL);
            const rawData = await response.json();
            processAndRender(rawData);
        } catch (e) {
            alert('ç„¡æ³•ç²å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ API URL æˆ– Google Sheets æ¬Šé™');
        }
    }

    function processAndRender(data) {
        const tableBody = document.getElementById('data-table');
        tableBody.innerHTML = '';
        
        let totalProfit = 0;
        let totalVol = 0;
        let providerStats = {};

        // æ•´ç†æ­·å²åœ–è¡¨éœ€è¦çš„æ¨™ç±¤
        const months = [...new Set(data.map(d => d.Month))].sort();
        const trendData = {
            ibox: months.map(m => calcProfit(data.find(d => d.Month === m && d.Provider === 'ibox'))),
            hilife: months.map(m => calcProfit(data.find(d => d.Month === m && d.Provider === 'hilife'))),
            fami: months.map(m => calcProfit(data.find(d => d.Month === m && d.Provider === 'fami')))
        };

        data.forEach(item => {
            const cm = (item.Revenue + item.Rebate) / 1.05 - (item.Revenue * 0.022) - item.Cost - item.Subsidy;
            const subProfit = cm * item.Volume;
            
            totalProfit += subProfit;
            totalVol += item.Volume;

            const row = `<tr>
                <td>${item.Month}</td>
                <td class="tag-${item.Provider}">${item.Provider.toUpperCase()}</td>
                <td>${item.Volume.toLocaleString()}</td>
                <td>$${cm.toFixed(1)}</td>
                <td>$${Math.round(subProfit).toLocaleString()}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        document.getElementById('kpi-profit').innerText = `$${Math.round(totalProfit).toLocaleString()}`;
        document.getElementById('kpi-vol').innerText = totalVol.toLocaleString();
        
        renderChart(months, trendData);
    }

    function calcProfit(d) {
        if (!d) return 0;
        const cm = (d.Revenue + d.Rebate) / 1.05 - (d.Revenue * 0.022) - d.Cost - d.Subsidy;
        return Math.round(cm * d.Volume);
    }

    function renderChart(labels, trendData) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'iBOX', data: trendData.ibox, borderColor: '#3498db', tension: 0.3 },
                    { label: 'èŠçˆ¾å¯Œ', data: trendData.hilife, borderColor: '#e67e22', tension: 0.3 },
                    { label: 'å…¨å®¶', data: trendData.fami, borderColor: '#27ae60', tension: 0.3 }
                ]
            }
        });
    }

    fetchData(); // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
</script>
</body>
</html>
