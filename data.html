<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² | ç‰©æµæ•¸æ“šçœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ibox: #90ee90; --hilife: #e74c3c; --fami: #add8e6; --bg: #f4f7f9; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #2c3e50; }
        .container { max-width: 1200px; margin: auto; }
        .layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        
        .sidebar { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); height: fit-content; position: sticky; top: 20px; }
        .filter-group { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
        .select-all { font-size: 12px; color: #3498db; cursor: pointer; text-decoration: underline; }

        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .kpi-value { font-size: 2rem; font-weight: bold; margin: 5px 0; }
        .kpi-label { font-size: 0.9rem; color: #666; }
        .kpi-sub { font-size: 0.85rem; color: #7f8c8d; }
        .up { color: #27ae60; } .down { color: #e74c3c; }

        .chart-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }

        .btn-main { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-refresh { width: 100%; padding: 8px; background: #f8f9fa; border: 1px solid #ddd; margin-bottom: 15px; cursor: pointer; border-radius: 6px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="layout">
        <aside class="sidebar">
            <button class="btn-refresh" onclick="loadData(true)">ğŸ”„ å¼·åˆ¶åˆ·æ–°é›²ç«¯æ•¸æ“š</button>
            <div class="filter-group">
                <div class="filter-header">1. ç‰©æµå•† <span class="select-all" onclick="toggleAll('.prov-check')">å…¨é¸/å–æ¶ˆ</span></div>
                <label style="display:block; margin-bottom:8px;"><input type="checkbox" class="prov-check" value="ibox" checked> iéƒµç®± (æ·ºç¶ )</label>
                <label style="display:block; margin-bottom:8px;"><input type="checkbox" class="prov-check" value="hilife" checked> èŠçˆ¾å¯Œ (ç´…è‰²)</label>
                <label style="display:block; margin-bottom:8px;"><input type="checkbox" class="prov-check" value="fami" checked> å…¨å®¶ (æ·ºè—)</label>
            </div>
            <div class="filter-group">
                <div class="filter-header">2. æ—¥æœŸå€é–“ <span class="select-all" onclick="toggleAll('.date-check')">å…¨é¸/å–æ¶ˆ</span></div>
                <div id="date-list" style="max-height: 250px; overflow-y: auto;"></div>
            </div>
            <button class="btn-main" onclick="render()">ğŸš€ æ›´æ–°åœ–è¡¨æ•¸æ“š</button>
        </aside>

        <main>
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">é¸ä¸­ç¯„åœç¸½ä»¶æ•¸</div>
                    <div id="kpi-total" class="kpi-value">0</div>
                    <div class="kpi-sub">ç´¯è¨ˆåŒ…è£¹é‡</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">èˆ‡ä¸Šå€‹æœˆæ¯”è¼ƒ</div>
                    <div id="kpi-mom" class="kpi-value">-</div>
                    <div id="kpi-mom-sub" class="kpi-sub">å°æ¯”å‰ä¸€æœˆæ•¸æ“š</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">èˆ‡å»å¹´åŒæœŸæ¯”è¼ƒ</div>
                    <div id="kpi-yoy" class="kpi-value">-</div>
                    <div id="kpi-yoy-sub" class="kpi-sub">å°æ¯”å»å¹´åŒæœˆæ•¸æ“š</div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="card">
                    <h3>ğŸ“ˆ å¯„ä»¶é‡è¶¨å‹¢è¶¨å‹¢</h3>
                    <div class="chart-container"><canvas id="volChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>ğŸ• ç¯©é¸ç¯„åœä½”æ¯”</h3>
                    <div class="chart-container"><canvas id="pieChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“‹ æ•¸æ“šæ˜ç´°</h3>
                <table id="data-table">
                    <thead><tr><th>æ—¥æœŸ</th><th>ç‰©æµ</th><th>ä»¶æ•¸</th><th>ç•¶æ—¥ä½”æ¯”</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbywzx0zJx8hS41vX9BAsX-vGvImKFh6HZUyS6XqiyiMbhX3i4l_idcZVunMLAbc-IW8WQ/exec';
    let allRawData = [];
    let volChart, pieChart;

    async function loadData(refresh = false) {
        const url = refresh ? `${API_URL}?t=${Date.now()}` : API_URL;
        const res = await fetch(url);
        allRawData = await res.json();
        const dates = [...new Set(allRawData.map(d => formatDate(d.Month || d.Date)))].sort().reverse();
        document.getElementById('date-list').innerHTML = dates.map(d => `<label style="display:block; margin-bottom:8px; cursor:pointer;"><input type="checkbox" class="date-check" value="${d}" checked> ${d}</label>`).join('');
        render();
    }

    function formatDate(s) {
        const d = new Date(s);
        return isNaN(d.getTime()) ? s : `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function toggleAll(selector) {
        const el = document.querySelectorAll(selector);
        const all = Array.from(el).every(c => c.checked);
        el.forEach(c => c.checked = !all);
    }

    function render() {
        const provs = Array.from(document.querySelectorAll('.prov-check:checked')).map(c => c.value);
        const dates = Array.from(document.querySelectorAll('.date-check:checked')).map(c => c.value);
        
        // 1. ç¯©é¸ç›®å‰é¸ä¸­çš„è³‡æ–™
        const filtered = allRawData.filter(d => provs.includes(d.Provider.toLowerCase().trim()) && dates.includes(formatDate(d.Month || d.Date)));

        // 2. è¨ˆç®— KPI èˆ‡åœ–è¡¨åŸºç¤æ•¸æ“š
        let totalVol = 0;
        const providerSum = { ibox: 0, hilife: 0, fami: 0 };
        const monthlySum = {};

        filtered.forEach(d => {
            const p = d.Provider.toLowerCase().trim();
            const vol = parseInt(d.Volume) || 0;
            const dKey = formatDate(d.Month || d.Date);
            providerSum[p] += vol;
            monthlySum[dKey] = (monthlySum[dKey] || 0) + vol;
            totalVol += vol;
        });

        document.getElementById('kpi-total').innerText = totalVol.toLocaleString();

        // 3. è¨ˆç®—å‹•æ…‹æ¯”è¼ƒ (ä»¥é¸ä¸­ç¯„åœæœ€å¾Œä¸€å€‹æœˆç‚ºæº–)
        const sortedSelectedMonths = Object.keys(monthlySum).sort();
        const latestM = sortedSelectedMonths[sortedSelectedMonths.length-1];
        
        if (latestM) {
            // èˆ‡ä¸Šæœˆæ¯”è¼ƒ
            const dObj = new Date(latestM);
            const prevM = `${dObj.getFullYear()}-${String(dObj.getMonth()).padStart(2,'0')}-01`; // ç°¡åŒ–é‚è¼¯æ‰¾å‰æœˆ
            // å¾ã€Œå…¨éƒ¨åŸå§‹è³‡æ–™ã€ä¸­æ‰¾ï¼Œç¢ºä¿å³ä½¿æ²’é¸ä¸­å‰æœˆä¹Ÿèƒ½å°æ¯”
            const prevVol = allRawData.filter(x => formatDate(x.Month || x.Date).startsWith(latestM.substring(0,7)) === false && provs.includes(x.Provider.toLowerCase().trim())).reduce((a,b)=>a+(parseInt(b.Volume)||0), 0);
            
            // é€™è£¡æ¡ç”¨æ›´ç²¾ç¢ºçš„ã€Œå‰ä¸€å€‹æœˆã€é‚è¼¯
            const currentMonthVol = monthlySum[latestM];
            
            // æ‰¾å‡º allRawData ä¸­çœŸæ­£çš„å‰ä¸€å€‹æœˆ
            const allMonths = [...new Set(allRawData.map(d => formatDate(d.Month || d.Date)))].sort();
            const idx = allMonths.indexOf(latestM);
            const realPrevMonthKey = idx > 0 ? allMonths[idx-1] : null;
            const realPrevVol = realPrevMonthKey ? allRawData.filter(x => formatDate(x.Month || x.Date) === realPrevMonthKey && provs.includes(x.Provider.toLowerCase().trim())).reduce((a,b)=>a+(parseInt(b.Volume)||0), 0) : 0;
            
            updateKPI('kpi-mom', currentMonthVol, realPrevVol, 'kpi-mom-sub', 'ä»¶');

            // å»å¹´åŒæœŸ
            const yoyYear = dObj.getFullYear() - 1;
            const yoyMonth = String(dObj.getMonth() + 1).padStart(2,'0');
            const yoyDay = String(dObj.getDate()).padStart(2,'0');
            const yoyKey = `${yoyYear}-${yoyMonth}-${yoyDay}`;
            const yoyVol = allRawData.filter(x => formatDate(x.Month || x.Date) === yoyKey && provs.includes(x.Provider.toLowerCase().trim())).reduce((a,b)=>a+(parseInt(b.Volume)||0), 0);
            
            updateKPI('kpi-yoy', currentMonthVol, yoyVol, 'kpi-yoy-sub', 'ä»¶');
        }

        // 4. æ›´æ–°æ˜ç´°è¡¨
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = filtered.sort((a,b) => formatDate(b.Month || b.Date).localeCompare(formatDate(a.Month || a.Date))).map(d => {
            const vol = parseInt(d.Volume) || 0;
            const dKey = formatDate(d.Month || d.Date);
            const share = monthlySum[dKey] > 0 ? ((vol / monthlySum[dKey]) * 100).toFixed(1) : 0;
            return `<tr><td>${dKey}</td><td style="color:var(--${d.Provider.toLowerCase().trim()}); font-weight:bold;">${d.Provider.toUpperCase()}</td><td>${vol.toLocaleString()} ä»¶</td><td>${share}%</td></tr>`;
        }).join('');

        updateCharts(Object.keys(monthlySum).sort(), provs, filtered, providerSum);
    }

    function updateKPI(id, cur, pre, subId, unit) {
        const el = document.getElementById(id);
        const sub = document.getElementById(subId);
        if (!pre || pre === 0) {
            el.innerText = "-"; el.className = "kpi-value";
            sub.innerText = "ç¼ºä¹å‰æœŸå°æ¯”æ•¸æ“š";
            return;
        }
        const diff = cur - pre;
        const pct = ((diff / pre) * 100).toFixed(1);
        el.innerText = `${diff >= 0 ? '+' : ''}${pct}%`;
        el.className = `kpi-value ${diff >= 0 ? 'up' : 'down'}`;
        sub.innerText = `${diff >= 0 ? 'å¢åŠ ' : 'æ¸›å°‘'} ${Math.abs(diff).toLocaleString()} ${unit}`;
    }

    function updateCharts(labels, provs, data, pSum) {
        const colors = { ibox: '#90ee90', hilife: '#e74c3c', fami: '#add8e6' };
        
        // é•·æ¢åœ–
        const ctxVol = document.getElementById('volChart').getContext('2d');
        if (volChart) volChart.destroy();
        volChart = new Chart(ctxVol, {
            type: 'bar',
            data: { labels, datasets: provs.map(p => ({ label: p.toUpperCase(), backgroundColor: colors[p], data: labels.map(m => {
                const found = data.find(x => formatDate(x.Month || x.Date) === m && x.Provider.toLowerCase().trim() === p);
                return found ? found.Volume : 0;
            })}))},
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });

        // åœ“é¤…åœ– (åªè¨ˆç®—ç›®å‰ç¯©é¸å‡ºçš„ç¸½å’Œ)
        const ctxPie = document.getElementById('pieChart').getContext('2d');
        if (pieChart) pieChart.destroy();
        const totalSelected = provs.reduce((acc, p) => acc + pSum[p], 0);
        
        pieChart = new Chart(ctxPie, {
            type: 'pie',
            data: { 
                labels: provs.map(p => p.toUpperCase()), 
                datasets: [{ backgroundColor: provs.map(p => colors[p]), data: provs.map(p => pSum[p]) }]
            },
            options: { 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const val = ctx.raw;
                                const pct = totalSelected > 0 ? ((val / totalSelected) * 100).toFixed(1) : 0;
                                return ` ${ctx.label}: ${val.toLocaleString()} ä»¶ (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    loadData();
</script>
</body>
</html>
