<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² | ç‰©æµä»¶æ•¸èˆ‡æç›Šåˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ibox: #90ee90; --hilife: #e74c3c; --fami: #add8e6; --bg: #f4f7f9; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #2c3e50; }
        .container { max-width: 1200px; margin: auto; }
        
        /* å´é‚Šç¯©é¸å€ */
        .layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        .sidebar { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); height: fit-content; position: sticky; top: 20px; }
        .filter-group { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
        .select-all { font-size: 12px; color: #3498db; cursor: pointer; font-weight: normal; }

        /* KPI å¡ç‰‡ */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .kpi-value { font-size: 1.6rem; font-weight: bold; margin: 5px 0; }
        .kpi-diff { font-size: 0.85rem; color: #7f8c8d; }
        .up { color: #27ae60; } .down { color: #e74c3c; }

        /* åœ–è¡¨èˆ‡è¡¨æ ¼ */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }

        .btn-main { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .btn-refresh { width: 100%; padding: 8px; background: #f8f9fa; border: 1px solid #ddd; margin-bottom: 10px; cursor: pointer; border-radius: 6px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="layout">
        <aside class="sidebar">
            <button class="btn-refresh" onclick="loadData(true)">ğŸ”„ å¼·åˆ¶åŒæ­¥é›²ç«¯æ•¸æ“š</button>
            
            <div class="filter-group">
                <div class="filter-header">1. ç‰©æµå•† <span class="select-all" onclick="toggleAll('.prov-check')">å…¨é¸/å–æ¶ˆ</span></div>
                <label><input type="checkbox" class="prov-check" value="ibox" checked> iéƒµç®± (æ·ºç¶ )</label><br>
                <label><input type="checkbox" class="prov-check" value="hilife" checked> èŠçˆ¾å¯Œ (ç´…è‰²)</label><br>
                <label><input type="checkbox" class="prov-check" value="fami" checked> å…¨å®¶ (æ·ºè—)</label>
            </div>

            <div class="filter-group">
                <div class="filter-header">2. é¸æ“‡æ—¥æœŸ <span class="select-all" onclick="toggleAll('.date-check')">å…¨é¸/å–æ¶ˆ</span></div>
                <div id="date-list" style="max-height: 250px; overflow-y: auto;"></div>
            </div>

            <button class="btn-main" onclick="render()">ğŸš€ åŸ·è¡Œæ·±åº¦åˆ†æ</button>
        </aside>

        <main>
            <div class="kpi-row">
                <div class="kpi-card">
                    <div style="font-size: 0.9rem; color: #666;">ç¸½å¯„ä»¶é‡</div>
                    <div id="kpi-total-vol" class="kpi-value">0</div>
                    <div class="kpi-diff">å–®ä½ï¼šä»¶</div>
                </div>
                <div class="kpi-card">
                    <div style="font-size: 0.9rem; color: #666;">é è¨ˆç¸½åˆ©æ½¤</div>
                    <div id="kpi-profit" class="kpi-value">$0</div>
                    <div id="profit-diff" class="kpi-diff">å·²æ‰£é‡‘æµ/ç¨…</div>
                </div>
                <div class="kpi-card">
                    <div style="font-size: 0.9rem; color: #666;">èˆ‡ä¸Šæœˆæ¯”è¼ƒ</div>
                    <div id="kpi-mom-pct" class="kpi-value">-</div>
                    <div id="kpi-mom-num" class="kpi-diff">--</div>
                </div>
                <div class="kpi-card">
                    <div style="font-size: 0.9rem; color: #666;">èˆ‡å»å¹´åŒæœŸ</div>
                    <div id="kpi-yoy-pct" class="kpi-value">-</div>
                    <div id="kpi-yoy-num" class="kpi-diff">--</div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“ˆ ç‰©æµä»¶æ•¸èˆ‡åˆ©æ½¤è¶¨å‹¢ (é›™ç¶­åº¦)</h3>
                <canvas id="mixedChart" height="110"></canvas>
            </div>

            <div class="card">
                <h3>ğŸ“‹ ç‡Ÿé‹èˆ‡åŒ…è£¹æ•¸æ“šæ˜ç´°</h3>
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>ç‰©æµå•†</th>
                            <th>åŒ…è£¹ä»¶æ•¸</th>
                            <th>å–®ä»¶åˆ©æ½¤</th>
                            <th>é è¨ˆæ·¨åˆ©</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbywzx0zJx8hS41vX9BAsX-vGvImKFh6HZUyS6XqiyiMbhX3i4l_idcZVunMLAbc-IW8WQ/exec';
    let allRawData = [];
    let mixedChart;

    async function loadData(refresh = false) {
        const url = refresh ? `${API_URL}?t=${Date.now()}` : API_URL;
        const res = await fetch(url);
        allRawData = await res.json();
        
        const dates = [...new Set(allRawData.map(d => formatDate(d.Month || d.Date)))].sort().reverse();
        document.getElementById('date-list').innerHTML = dates.map(d => 
            `<label style="display:block; margin-bottom:8px; cursor:pointer;"><input type="checkbox" class="date-check" value="${d}" checked> ${d}</label>`
        ).join('');
        
        render();
        if(refresh) alert("æ•¸æ“šå·²æ›´æ–°è‡³æœ€æ–°ç‹€æ…‹ï¼");
    }

    function formatDate(s) {
        const d = new Date(s);
        return isNaN(d.getTime()) ? s : `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    // ä¾æ“šè¦å‰‡è¨ˆç®—åˆ©æ½¤
    function calcProfitInfo(provider, volume, revenue = 60) {
        const payFeePct = 0.022; 
        const taxRate = 0.05;   
        let rebate = 0;
        let hasPayFee = true;

        switch(provider.toLowerCase().trim()) {
            case 'fami':
                rebate = 1; hasPayFee = false;
                break;
            case 'hilife':
                rebate = 12; hasPayFee = true;
                break;
            case 'ibox':
                hasPayFee = true;
                if (volume >= 2000) rebate = 7;
                else if (volume >= 1000) rebate = 5;
                else rebate = 2;
                break;
            default: return { unit: 0, total: 0 };
        }

        const transFee = hasPayFee ? (revenue * payFeePct) : 0;
        const tax = (rebate * taxRate);
        const unitProfit = rebate - (transFee + tax);
        return { unit: unitProfit, total: unitProfit * volume };
    }

    function toggleAll(selector) {
        const el = document.querySelectorAll(selector);
        const all = Array.from(el).every(c => c.checked);
        el.forEach(c => c.checked = !all);
    }

    function render() {
        const provs = Array.from(document.querySelectorAll('.prov-check:checked')).map(c => c.value);
        const dates = Array.from(document.querySelectorAll('.date-check:checked')).map(c => c.value);
        const filtered = allRawData.filter(d => provs.includes(d.Provider.toLowerCase()) && dates.includes(formatDate(d.Month || d.Date)));

        let grandVol = 0, grandProfit = 0;
        const monthlySummary = {};
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = '';

        filtered.sort((a,b) => formatDate(b.Month).localeCompare(formatDate(a.Month))).forEach(d => {
            const info = calcProfitInfo(d.Provider, d.Volume, d.Revenue || 60);
            const dKey = formatDate(d.Month || d.Date);
            
            if(!monthlySummary[dKey]) monthlySummary[dKey] = { vol: 0, profit: 0 };
            monthlySummary[dKey].vol += d.Volume;
            monthlySummary[dKey].profit += info.total;
            
            grandVol += d.Volume;
            grandProfit += info.total;

            tbody.innerHTML += `<tr>
                <td>${dKey}</td>
                <td style="color:var(--${d.Provider.toLowerCase()}); font-weight:bold;">${d.Provider.toUpperCase()}</td>
                <td>${d.Volume.toLocaleString()}</td>
                <td>$${info.unit.toFixed(1)}</td>
                <td class="${info.total >=0 ? 'up':'down'}">$${Math.round(info.total).toLocaleString()}</td>
            </tr>`;
        });

        // KPI
        document.getElementById('kpi-total-vol').innerText = grandVol.toLocaleString();
        document.getElementById('kpi-profit').innerText = `$${Math.round(grandProfit).toLocaleString()}`;
        
        const sortedMonths = Object.keys(monthlySummary).sort();
        const latest = monthlySummary[sortedMonths[sortedMonths.length-1]] || {vol:0, profit:0};
        const prev = monthlySummary[sortedMonths[sortedMonths.length-2]] || {vol:0, profit:0};
        
        updateKPI('mom', latest.profit, prev.profit);

        updateChart(sortedMonths, provs, filtered);
    }

    function updateKPI(id, cur, pre) {
        const pctEl = document.getElementById(`kpi-${id}-pct`);
        const numEl = document.getElementById(`kpi-${id}-num`);
        if(!pre || pre === 0) { pctEl.innerText = "-"; numEl.innerText = "ç¼ºä¹å‰æœŸæ•¸æ“š"; return; }
        const diff = cur - pre;
        const pct = ((diff / pre) * 100).toFixed(1);
        pctEl.innerText = `${diff >= 0 ? '+' : ''}${pct}%`;
        pctEl.className = `kpi-value ${diff >= 0 ? 'up' : 'down'}`;
        numEl.innerText = `${diff >= 0 ? 'å¢åŠ ' : 'æ¸›å°‘'} $${Math.abs(Math.round(diff)).toLocaleString()}`;
    }

    function updateChart(labels, provs, data) {
        const ctx = document.getElementById('mixedChart').getContext('2d');
        if (mixedChart) mixedChart.destroy();
        const colors = { ibox: '#90ee90', hilife: '#e74c3c', fami: '#add8e6' };
        
        // ç”Ÿæˆä»¶æ•¸èˆ‡åˆ©æ½¤çš„æ··åˆæ•¸æ“š
        mixedChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: provs.map(p => ({
                    label: p.toUpperCase() + ' åˆ©æ½¤',
                    backgroundColor: colors[p],
                    data: labels.map(m => {
                        const d = data.find(x => formatDate(x.Month || x.Date) === m && x.Provider.toLowerCase() === p);
                        return d ? Math.round(calcProfitInfo(p, d.Volume, d.Revenue || 60).total) : 0;
                    })
                }))
            },
            options: { 
                plugins: { legend: { position: 'bottom' }, tooltip: { mode: 'index' } },
                scales: { y: { title: { display: true, text: 'æ·¨åˆ© ($)' } } }
            }
        });
    }

    loadData();
</script>
</body>
</html>
