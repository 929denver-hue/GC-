<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² | ç‰©æµç›£æ§çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --ibox: #90ee90;   /* æ·ºç¶ è‰² */
            --hilife: #e74c3c; /* ç´…è‰² */
            --fami: #add8e6;   /* æ·ºè—è‰² */
            --bg: #f8f9fa; 
        }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 25px; border: none; background: #eee; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .tab-btn.active { background: #34495e; color: white; }

        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .kpi-value { font-size: 1.8rem; font-weight: bold; color: #2c3e50; margin: 5px 0; }
        .kpi-sub { font-size: 0.85rem; }
        
        .up { color: #27ae60; font-weight: bold; }
        .down { color: #e74c3c; font-weight: bold; }

        .chart-main { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .data-list { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>ğŸ“¦ ç‰©æµæ•¸æ“šç›£æ§ (å«å¢é•·å°æ¯”)</h1>
        <button onclick="loadData()" style="padding: 8px 15px; cursor: pointer;">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('all', this)">ç¸½è¦½</button>
        <button class="tab-btn" onclick="switchTab('ibox', this)">iéƒµç®±</button>
        <button class="tab-btn" onclick="switchTab('hilife', this)">èŠçˆ¾å¯Œ</button>
        <button class="tab-btn" onclick="switchTab('fami', this)">å…¨å®¶</button>
    </div>

    <div class="kpi-row">
        <div class="kpi-card">
            <div>ç•¶å‰ç¯©é¸ç¸½é‡</div>
            <div id="kpi-vol" class="kpi-value">0</div>
        </div>
        <div class="kpi-card">
            <div>èˆ‡ä¸Šå€‹æœˆå°æ¯” (MoM)</div>
            <div id="kpi-mom" class="kpi-value">-</div>
            <div id="mom-detail" class="kpi-sub">--</div>
        </div>
        <div class="kpi-card">
            <div>å»å¹´åŒæœŸå°æ¯” (YoY)</div>
            <div id="kpi-yoy" class="kpi-value">-</div>
            <div id="yoy-detail" class="kpi-sub">--</div>
        </div>
    </div>

    <div class="chart-main">
        <canvas id="volChart" height="100"></canvas>
    </div>

    <div class="data-list">
        <h3>ğŸ“‹ æœˆåº¦æ•¸æ“šæ˜ç´°</h3>
        <table id="data-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ (å¹´æœˆ)</th>
                    <th>ç‰©æµå•†</th>
                    <th>å¯„ä»¶é‡</th>
                    <th>è¼ƒä¸Šæœˆ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbywzx0zJx8hS41vX9BAsX-vGvImKFh6HZUyS6XqiyiMbhX3i4l_idcZVunMLAbc-IW8WQ/exec';
    let allRawData = [];
    let currentTab = 'all';
    let volChart;

    async function loadData() {
        const res = await fetch(API_URL);
        const data = await res.json();
        allRawData = data.map(d => ({
            Date: formatDate(d.Month || d.Date),
            Provider: (d.Provider || "").toLowerCase().trim(),
            Volume: parseInt(d.Volume) || 0
        })).filter(d => d.Date !== "Invalid Date");
        render();
    }

    function formatDate(dateStr) {
        if (!dateStr) return "Invalid Date";
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function switchTab(tab, btn) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
    }

    function render() {
        const filteredData = currentTab === 'all' ? allRawData : allRawData.filter(d => d.Provider === currentTab);
        
        // åˆ†æœˆåŠ ç¸½
        const monthlySum = {};
        filteredData.forEach(d => {
            monthlySum[d.Date] = (monthlySum[d.Date] || 0) + d.Volume;
        });

        const sortedMonths = Object.keys(monthlySum).sort();
        const latestMonth = sortedMonths[sortedMonths.length - 1];
        const lastMonth = sortedMonths[sortedMonths.length - 2];
        
        // å°‹æ‰¾å»å¹´åŒæœŸ
        const latestDate = new Date(latestMonth);
        const yoyMonth = `${latestDate.getFullYear()-1}-${String(latestDate.getMonth()+1).padStart(2, '0')}`;

        // è¨ˆç®— KPI
        updateKPI('mom', monthlySum[latestMonth], monthlySum[lastMonth], 'mom-detail');
        updateKPI('yoy', monthlySum[latestMonth], monthlySum[yoyMonth], 'yoy-detail');
        document.getElementById('kpi-vol').innerText = (monthlySum[latestMonth] || 0).toLocaleString();

        // æ›´æ–°è¡¨æ ¼
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = '';
        sortedMonths.reverse().forEach(m => {
            const currentVol = monthlySum[m];
            const prevMonth = `${new Date(m).getFullYear()}-${String(new Date(m).getMonth()).padStart(2, '0')}`; // ç°¡åŒ–é‚è¼¯
            tbody.innerHTML += `<tr>
                <td>${m}</td>
                <td>${currentTab.toUpperCase()}</td>
                <td><b>${currentVol.toLocaleString()}</b> ä»¶</td>
                <td>-</td>
            </tr>`;
        });

        updateChart(sortedMonths.reverse(), monthlySum);
    }

    function updateKPI(id, current, prev, detailId) {
        const el = document.getElementById('kpi-' + id);
        const detail = document.getElementById(detailId);
        if (!current || !prev) {
            el.innerText = "N/A";
            detail.innerText = "è³‡æ–™ä¸è¶³";
            return;
        }
        const diff = ((current - prev) / prev * 100).toFixed(1);
        el.innerText = (diff > 0 ? "+" : "") + diff + "%";
        el.className = "kpi-value " + (diff >= 0 ? "up" : "down");
        detail.innerText = `å°æ¯”å‰æœŸ: ${prev.toLocaleString()}`;
    }

    function updateChart(labels, monthlySum) {
        const ctx = document.getElementById('volChart').getContext('2d');
        if (volChart) volChart.destroy();

        const colors = { ibox: '#90ee90', hilife: '#e74c3c', fami: '#add8e6' };
        let datasets = [];

        if (currentTab === 'all') {
            datasets = ['ibox', 'hilife', 'fami'].map(p => ({
                label: p.toUpperCase(),
                backgroundColor: colors[p],
                data: labels.map(m => {
                    return allRawData.filter(d => d.Date === m && d.Provider === p).reduce((s,v)=>s+v.Volume, 0);
                })
            }));
        } else {
            datasets = [{
                label: currentTab.toUpperCase(),
                backgroundColor: colors[currentTab],
                data: labels.map(m => monthlySum[m])
            }];
        }

        volChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    loadData();
</script>
</body>
</html>
