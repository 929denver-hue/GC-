<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² | ç‰©æµå¯„ä»¶é‡ç›£æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ibox: #3498db; --hilife: #e67e22; --fami: #2ecc71; --bg: #f8f9fa; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #2c3e50; }
        .container { max-width: 1000px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .kpi-label { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px; }
        .kpi-value { font-size: 2rem; font-weight: bold; }
        .chart-main { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .data-list { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; border-radius: 4px; }
        .refresh-btn { background: #34495e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“¦ ç‰©æµå¯„ä»¶é‡ç›£æ§çœ‹æ¿</h1>
        <button class="refresh-btn" onclick="loadData()">ğŸ”„ åˆ·æ–°æœ€æ–°ä»¶æ•¸</button>
    </div>

    <div class="kpi-row">
        <div class="kpi-card"><div class="kpi-label">ç´¯è¨ˆç¸½å¯„ä»¶é‡</div><div id="total-vol" class="kpi-value">0</div></div>
        <div class="kpi-card"><div class="kpi-label">æœ¬æœˆå¯„ä»¶é‡</div><div id="current-month-vol" class="kpi-value">0</div></div>
        <div class="kpi-card"><div class="kpi-label">ä¸»åŠ›ç‰©æµ</div><div id="top-provider" class="kpi-value">-</div></div>
    </div>

    <div class="chart-main">
        <h3>ğŸ“ˆ ç‰©æµå¯„ä»¶é‡è¶¨å‹¢ (Monthly Volume Trend)</h3>
        <canvas id="volChart" height="100"></canvas>
    </div>

    <div class="data-list">
        <h3>ğŸ“‹ æœˆåº¦æ•¸æ“šæ˜ç´°</h3>
        <table>
            <thead>
                <tr>
                    <th>æœˆä»½</th>
                    <th>ç‰©æµå•†</th>
                    <th>å¯„ä»¶é‡ (ä»¶æ•¸)</th>
                    <th>è¼ƒä¸Šæœˆå¢é•·</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbywzx0zJx8hS41vX9BAsX-vGvImKFh6HZUyS6XqiyiMbhX3i4l_idcZVunMLAbc-IW8WQ/exec';
    let volChart;

    async function loadData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            
            // æ•¸æ“šæ¨™æº–åŒ–ï¼šç¢ºä¿ Volume æ˜¯æ•¸å­—
            const cleanData = data.map(d => ({
                Month: d.Month || d.month || 'N/A',
                Provider: (d.Provider || d.provider || '').toLowerCase().trim(),
                Volume: parseInt(String(d.Volume).replace(/[^\d]/g, '')) || 0
            })).filter(d => d.Volume > 0);

            render(cleanData);
        } catch (e) {
            console.error(e);
            alert("è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª Google Sheet ä¸­å·²æœ‰ä»¶æ•¸æ•¸æ“šã€‚");
        }
    }

    function render(data) {
        const months = [...new Set(data.map(d => d.Month))].sort();
        const providers = {
            ibox: { name: 'iBOX', color: '#3498db', data: [] },
            hilife: { name: 'èŠçˆ¾å¯Œ', color: '#e67e22', data: [] },
            fami: { name: 'å…¨å®¶', color: '#27ae60', data: [] }
        };

        let totalVol = 0;
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        // è¨ˆç®—è¶¨å‹¢åœ–è³‡æ–™
        months.forEach(m => {
            Object.keys(providers).forEach(p => {
                const entry = data.find(d => d.Month === m && d.Provider === p);
                const vol = entry ? entry.Volume : 0;
                providers[p].data.push(vol);
                totalVol += vol;
            });
        });

        // æ¸²æŸ“è¡¨æ ¼
        data.sort((a,b) => b.Month.localeCompare(a.Month)).forEach(d => {
            tbody.innerHTML += `<tr>
                <td>${d.Month}</td>
                <td style="color:${providers[d.Provider]?.color || '#333'}">${d.Provider.toUpperCase()}</td>
                <td><b>${d.Volume.toLocaleString()}</b> ä»¶</td>
                <td>-</td>
            </tr>`;
        });

        // æ›´æ–° KPI
        document.getElementById('total-vol').innerText = totalVol.toLocaleString();
        document.getElementById('top-provider').innerText = Object.keys(providers).reduce((a, b) => 
            providers[a].data.reduce((s,v)=>s+v,0) > providers[b].data.reduce((s,v)=>s+v,0) ? a : b
        ).toUpperCase();

        updateChart(months, providers);
    }

    function updateChart(months, providers) {
        const ctx = document.getElementById('volChart').getContext('2d');
        if (volChart) volChart.destroy();
        volChart = new Chart(ctx, {
            type: 'bar', // æ”¹ç”¨é•·æ¢åœ–çœ‹æ¯æœˆä»¶æ•¸å°æ¯”æ›´æ¸…æ™°
            data: {
                labels: months,
                datasets: Object.keys(providers).map(p => ({
                    label: providers[p].name,
                    data: providers[p].data,
                    backgroundColor: providers[p].color
                }))
            },
            options: { 
                responsive: true,
                scales: { y: { beginAtZero: true, title: { display: true, text: 'ä»¶æ•¸' } } }
            }
        });
    }

    loadData();
</script>
</body>
</html>
