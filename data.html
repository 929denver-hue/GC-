<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² | ç‰©æµæ•¸æ“šæ±ºç­–çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ibox: #90ee90; --hilife: #e74c3c; --fami: #add8e6; --bg: #f0f2f5; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #2c3e50; }
        .container { max-width: 1200px; margin: auto; }
        
        /* ä½ˆå±€ */
        .dashboard-layout { display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
        
        /* å´é‚Šç¯©é¸å€ */
        .filter-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: sticky; top: 20px; }
        .filter-group { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .filter-group h4 { margin: 0 0 10px 0; font-size: 1rem; color: #34495e; border-left: 4px solid #34495e; padding-left: 10px; }
        .filter-option { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; font-size: 0.95rem; }
        .filter-option input { margin-right: 10px; width: 16px; height: 16px; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { width: 100%; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; }
        .btn-primary { background: #3498db; color: white; font-size: 1rem; border: 2px solid #2980b9; }
        .btn-primary:hover { background: #2980b9; }
        .btn-refresh { background: #f8f9fa; color: #7f8c8d; border: 1px solid #ddd; font-size: 0.85rem; }
        .btn-refresh:hover { background: #eee; }

        /* ä¸»é¡¯ç¤ºå€ */
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .kpi-value { font-size: 1.8rem; font-weight: bold; margin: 5px 0; }
        .kpi-diff { font-size: 0.9rem; color: #7f8c8d; }
        .up { color: #27ae60; } .down { color: #e74c3c; }

        .chart-main { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .data-table-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>ğŸ“Š ç‰©æµç‡Ÿé‹æ±ºç­–çœ‹æ¿</h1>
    </div>

    <div class="dashboard-layout">
        <aside class="filter-card">
            <button class="btn btn-refresh" onclick="loadData(true)">ğŸ”„ åŒæ­¥é›²ç«¯æœ€æ–°æ•¸æ“š</button>
            
            <div class="filter-group">
                <h4>1. é¸æ“‡ç‰©æµå•†</h4>
                <label class="filter-option"><input type="checkbox" class="prov-check" value="ibox" checked> iéƒµç®± (æ·ºç¶ )</label>
                <label class="filter-option"><input type="checkbox" class="prov-check" value="hilife" checked> èŠçˆ¾å¯Œ (ç´…è‰²)</label>
                <label class="filter-option"><input type="checkbox" class="prov-check" value="fami" checked> å…¨å®¶ (æ·ºè—)</label>
            </div>
            
            <div class="filter-group">
                <h4>2. é¸æ“‡æ™‚é–“å€é–“</h4>
                <div id="date-filters" style="max-height: 300px; overflow-y: auto;">
                    </div>
            </div>

            <button class="btn btn-primary" onclick="render()">ğŸš€ åŸ·è¡Œç¯©é¸æ¯”è¼ƒ</button>
            <p style="font-size: 0.8rem; color: #999; text-align: center;">å‹¾é¸å¾Œè«‹æŒ‰åŸ·è¡ŒæŒ‰éˆ•æ›´æ–°åœ–è¡¨</p>
        </aside>

        <main class="main-content">
            <div class="kpi-row">
                <div class="kpi-card">
                    <div>ç¯©é¸ç¸½å¯„ä»¶é‡</div>
                    <div id="kpi-vol" class="kpi-value">0</div>
                    <div class="kpi-diff">ç¯„åœå…§ç´¯è¨ˆä»¶æ•¸</div>
                </div>
                <div class="kpi-card">
                    <div>èˆ‡ä¸Šå€‹æœˆæ¯”è¼ƒ</div>
                    <div id="kpi-mom-pct" class="kpi-value">-</div>
                    <div id="kpi-mom-num" class="kpi-diff">--</div>
                </div>
                <div class="kpi-card">
                    <div>èˆ‡åŒæœŸæ¯”è¼ƒ</div>
                    <div id="kpi-yoy-pct" class="kpi-value">-</div>
                    <div id="kpi-yoy-num" class="kpi-diff">--</div>
                </div>
            </div>

            <div class="chart-main">
                <canvas id="volChart" height="120"></canvas>
            </div>

            <div class="data-table-card">
                <table id="data-table">
                    <thead>
                        <tr><th>æ—¥æœŸ</th><th>ç‰©æµ</th><th>å¯„ä»¶é‡ (ä»¶)</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbywzx0zJx8hS41vX9BAsX-vGvImKFh6HZUyS6XqiyiMbhX3i4l_idcZVunMLAbc-IW8WQ/exec';
    let allRawData = [];
    let volChart;

    async function loadData(isRefresh = false) {
        const url = isRefresh ? `${API_URL}?cache=none&t=${new Date().getTime()}` : API_URL;
        try {
            const res = await fetch(url);
            const data = await res.json();
            allRawData = data.map(d => ({
                Date: formatDate(d.Month || d.Date),
                Provider: (d.Provider || "").toLowerCase().trim(),
                Volume: parseInt(d.Volume) || 0
            })).filter(d => d.Date !== "Invalid Date");

            initDateFilters();
            render();
            if(isRefresh) alert("å·²æˆåŠŸç²å–é›²ç«¯æœ€æ–°æ•¸æ“šï¼");
        } catch (e) {
            alert("æ•¸æ“šè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª API é€£çµèˆ‡æ¬Šé™è¨­å®šã€‚");
        }
    }

    function formatDate(dateStr) {
        const d = new Date(dateStr);
        return isNaN(d.getTime()) ? dateStr : `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function initDateFilters() {
        const dates = [...new Set(allRawData.map(d => d.Date))].sort().reverse();
        const container = document.getElementById('date-filters');
        container.innerHTML = dates.map(d => `
            <label class="filter-option">
                <input type="checkbox" class="date-check" value="${d}" checked> ${d}
            </label>
        `).join('');
    }

    function render() {
        const selectedProvs = Array.from(document.querySelectorAll('.prov-check:checked')).map(c => c.value);
        const selectedDates = Array.from(document.querySelectorAll('.date-check:checked')).map(c => c.value);

        const filteredData = allRawData.filter(d => 
            selectedProvs.includes(d.Provider) && selectedDates.includes(d.Date)
        );

        // æ•¸æ“šåŠ ç¸½é‚è¼¯
        const monthlySum = {};
        filteredData.forEach(d => monthlySum[d.Date] = (monthlySum[d.Date] || 0) + d.Volume);
        const sortedMonths = Object.keys(monthlySum).sort();
        
        const latestKey = sortedMonths[sortedMonths.length-1];
        const prevKey = sortedMonths[sortedMonths.length-2];
        
        // å°‹æ‰¾å»å¹´åŒæœŸ
        const curDate = new Date(latestKey);
        const yoyKey = `${curDate.getFullYear()-1}-${String(curDate.getMonth()+1).padStart(2, '0')}`;

        // æ›´æ–° KPI
        const totalSum = Object.values(monthlySum).reduce((a,b)=>a+b, 0);
        document.getElementById('kpi-vol').innerText = totalSum.toLocaleString();
        
        updateKPI('mom', monthlySum[latestKey], monthlySum[prevKey]);
        updateKPI('yoy', monthlySum[latestKey], monthlySum[yoyKey]);

        // è¡¨æ ¼
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = filteredData.sort((a,b)=>b.Date.localeCompare(a.Date))
            .map(d => `<tr><td>${d.Date}</td><td>${d.Provider.toUpperCase()}</td><td>${d.Volume.toLocaleString()}</td></tr>`).join('');

        updateChart(sortedMonths, selectedProvs, allRawData);
    }

    function updateKPI(prefix, current, target) {
        const pctEl = document.getElementById(`kpi-${prefix}-pct`);
        const numEl = document.getElementById(`kpi-${prefix}-num`);
        
        if(!current || !target) {
            pctEl.innerText = "N/A";
            numEl.innerText = "ç¼ºä¹å°æ¯”æ•¸æ“š";
            pctEl.className = "kpi-value";
            return;
        }

        const diffNum = current - target;
        const diffPct = ((diffNum / target) * 100).toFixed(1);
        
        pctEl.innerText = (diffPct > 0 ? "+" : "") + diffPct + "%";
        pctEl.className = "kpi-value " + (diffNum >= 0 ? "up" : "down");
        numEl.innerText = `${diffNum >= 0 ? 'å¢åŠ ' : 'æ¸›å°‘'} ${Math.abs(diffNum).toLocaleString()} ä»¶`;
    }

    function updateChart(labels, provs, raw) {
        const ctx = document.getElementById('volChart').getContext('2d');
        if (volChart) volChart.destroy();

        const colors = { ibox: '#90ee90', hilife: '#e74c3c', fami: '#add8e6' };
        const datasets = provs.map(p => ({
            label: p.toUpperCase(),
            backgroundColor: colors[p],
            data: labels.map(m => {
                const found = raw.find(d => d.Date === m && d.Provider === p);
                return found ? found.Volume : 0;
            })
        }));

        volChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: { 
                responsive: true,
                plugins: { legend: { position: 'bottom' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    loadData();
</script>
</body>
</html>
