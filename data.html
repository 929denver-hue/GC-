<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² | ç‰©æµç‡Ÿé‹æ±ºç­–çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ibox: #3498db; --hilife: #e67e22; --fami: #2ecc71; --bg: #f4f7f6; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #2c3e50; }
        .container { max-width: 1200px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-top: 4px solid #34495e; }
        .kpi-label { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 8px; }
        .kpi-value { font-size: 1.8rem; font-weight: bold; }
        .chart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }
        .negative { color: #e74c3c; font-weight: bold; }
        .positive { color: #27ae60; font-weight: bold; }
        .btn { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #34495e; }
        @media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š ç‰©æµç‡Ÿé‹æ•´åˆçœ‹æ¿</h1>
        <button class="btn" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
    </div>

    <div class="kpi-row">
        <div class="kpi-card"><div class="kpi-label">ç´¯è¨ˆç¸½åˆ©æ½¤</div><div id="total-profit" class="kpi-value">$0</div></div>
        <div class="kpi-card"><div class="kpi-label">ç´¯è¨ˆç¸½ä»¶æ•¸</div><div id="total-vol" class="kpi-value">0</div></div>
        <div class="kpi-card"><div class="kpi-label">å¹³å‡å–®ä»¶åˆ©æ½¤</div><div id="avg-cm" class="kpi-value">$0</div></div>
        <div class="kpi-card"><div class="kpi-label">ç‡Ÿé‹ç‹€æ…‹</div><div id="be-status" class="kpi-value">-</div></div>
    </div>

    <div class="chart-grid">
        <div class="card"><h3>ğŸ“ˆ æœˆåº¦åˆ©æ½¤è¶¨å‹¢ (Monthly Profit)</h3><canvas id="trendChart" height="120"></canvas></div>
        <div class="card"><h3>ğŸ• ç‰©æµé‡ä½”æ¯” (Volume %)</h3><canvas id="pieChart"></canvas></div>
    </div>

    <div class="card">
        <h3>ğŸ“‹ ç‰©æµç¸¾æ•ˆæ˜ç´°è¡¨</h3>
        <table id="detail-table">
            <thead>
                <tr>
                    <th>æœˆä»½</th>
                    <th>ç‰©æµå•†</th>
                    <th>ä»¶æ•¸</th>
                    <th>å–®ä»¶ç´”åˆ© (CM)</th>
                    <th>æœˆåº¦æ¯›åˆ©</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbywzx0zJx8hS41vX9BAsX-vGvImKFh6HZUyS6XqiyiMbhX3i4l_idcZVunMLAbc-IW8WQ/exec';
    let charts = {};

    async function loadData() {
        try {
            const res = await fetch(API_URL);
            const rawData = await res.json();
            
            // æ•¸æ“šæ¸…æ´—èˆ‡æ¨™æº–åŒ–
            const cleanData = rawData.map(d => {
                const parseNum = (val) => {
                    if (typeof val === 'number') return val;
                    return parseFloat(String(val).replace(/[^\d.-]/g, '')) || 0;
                };
                return {
                    Month: d.Month || d.month || 'N/A',
                    Provider: (d.Provider || d.provider || 'unknown').toLowerCase().trim(),
                    Volume: parseNum(d.Volume || d.volume),
                    Revenue: parseNum(d.Revenue || d.revenue),
                    Cost: parseNum(d.Cost || d.cost),
                    Rebate: parseNum(d.Rebate || d.rebate),
                    Subsidy: parseNum(d.Subsidy || d.subsidy)
                };
            });

            renderDashboard(cleanData);
        } catch (e) {
            console.error("Fetch Error:", e);
            alert("è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª API URL æ˜¯å¦æ­£ç¢ºéƒ¨ç½²ã€‚");
        }
    }

    function renderDashboard(data) {
        let totalProfit = 0, totalVol = 0;
        const tbody = document.querySelector('#detail-table tbody');
        tbody.innerHTML = '';

        const config = {
            ibox: { name: 'iBOX', color: '#3498db', volumes: {}, profits: {} },
            hilife: { name: 'èŠçˆ¾å¯Œ', color: '#e67e22', volumes: {}, profits: {} },
            fami: { name: 'å…¨å®¶', color: '#27ae60', volumes: {}, profits: {} }
        };

        const months = [...new Set(data.map(d => d.Month))].sort();

        data.forEach(d => {
            const cm = (d.Revenue + d.Rebate) / 1.05 - (d.Revenue * 0.022) - d.Cost - d.Subsidy;
            const subProfit = cm * d.Volume;
            
            if (d.Volume > 0) {
                totalProfit += subProfit;
                totalVol += d.Volume;

                tbody.innerHTML += `
                    <tr>
                        <td>${d.Month}</td>
                        <td style="color:${config[d.Provider]?.color || '#999'}">${d.Provider.toUpperCase()}</td>
                        <td>${d.Volume.toLocaleString()}</td>
                        <td class="${cm < 0 ? 'negative' : 'positive'}">$${cm.toFixed(1)}</td>
                        <td class="${subProfit < 0 ? 'negative' : 'positive'}">$${Math.round(subProfit).toLocaleString()}</td>
                    </tr>`;
                
                if (config[d.Provider]) {
                    config[d.Provider].profits[d.Month] = Math.round(subProfit);
                    config[d.Provider].volumes[d.Month] = d.Volume;
                }
            }
        });

        // æ›´æ–° KPI
        document.getElementById('total-profit').innerText = `$${Math.round(totalProfit).toLocaleString()}`;
        document.getElementById('total-profit').className = `kpi-value ${totalProfit >= 0 ? 'positive' : 'negative'}`;
        document.getElementById('total-vol').innerText = totalVol.toLocaleString();
        document.getElementById('avg-cm').innerText = `$${(totalVol > 0 ? totalProfit/totalVol : 0).toFixed(1)}`;
        document.getElementById('be-status').innerText = totalProfit > 0 ? "âœ… ç›ˆé¤˜" : "âš ï¸ è™§æ";

        updateCharts(months, config);
    }

    function updateCharts(months, config) {
        if (charts.trend) charts.trend.destroy();
        if (charts.pie) charts.pie.destroy();

        // è¶¨å‹¢åœ–
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        charts.trend = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: months,
                datasets: Object.keys(config).map(key => ({
                    label: config[key].name,
                    data: months.map(m => config[key].profits[m] || 0),
                    borderColor: config[key].color,
                    tension: 0.3,
                    fill: false
                }))
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // åœ“é¤…åœ– (ç´¯è¨ˆä»¶æ•¸)
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        const pieData = Object.keys(config).map(key => 
            Object.values(config[key].volumes).reduce((a, b) => a + b, 0)
        );

        charts.pie = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['iBOX', 'èŠçˆ¾å¯Œ', 'å…¨å®¶'],
                datasets: [{ data: pieData, backgroundColor: ['#3498db', '#e67e22', '#2ecc71'] }]
            },
            options: { responsive: true }
        });
    }

    loadData();
</script>
</body>
</html>
