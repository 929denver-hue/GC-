<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² | ç‰©æµç›£æ§çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ibox: #3498db; --hilife: #e67e22; --fami: #27ae60; --bg: #f8f9fa; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        /* é ç±¤æ¨£å¼ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 25px; border: none; background: #eee; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: #34495e; color: white; }
        .tab-btn:hover { background: #ddd; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .kpi-value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        
        .chart-main { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .data-list { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“¦ ç‰©æµå¯„ä»¶é‡ç›£æ§çœ‹æ¿</h1>
        <button onclick="loadData()" style="padding: 10px; cursor:pointer;">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('all', this)">ç¸½è¦½</button>
        <button class="tab-btn" onclick="switchTab('ibox', this)">iBOX</button>
        <button class="tab-btn" onclick="switchTab('hilife', this)">èŠçˆ¾å¯Œ</button>
        <button class="tab-btn" onclick="switchTab('fami', this)">å…¨å®¶</button>
    </div>

    <div class="kpi-row">
        <div class="kpi-card"><div>ç•¶å‰ç¯©é¸ç¸½é‡</div><div id="kpi-vol" class="kpi-value">0</div></div>
        <div class="kpi-card"><div>è³‡æ–™ç­†æ•¸</div><div id="kpi-count" class="kpi-value">0</div></div>
    </div>

    <div class="chart-main">
        <h3 id="chart-title">ğŸ“ˆ å¯„ä»¶è¶¨å‹¢</h3>
        <canvas id="volChart" height="100"></canvas>
    </div>

    <div class="data-list">
        <h3>ğŸ“‹ è³‡æ–™æ˜ç´°</h3>
        <table id="data-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ (å¹´æœˆæ—¥)</th>
                    <th>ç‰©æµå•†</th>
                    <th>å¯„ä»¶é‡</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbywzx0zJx8hS41vX9BAsX-vGvImKFh6HZUyS6XqiyiMbhX3i4l_idcZVunMLAbc-IW8WQ/exec';
    let allRawData = [];
    let currentTab = 'all';
    let volChart;

    async function loadData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            
            // è³‡æ–™æ¸…æ´—ï¼šè™•ç†æ™‚é–“èˆ‡æ•¸å­—
            allRawData = data.map(d => ({
                // æ ¸å¿ƒä¿®å¾©ï¼šå¼·åˆ¶è½‰åŒ–ç‚º YYYY-MM-DD
                Date: formatDate(d.Month || d.Date), 
                Provider: (d.Provider || "").toLowerCase().trim(),
                Volume: parseInt(d.Volume) || 0
            })).filter(d => d.Date !== "Invalid Date");

            render();
        } catch (e) {
            alert("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API URL");
        }
    }

    // æ™‚é–“è™•ç†å‡½å¼ï¼šç¢ºä¿åªé¡¯ç¤ºå¹´æœˆæ—¥
    function formatDate(dateStr) {
        if (!dateStr) return "Invalid Date";
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr; // å¦‚æœæœ¬ä¾†å°±æ˜¯æ–‡å­—å‰‡ç›´æ¥å›å‚³
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function switchTab(tab, btn) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
    }

    function render() {
        // ç¯©é¸è³‡æ–™
        const filteredData = currentTab === 'all' 
            ? allRawData 
            : allRawData.filter(d => d.Provider === currentTab);

        // æ›´æ–° KPI
        const totalVol = filteredData.reduce((sum, d) => sum + d.Volume, 0);
        document.getElementById('kpi-vol').innerText = totalVol.toLocaleString();
        document.getElementById('kpi-count').innerText = filteredData.length;

        // æ›´æ–°è¡¨æ ¼
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = '';
        filteredData.sort((a,b) => b.Date.localeCompare(a.Date)).forEach(d => {
            tbody.innerHTML += `<tr>
                <td>${d.Date}</td>
                <td>${d.Provider.toUpperCase()}</td>
                <td><b>${d.Volume.toLocaleString()}</b> ä»¶</td>
            </tr>`;
        });

        updateChart(filteredData);
    }

    function updateChart(data) {
        const ctx = document.getElementById('volChart').getContext('2d');
        if (volChart) volChart.destroy();

        // ä¾æ—¥æœŸæ’åº
        const sortedData = [...data].sort((a, b) => a.Date.localeCompare(b.Date));
        const labels = [...new Set(sortedData.map(d => d.Date))];

        let datasets = [];
        if (currentTab === 'all') {
            const providers = ['ibox', 'hilife', 'fami'];
            const colors = { ibox: '#3498db', hilife: '#e67e22', fami: '#27ae60' };
            datasets = providers.map(p => ({
                label: p.toUpperCase(),
                data: labels.map(l => {
                    const found = sortedData.find(d => d.Date === l && d.Provider === p);
                    return found ? found.Volume : 0;
                }),
                backgroundColor: colors[p]
            }));
        } else {
            datasets = [{
                label: currentTab.toUpperCase(),
                data: labels.map(l => {
                    const found = sortedData.find(d => d.Date === l);
                    return found ? found.Volume : 0;
                }),
                backgroundColor: '#34495e'
            }];
        }

        volChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    loadData();
</script>
</body>
</html>
