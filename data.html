<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² | ç‰©æµç‡Ÿé‹æ±ºç­–ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ibox: #3498db; --hilife: #e67e22; --fami: #2ecc71; --bg: #f0f2f5; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* KPI å¡ç‰‡ */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .kpi-label { color: #7f8c8d; font-size: 0.85rem; margin-bottom: 8px; }
        .kpi-value { font-size: 1.6rem; font-weight: bold; color: #2c3e50; }
        
        /* åœ–è¡¨å€ */
        .chart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* è¡¨æ ¼å€ */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; font-weight: 500; }
        tr:hover { background: #f9f9f9; }
        
        .negative { color: #e74c3c; font-weight: bold; }
        .positive { color: #27ae60; font-weight: bold; }
        .refresh-btn { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        .refresh-btn:hover { background: #34495e; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š ç‰©æµç‡Ÿé‹æ±ºç­–ä¸­å¿ƒ <small style="font-size: 1rem; color: #666;">(å³æ™‚åŒæ­¥ Google Sheets)</small></h1>
        <button class="refresh-btn" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
    </div>

    <div class="kpi-row">
        <div class="kpi-card"><div class="kpi-label">ç´¯è¨ˆç¸½åˆ©æ½¤</div><div id="total-profit" class="kpi-value">$0</div></div>
        <div class="kpi-card"><div class="kpi-label">ç´¯è¨ˆç¸½ä»¶æ•¸</div><div id="total-vol" class="kpi-value">0</div></div>
        <div class="kpi-card"><div class="kpi-label">å¹³å‡å–®ä»¶åˆ©æ½¤</div><div id="avg-cm" class="kpi-value">$0</div></div>
        <div class="kpi-card"><div class="kpi-label">æç›Šå¹³è¡¡ç‹€æ…‹</div><div id="be-status" class="kpi-value">-</div></div>
    </div>

    <div class="chart-grid">
        <div class="card">
            <h3>ğŸ“ˆ å„é€šè·¯æœˆåˆ©æ½¤è¶¨å‹¢</h3>
            <canvas id="trendChart" height="150"></canvas>
        </div>
        <div class="card">
            <h3>ğŸ• ç‰©æµé‡åˆ†ä½ˆ</h3>
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“‹ ç‰©æµç¸¾æ•ˆæ˜ç´°</h3>
        <table id="detail-table">
            <thead>
                <tr>
                    <th>æœˆä»½</th>
                    <th>ç‰©æµå•†</th>
                    <th>ä»¶æ•¸</th>
                    <th>å–®ä»¶ç´”åˆ© (CM)</th>
                    <th>æœˆæ¯›åˆ© (Gross)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbywzx0zJx8hS41vX9BAsX-vGvImKFh6HZUyS6XqiyiMbhX3i4l_idcZVunMLAbc-IW8WQ/exec';

    async function loadData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            renderDashboard(data);
        } catch (e) { console.error("API Error", e); }
    }

    function renderDashboard(data) {
        let totalProfit = 0, totalVol = 0;
        let months = [...new Set(data.map(d => d.Month))].sort();
        let providers = {
            ibox: { color: '#3498db', profits: [] },
            hilife: { color: '#e67e22', profits: [] },
            fami: { color: '#27ae60', profits: [] }
        };

        const tbody = document.querySelector('#detail-table tbody');
        tbody.innerHTML = '';

        data.forEach(d => {
            const cm = (d.Revenue + d.Rebate) / 1.05 - (d.Revenue * 0.022) - d.Cost - d.Subsidy;
            const subProfit = cm * d.Volume;
            totalProfit += subProfit;
            totalVol += d.Volume;

            tbody.innerHTML += `
                <tr>
                    <td>${d.Month}</td>
                    <td style="color:${providers[d.Provider]?.color}">${d.Provider.toUpperCase()}</td>
                    <td>${d.Volume.toLocaleString()}</td>
                    <td class="${cm < 0 ? 'negative' : 'positive'}">$${cm.toFixed(1)}</td>
                    <td class="${subProfit < 0 ? 'negative' : 'positive'}">$${Math.round(subProfit).toLocaleString()}</td>
                </tr>`;
        });

        // æ•´ç†è¶¨å‹¢åœ–æ•¸æ“š
        months.forEach(m => {
            Object.keys(providers).forEach(p => {
                const entry = data.find(d => d.Month === m && d.Provider === p);
                const cm = entry ? (entry.Revenue + entry.Rebate) / 1.05 - (entry.Revenue * 0.022) - entry.Cost - entry.Subsidy : 0;
                providers[p].profits.push(entry ? Math.round(cm * entry.Volume) : 0);
            });
        });

        // æ›´æ–° KPI
        document.getElementById('total-profit').innerText = `$${Math.round(totalProfit).toLocaleString()}`;
        document.getElementById('total-vol').innerText = totalVol.toLocaleString();
        document.getElementById('avg-cm').innerText = `$${(totalProfit / totalVol).toFixed(1)}`;
        document.getElementById('be-status').innerText = totalProfit > 0 ? "âœ… å·²ç›ˆé¤˜" : "âš ï¸ è™§æä¸­";

        updateCharts(months, providers, data);
    }

    function updateCharts(months, providers, data) {
        // æŠ˜ç·šåœ–
        new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: {
                labels: months,
                datasets: Object.keys(providers).map(p => ({
                    label: p.toUpperCase(),
                    data: providers[p].profits,
                    borderColor: providers[p].color,
                    tension: 0.3,
                    fill: false
                }))
            }
        });

        // åœ“é¤…åœ– (ä»¥æœ€å¾Œä¸€å€‹æœˆçš„ä»¶æ•¸ç‚ºä¾‹)
        const latestMonth = months[months.length - 1];
        const pieData = Object.keys(providers).map(p => {
            const entry = data.find(d => d.Month === latestMonth && d.Provider === p);
            return entry ? entry.Volume : 0;
        });

        new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: {
                labels: ['iBOX', 'èŠçˆ¾å¯Œ', 'å…¨å®¶'],
                datasets: [{ data: pieData, backgroundColor: ['#3498db', '#e67e22', '#2ecc71'] }]
            }
        });
    }

    loadData();
</script>
</body>
</html>
