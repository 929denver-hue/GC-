<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GCè´ˆç‰©ç¶² | ç‰©æµæ•¸æ“šæ±ºç­–çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ibox: #90ee90; --hilife: #e74c3c; --fami: #add8e6; --bg: #f0f2f5; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #2c3e50; }
        .container { max-width: 1200px; margin: auto; }
        
        /* å´é‚Šç¯©é¸å€ */
        .dashboard-layout { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
        .filter-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: fit-content; }
        .filter-group { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .filter-group h4 { margin-bottom: 10px; font-size: 1rem; color: #34495e; }
        .filter-option { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; }
        .filter-option input { margin-right: 10px; }

        /* ä¸»é¡¯ç¤ºå€ */
        .main-content { min-width: 0; }
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .kpi-value { font-size: 1.8rem; font-weight: bold; margin: 5px 0; }
        .up { color: #27ae60; } .down { color: #e74c3c; }

        .chart-main { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .data-table-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }

        .btn-refresh { width: 100%; background: #2c3e50; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-refresh:hover { background: #34495e; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>ğŸ“Š ç‰©æµç‡Ÿé‹å¤šç¶­åº¦çœ‹æ¿</h1>
    </div>

    <div class="dashboard-layout">
        <aside class="filter-card">
            <button class="btn-refresh" onclick="loadData(true)">ğŸ”„ å¼·åˆ¶åˆ·æ–°æ•¸æ“š</button>
            <hr>
            <div class="filter-group">
                <h4>é¸æ“‡ç‰©æµå•†</h4>
                <label class="filter-option"><input type="checkbox" class="prov-check" value="ibox" checked onchange="render()"> iéƒµç®± (ç¶ )</label>
                <label class="filter-option"><input type="checkbox" class="prov-check" value="hilife" checked onchange="render()"> èŠçˆ¾å¯Œ (ç´…)</label>
                <label class="filter-option"><input type="checkbox" class="prov-check" value="fami" checked onchange="render()"> å…¨å®¶ (è—)</label>
            </div>
            <div class="filter-group">
                <h4>é¸æ“‡æ™‚é–“é»</h4>
                <div id="date-filters">
                    </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="kpi-row">
                <div class="kpi-card"><div>ç¯©é¸ç¸½å¯„ä»¶é‡</div><div id="kpi-vol" class="kpi-value">0</div></div>
                <div class="kpi-card"><div>MoM ç’°æ¯”å¢é•·</div><div id="kpi-mom" class="kpi-value">-</div></div>
                <div class="kpi-card"><div>YoY åŒæ¯”å¢é•·</div><div id="kpi-yoy" class="kpi-value">-</div></div>
            </div>

            <div class="chart-main">
                <canvas id="volChart" height="120"></canvas>
            </div>

            <div class="data-table-card">
                <table id="data-table">
                    <thead>
                        <tr><th>æ—¥æœŸ</th><th>ç‰©æµ</th><th>ä»¶æ•¸</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
    // åŠ å…¥éš¨æ©Ÿåƒæ•¸é˜²æ­¢å¿«å–
    const API_URL = 'https://script.google.com/macros/s/AKfycbywzx0zJx8hS41vX9BAsX-vGvImKFh6HZUyS6XqiyiMbhX3i4l_idcZVunMLAbc-IW8WQ/exec';
    let allRawData = [];
    let volChart;

    async function loadData(isRefresh = false) {
        const url = isRefresh ? `${API_URL}?nocache=${new Date().getTime()}` : API_URL;
        try {
            const res = await fetch(url);
            const data = await res.json();
            allRawData = data.map(d => ({
                Date: formatDate(d.Month || d.Date),
                Provider: (d.Provider || "").toLowerCase().trim(),
                Volume: parseInt(d.Volume) || 0
            })).filter(d => d.Date !== "Invalid Date");

            // åˆå§‹åŒ–æ—¥æœŸç¯©é¸å™¨
            initDateFilters();
            render();
            if(isRefresh) alert("æ•¸æ“šå·²æ›´æ–°ï¼");
        } catch (e) {
            alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª API æ¬Šé™");
        }
    }

    function formatDate(dateStr) {
        const d = new Date(dateStr);
        return isNaN(d.getTime()) ? dateStr : `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function initDateFilters() {
        const dates = [...new Set(allRawData.map(d => d.Date))].sort().reverse();
        const container = document.getElementById('date-filters');
        container.innerHTML = dates.map(d => `
            <label class="filter-option">
                <input type="checkbox" class="date-check" value="${d}" checked onchange="render()"> ${d}
            </label>
        `).join('');
    }

    function render() {
        const selectedProvs = Array.from(document.querySelectorAll('.prov-check:checked')).map(c => c.value);
        const selectedDates = Array.from(document.querySelectorAll('.date-check:checked')).map(c => c.value);

        const filteredData = allRawData.filter(d => 
            selectedProvs.includes(d.Provider) && selectedDates.includes(d.Date)
        );

        // KPI è¨ˆç®— (ä»¥å‹¾é¸ç¯„åœå…§æœ€å¾Œå…©å€‹æœˆå°æ¯”)
        const monthlySum = {};
        filteredData.forEach(d => monthlySum[d.Date] = (monthlySum[d.Date] || 0) + d.Volume);
        const sortedMonths = Object.keys(monthlySum).sort();
        const latest = monthlySum[sortedMonths[sortedMonths.length-1]] || 0;
        const prev = monthlySum[sortedMonths[sortedMonths.length-2]] || 0;

        document.getElementById('kpi-vol').innerText = latest.toLocaleString();
        calcGrowth('kpi-mom', latest, prev);

        // è¡¨æ ¼æ¸²æŸ“
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = filteredData.sort((a,b)=>b.Date.localeCompare(a.Date))
            .map(d => `<tr><td>${d.Date}</td><td>${d.Provider.toUpperCase()}</td><td>${d.Volume.toLocaleString()}</td></tr>`).join('');

        updateChart(sortedMonths, selectedProvs, allRawData);
    }

    function calcGrowth(id, cur, pre) {
        const el = document.getElementById(id);
        if(!pre) { el.innerText = "-"; return; }
        const diff = ((cur - pre) / pre * 100).toFixed(1);
        el.innerText = (diff > 0 ? "+" : "") + diff + "%";
        el.className = "kpi-value " + (diff >= 0 ? "up" : "down");
    }

    function updateChart(labels, provs, raw) {
        const ctx = document.getElementById('volChart').getContext('2d');
        if (volChart) volChart.destroy();

        const colors = { ibox: '#90ee90', hilife: '#e74c3c', fami: '#add8e6' };
        const datasets = provs.map(p => ({
            label: p.toUpperCase(),
            backgroundColor: colors[p],
            data: labels.map(m => {
                const found = raw.find(d => d.Date === m && d.Provider === p);
                return found ? found.Volume : 0;
            })
        }));

        volChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    loadData();
</script>
</body>
</html>
