<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å®¢æˆ¶è©•ä¼°è¡¨ï¼ˆå—ç“œè¨ˆç•«ï¼‰</title>

<style>
    body {
        font-family: "Noto Sans TC", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f5f7f6;
        margin: 0;
        padding: 0;
        color: #333;
    }

    h1 {
        text-align: center;
        padding: 20px;
        background: #0E8A57;
        color: white;
        margin: 0;
        font-size: 24px;
        letter-spacing: 1px;
    }

    .container {
        width: 95%;
        max-width: 1200px;
        margin: 20px auto 40px;
    }

    .card {
        background: #ffffff;
        padding: 16px 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        margin-bottom: 18px;
    }

    .card h2 {
        margin-top: 0;
        font-size: 18px;
        color: #0E8A57;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .dash-item {
        background: #f4faf6;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        border-left: 4px solid #0E8A57;
    }

    .dash-label {
        font-size: 13px;
        color: #666;
    }

    .dash-value {
        font-size: 18px;
        font-weight: bold;
        margin-top: 2px;
    }

    .grade-bars {
        margin-top: 10px;
    }

    .grade-row {
        display: flex;
        align-items: center;
        font-size: 13px;
        margin: 2px 0;
    }

    .grade-row span {
        width: 30px;
    }

    .bar {
        flex: 1;
        height: 10px;
        border-radius: 5px;
        background: #e3ece7;
        overflow: hidden;
        margin-left: 5px;
    }

    .bar-inner {
        height: 100%;
        width: 0%;
        transition: width 0.3s;
    }

    .bar-Ap  { background: #0E8A57; }
    .bar-A   { background: #1aaf6d; }
    .bar-B   { background: #2f80ed; }
    .bar-C   { background: #f2c94c; }
    .bar-D   { background: #f2994a; }
    .bar-F   { background: #eb5757; }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 13px;
    }

    th {
        background: #e9f6f0;
        border: 1px solid #d1d9d4;
        padding: 8px;
        font-weight: 600;
        text-align: center;
    }

    td {
        border: 1px solid #e0e4e1;
        padding: 6px;
        text-align: center;
    }

    input[type="text"],
    input[type="number"],
    select {
        width: 100%;
        box-sizing: border-box;
        padding: 4px 6px;
        border: 1px solid #c3c8c5;
        border-radius: 5px;
        font-size: 13px;
    }

    input[type="number"] {
        text-align: right;
    }

    .score-cell {
        font-weight: 600;
        color: #0E8A57;
    }

    .final-grade-cell {
        font-weight: 700;
    }

    .final-grade-cell.Ap { color: #0E8A57; }
    .final-grade-cell.A  { color: #1aaf6d; }
    .final-grade-cell.B  { color: #2f80ed; }
    .final-grade-cell.C  { color: #f2a600; }
    .final-grade-cell.D  { color: #e66b18; }
    .final-grade-cell.F  { color: #d62828; }

    .note {
        margin-top: 10px;
        padding: 10px 12px;
        background: #f4faf6;
        border-left: 4px solid #0E8A57;
        border-radius: 6px;
        font-size: 13px;
        line-height: 1.5;
    }

    .btn-row {
        margin-top: 10px;
        text-align: right;
    }

    button {
        padding: 6px 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        margin-left: 8px;
    }

    .btn-primary {
        background: #0E8A57;
        color: white;
    }

    .btn-secondary {
        background: #e9f1ee;
        color: #333;
    }

    @media (max-width: 768px) {
        table {
            font-size: 12px;
        }
        th, td {
            padding: 4px;
        }
    }
</style>
</head>

<body>

<h1>å®¢æˆ¶è©•ä¼°è¡¨ï¼ˆå—ç“œè¨ˆç•«ï¼‰</h1>

<div class="container">

    <!-- å„€è¡¨æ¿ -->
    <div class="card" id="dashboard">
        <h2>å„€è¡¨æ¿ç¸½è¦½</h2>
        <div class="dashboard-grid">
            <div class="dash-item">
                <div class="dash-label">ç¸½å®¢æˆ¶æ•¸</div>
                <div class="dash-value" id="totalClients">0</div>
            </div>
            <div class="dash-item">
                <div class="dash-label">å¹³å‡åˆ†æ•¸</div>
                <div class="dash-value" id="avgScore">0</div>
            </div>
            <div class="dash-item">
                <div class="dash-label">TOP å®¢æˆ¶ 1</div>
                <div class="dash-value" id="top1">â€”</div>
            </div>
            <div class="dash-item">
                <div class="dash-label">TOP å®¢æˆ¶ 2</div>
                <div class="dash-value" id="top2">â€”</div>
            </div>
            <div class="dash-item">
                <div class="dash-label">TOP å®¢æˆ¶ 3</div>
                <div class="dash-value" id="top3">â€”</div>
            </div>
        </div>

        <div class="grade-bars">
            <div class="grade-row">
                <span>A+</span>
                <div class="bar"><div class="bar-inner bar-Ap" id="barAp"></div></div>
            </div>
            <div class="grade-row">
                <span>A</span>
                <div class="bar"><div class="bar-inner bar-A" id="barA"></div></div>
            </div>
            <div class="grade-row">
                <span>B</span>
                <div class="bar"><div class="bar-inner bar-B" id="barB"></div></div>
            </div>
            <div class="grade-row">
                <span>C</span>
                <div class="bar"><div class="bar-inner bar-C" id="barC"></div></div>
            </div>
            <div class="grade-row">
                <span>D</span>
                <div class="bar"><div class="bar-inner bar-D" id="barD"></div></div>
            </div>
            <div class="grade-row">
                <span>F</span>
                <div class="bar"><div class="bar-inner bar-F" id="barF"></div></div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦è¡¨æ ¼ -->
    <div class="card">
        <h2>å®¢æˆ¶åˆ—è¡¨èˆ‡è©•åˆ†</h2>
        <div class="btn-row">
            <button class="btn-secondary" onclick="addRow()">ï¼‹ å¢åŠ ä¸€åˆ—</button>
            <button class="btn-secondary" onclick="calculateAll()">é‡æ–°è¨ˆç®—</button>
            <button class="btn-primary" onclick="sendToSheet()">é€å‡ºåˆ°è©¦ç®—è¡¨</button>
        </div>

        <table id="clientTable">
            <thead>
            <tr>
                <th>å®¢æˆ¶åç¨±</th>
                <th>å¹´ç‡Ÿæ”¶ï¼ˆNT$ï¼‰</th>
                <th>åˆä½œæ„‰å¿«ç¨‹åº¦<br>(Aâ€“F)</th>
                <th>ä»˜æ¬¾é€Ÿåº¦<br>(Aâ€“F)</th>
                <th>é‡è¤‡ç‡Ÿæ”¶<br>å¯èƒ½æ€§</th>
                <th>æºé€šå“è³ª</th>
                <th>æ˜¯å¦å¯æŒçºŒ<br>åˆä½œ</th>
                <th>æ¨è–¦åŠ›</th>
                <th>æ­·å²é—œä¿‚</th>
                <th>å¡«å¯«äºº</th>
                <th>æ³•å‰‡ä¸€è‡´æ€§2</th>
                <th>æ³•å‰‡ä¸€è‡´æ€§3</th>
                <th>åˆ†æ•¸</th>
                <th>æœ€çµ‚è©•ç­‰</th>
            </tr>
            </thead>
            <tbody>
            <!-- JS æœƒè‡ªå‹•åŠ é è¨­åˆ— -->
            </tbody>
        </table>

        <div class="note">
            ğŸ“Œ <b>è¨ˆåˆ†é‚è¼¯ï¼ˆå¯ä¾ä½ ä¹‹å¾Œéœ€è¦å†èª¿æ•´ï¼‰ï¼š</b><br>
            ãƒ»åˆä½œæ„‰å¿«ç¨‹åº¦ã€ä»˜æ¬¾é€Ÿåº¦ï¼šA=4, B=3, C=2, D=1, F=0<br>
            ãƒ»é‡è¤‡ç‡Ÿæ”¶å¯èƒ½æ€§ï¼ˆé«˜/ä¸­/ä½ï¼‰ï¼šé«˜=2, ä¸­=1, ä½=0<br>
            ãƒ»æºé€šå“è³ªï¼ˆå¥½/æ™®é€š/å·®ï¼‰ï¼šå¥½=2, æ™®é€š=1, å·®=0<br>
            ãƒ»æ˜¯å¦å¯æŒçºŒåˆä½œï¼ˆæ˜¯/å¦ï¼‰ï¼šæ˜¯=2, å¦=0<br>
            ãƒ»æ¨è–¦åŠ›ï¼ˆé«˜/ä¸­/ä½ï¼‰ï¼šé«˜=2, ä¸­=1, ä½=0<br>
            ãƒ»æ­·å²é—œä¿‚ï¼ˆæ–°/ä¸­ç­‰/é•·æœŸï¼‰ï¼šæ–°=0, ä¸­ç­‰=1, é•·æœŸ=2<br>
            ãƒ»æ¯å€‹æ³•å‰‡ä¸€è‡´æ€§ï¼ˆæ˜¯/å¦ï¼‰ï¼šæ˜¯=1, å¦=0<br>
            âœ ç¸½åˆ†æœ€é«˜ 21 åˆ†ã€‚<br>
            âœ ç­‰ç´šï¼š18+ = A+ï¼›16â€“17 = Aï¼›13â€“15 = Bï¼›10â€“12 = Cï¼›7â€“9 = Dï¼›â‰¤6 = Fã€‚
        </div>
    </div>

</div>

<script>
    // é€™è£¡æ›æˆä½ è‡ªå·±çš„ Apps Script Web App URLï¼ˆä½ å·²ç¶“è²¼ä¸Šäº†ï¼‰
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxnxREO7qpZi8cJiHBWLVznIpAuLJOig_J2ED9vQI9EiszbiQq4TQF-3bsXm51pHn0JWQ/exec';

    // å»ºç«‹é¸å–® HTML ç‰‡æ®µ
    function createSelect(options) {
        var html = '<select>';
        options.forEach(function (opt) {
            html += '<option value="' + opt + '">' + opt + '</option>';
        });
        html += '</select>';
        return html;
    }

    function addRow() {
        var tbody = document.querySelector("#clientTable tbody");
        var tr = document.createElement("tr");

        tr.innerHTML = `
            <td><input type="text" placeholder="å®¢æˆ¶åç¨±"></td>
            <td><input type="number" min="0" step="1000" placeholder="0"></td>
            <td>${createSelect(["A","B","C","D","F"])}</td>
            <td>${createSelect(["A","B","C","D","F"])}</td>
            <td>${createSelect(["é«˜","ä¸­","ä½"])}</td>
            <td>${createSelect(["å¥½","æ™®é€š","å·®"])}</td>
            <td>${createSelect(["æ˜¯","å¦"])}</td>
            <td>${createSelect(["é«˜","ä¸­","ä½"])}</td>
            <td>${createSelect(["æ–°","ä¸­ç­‰","é•·æœŸ"])}</td>
            <td>${createSelect(["MAX","Susan","Lesley","æ¥Šåšå£«","æŒ¯å„€","èŠ³ç«¹","Angela","Shin","Ivy","Janice","elese"])}</td>
            <td>${createSelect(["æ˜¯","å¦"])}</td>
            <td>${createSelect(["æ˜¯","å¦"])}</td>
            <td class="score-cell">0</td>
            <td class="final-grade-cell">â€”</td>
        `;

        tbody.appendChild(tr);

        // å³æ™‚ç›£è½è®Šæ›´å°±è‡ªå‹•é‡ç®—
        tr.querySelectorAll("input, select").forEach(function (el) {
            el.addEventListener("change", calculateAll);
        });
    }

    // åˆå§‹å…ˆåŠ  5 åˆ—
    for (var i = 0; i < 5; i++) {
        addRow();
    }

    function scoreLetter(letter) {
        switch (letter) {
            case "A": return 4;
            case "B": return 3;
            case "C": return 2;
            case "D": return 1;
            case "F": return 0;
            default: return 0;
        }
    }

    function scoreHighMidLow(val) {
        if (val === "é«˜") return 2;
        if (val === "ä¸­") return 1;
        return 0; // ä½ æˆ– æœªé¸
    }

    function scoreGoodNormalBad(val) {
        if (val === "å¥½") return 2;
        if (val === "æ™®é€š") return 1;
        return 0; // å·® æˆ– æœªé¸
    }

    function scoreYesNo(val, yesValue) {
        if (yesValue === undefined) yesValue = 2;
        return val === "æ˜¯" ? yesValue : 0;
    }

    function scoreHistory(val) {
        if (val === "é•·æœŸ") return 2;
        if (val === "ä¸­ç­‰") return 1;
        return 0; // æ–° æˆ– æœªé¸
    }

    function scoreLaw(val) {
        return val === "æ˜¯" ? 1 : 0;
    }

    function gradeFromScore(score) {
        if (score >= 18) return "A+";
        if (score >= 16) return "A";
        if (score >= 13) return "B";
        if (score >= 10) return "C";
        if (score >= 7)  return "D";
        return "F";
    }

    function calculateAll() {
        var tbody = document.querySelector("#clientTable tbody");
        var rows = Array.from(tbody.querySelectorAll("tr"));

        var totalClients = 0;
        var totalScoreSum = 0;
        var gradeCounts = { "A+":0, "A":0, "B":0, "C":0, "D":0, "F":0 };
        var clientScores = [];

        rows.forEach(function (tr) {
            var tds = tr.querySelectorAll("td");
            if (tds.length === 0) return;

            var name = tds[0].querySelector("input")?.value.trim() || "æœªå‘½åå®¢æˆ¶";

            var coop   = tds[2].querySelector("select").value;
            var pay    = tds[3].querySelector("select").value;
            var repeat = tds[4].querySelector("select").value;
            var comm   = tds[5].querySelector("select").value;
            var sustain= tds[6].querySelector("select").value;
            var refer  = tds[7].querySelector("select").value;
            var hist   = tds[8].querySelector("select").value;
            var law1   = tds[9].querySelector("select").value;
            var law2   = tds[10].querySelector("select").value;
            var law3   = tds[11].querySelector("select").value;

            // è‹¥æ•´åˆ—å®Œå…¨æ²’å¡«ï¼Œå°±è·³é
            var isEmptyRow = (!tds[0].querySelector("input").value.trim()) &&
                             (!tds[1].querySelector("input").value);
            if (isEmptyRow &&
                coop==="" && pay==="" && repeat==="" && comm==="" &&
                sustain==="" && refer==="" && hist==="" && law1==="" && law2==="" && law3==="") {
                tds[12].textContent = "0";
                tds[13].textContent = "â€”";
                tds[13].className = "final-grade-cell";
                return;
            }

            var score = 0;
            score += scoreLetter(coop);
            score += scoreLetter(pay);
            score += scoreHighMidLow(repeat);
            score += scoreGoodNormalBad(comm);
            score += scoreYesNo(sustain, 2);
            score += scoreHighMidLow(refer);
            score += scoreHistory(hist);
            score += scoreLaw(law1);
            score += scoreLaw(law2);
            score += scoreLaw(law3);

            var grade = gradeFromScore(score);

            tds[12].textContent = score;
            tds[13].textContent = grade;

            tds[13].className = "final-grade-cell";
            if (grade === "A+") tds[13].classList.add("Ap");
            else tds[13].classList.add(grade);

            totalClients++;
            totalScoreSum += score;
            if (gradeCounts[grade] !== undefined) {
                gradeCounts[grade]++;
            }

            clientScores.push({ name: name, score: score });
        });

        // å„€è¡¨æ¿æ›´æ–°
        document.getElementById("totalClients").textContent = totalClients;

        if (totalClients > 0) {
            document.getElementById("avgScore").textContent =
                (totalScoreSum / totalClients).toFixed(1);
        } else {
            document.getElementById("avgScore").textContent = "0";
        }

        // ä¾åˆ†æ•¸æ’åºæ‰¾ TOP 3
        clientScores.sort(function (a, b) { return b.score - a.score; });
        document.getElementById("top1").textContent = clientScores[0]?.name || "â€”";
        document.getElementById("top2").textContent = clientScores[1]?.name || "â€”";
        document.getElementById("top3").textContent = clientScores[2]?.name || "â€”";

        // é•·æ¢åœ–å¯¬åº¦
        var maxCount = Math.max(
            gradeCounts["A+"], gradeCounts["A"], gradeCounts["B"],
            gradeCounts["C"], gradeCounts["D"], gradeCounts["F"], 1
        );

        document.getElementById("barAp").style.width = (gradeCounts["A+"] / maxCount * 100) + "%";
        document.getElementById("barA").style.width  = (gradeCounts["A"]  / maxCount * 100) + "%";
        document.getElementById("barB").style.width  = (gradeCounts["B"]  / maxCount * 100) + "%";
        document.getElementById("barC").style.width  = (gradeCounts["C"]  / maxCount * 100) + "%";
        document.getElementById("barD").style.width  = (gradeCounts["D"]  / maxCount * 100) + "%";
        document.getElementById("barF").style.width  = (gradeCounts["F"]  / maxCount * 100) + "%";
    }

    // æŠŠè¡¨æ ¼å…§å®¹æ•´ç†æˆè¦é€å‡ºçš„ rows é™£åˆ—
    function collectRows() {
        var tbody = document.querySelector("#clientTable tbody");
        var rows = Array.from(tbody.querySelectorAll("tr"));
        var result = [];

        rows.forEach(function (tr) {
            var tds = tr.querySelectorAll("td");
            if (tds.length === 0) return;

            var nameInput = tds[0].querySelector("input");
            var name = (nameInput?.value || "").trim();
            var revenue = tds[1].querySelector("input")?.value || "";

            // è‹¥å®¢æˆ¶åç¨±èˆ‡ç‡Ÿæ”¶éƒ½ç©ºç™½ï¼Œå°±ä¸é€é€™åˆ—
            if (!name && !revenue) return;

            var coop   = tds[2].querySelector("select").value;
            var pay    = tds[3].querySelector("select").value;
            var repeat = tds[4].querySelector("select").value;
            var comm   = tds[5].querySelector("select").value;
            var sustain= tds[6].querySelector("select").value;
            var refer  = tds[7].querySelector("select").value;
            var hist   = tds[8].querySelector("select").value;
            var law1   = tds[9].querySelector("select").value;
            var law2   = tds[10].querySelector("select").value;
            var law3   = tds[11].querySelector("select").value;
            var score  = tds[12].textContent || "";
            var final  = tds[13].textContent || "";

            result.push({
                name: name,
                revenue: revenue,
                coop: coop,
                pay: pay,
                repeat: repeat,
                comm: comm,
                sustain: sustain,
                refer: refer,
                history: hist,
                law1: law1,
                law2: law2,
                law3: law3,
                score: score,
                finalGrade: final
            });
        });

        return result;
    }

async function sendToSheet() {
    // å…ˆé‡æ–°è¨ˆç®—ä¸€æ¬¡ï¼Œç¢ºä¿åˆ†æ•¸èˆ‡ç­‰ç´šæœ€æ–°
    calculateAll();

    const rows = collectRows();
    if (rows.length === 0) {
        alert('ç›®å‰æ²’æœ‰å¯é€å‡ºçš„å®¢æˆ¶è³‡æ–™ã€‚');
        return;
    }

    if (!SCRIPT_URL) {
        alert('å°šæœªè¨­å®š SCRIPT_URLã€‚');
        return;
    }

    const payload = { rows: rows };

    try {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // ğŸ”¸é—œéµï¼šä¸åš CORS æª¢æŸ¥
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        // no-cors æ¨¡å¼ä¸èƒ½è®€å›æ‡‰å…§å®¹ï¼Œæ‰€ä»¥ç›´æ¥è«‹ä½ åˆ°è©¦ç®—è¡¨ç¢ºèª
        alert('å·²é€å‡ºï¼Œè«‹åˆ° Google è©¦ç®—è¡¨ç¢ºèªæ˜¯å¦æœ‰æ–°å¢è³‡æ–™ã€‚');
    } catch (err) {
        alert('é€å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
    }
}

    // åˆæ¬¡è¼‰å…¥å…ˆç®—ä¸€æ¬¡
    window.addEventListener("load", calculateAll);
</script>

</body>
</html>
