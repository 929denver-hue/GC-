<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>GCè´ˆç‰©ç¶²ï½œIBOX æœˆåº¦è¶¨å‹¢ & è‡ªå‹•åˆ†æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      margin: 0;
      padding: 24px;
      background: #f6f7fb;
      color: #111827;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 18px;
      margin-top: 24px;
    }
    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      padding: 20px 20px 28px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.1fr 2fr;
      gap: 20px;
    }
    @media (max-width: 960px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead {
      background: #eff6ff;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      font-weight: 600;
      white-space: nowrap;
    }
    tr:nth-child(even) td {
      background: #f9fafb;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #374151;
      margin-right: 4px;
    }
    .tag.up {
      background: #dcfce7;
      color: #166534;
    }
    .tag.down {
      background: #fee2e2;
      color: #991b1b;
    }
    .buttons {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }
    button:hover {
      filter: brightness(1.05);
    }
    .summary {
      font-size: 13px;
      background: #f9fafb;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 12px;
      border: 1px dashed #d1d5db;
      color: #374151;
      line-height: 1.5;
    }
    .summary span {
      font-weight: 600;
    }
    .insight {
      margin-top: 18px;
      padding: 12px 14px;
      border-radius: 10px;
      background: #eef2ff;
      font-size: 13px;
      line-height: 1.6;
      color: #111827;
    }
    .insight-title {
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .insight-title span {
      font-size: 18px;
    }
    .chart-box {
      margin-top: 14px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 12px;
      background: #f9fafb;
      height: 260px;
    }
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .chart-subtitle {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .footer-note {
      margin-top: 16px;
      font-size: 12px;
      color: #9ca3af;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>IBOX æœˆåº¦è¶¨å‹¢ & è‡ªå‹•åˆ†æ</h1>
    <div class="subtitle">
      ä¿ç•™åŸæœ¬ã€Œæ¯æœˆå¡«è¡¨ã€çš„ç¿’æ…£ï¼Œé€™è£¡æœƒè‡ªå‹•è®€å–è©¦ç®—è¡¨ä¸¦ç”¢ç”Ÿåœ–è¡¨èˆ‡æ–‡å­—åˆ†æã€‚
    </div>

    <div class="grid">
      <!-- å·¦ï¼šè³‡æ–™è¡¨ + æŒ‰éˆ• + ç¸½çµ -->
      <div>
        <h2>1. æœˆåº¦è³‡æ–™ï¼ˆä¾†è‡ªè©¦ç®—è¡¨ï¼‰</h2>
        <table>
          <thead>
            <tr>
              <th>æœˆä»½</th>
              <th>å¯„ä»¶ç¸½æ•¸é‡</th>
              <th>æ¯æ—¥å¹³å‡</th>
              <th>éƒµå±€æ•¸é‡</th>
              <th>GCæ•¸é‡</th>
              <th>GC-éƒµå±€</th>
            </tr>
          </thead>
          <tbody id="dataBody">
            <!-- JS å‹•æ…‹å¡«å…¥ -->
          </tbody>
        </table>

        <div class="buttons">
          <button id="refreshBtn">ğŸ”„ é‡æ–°æŠ“è©¦ç®—è¡¨è³‡æ–™</button>
          <button id="downloadMainBtn" class="secondary">â¬‡ï¸ ä¸‹è¼‰ä¸»åœ–ï¼ˆPNGï¼‰</button>
        </div>

        <div id="summaryBox" class="summary">
          æ­£åœ¨è¼‰å…¥è³‡æ–™â€¦
        </div>

        <div id="insightBox" class="insight" style="display:none;">
          <div class="insight-title">
            <span>ğŸ“Š</span> è‡ªå‹•åˆ†æé‡é»
          </div>
          <div id="insightText"></div>
        </div>
      </div>

      <!-- å³ï¼šå¤šåœ–è¡¨ -->
      <div>
        <h2>2. åœ–è¡¨å€</h2>

        <div class="chart-box">
          <div class="chart-title">A. æœˆåº¦å¯„ä»¶ç¸½æ•¸é‡</div>
          <div class="chart-subtitle">åæ˜  IBOX å¯„ä»¶çš„æ•´é«”è¶¨å‹¢èˆ‡å­£ç¯€æ€§è®ŠåŒ–ã€‚</div>
          <canvas id="totalChart"></canvas>
        </div>

        <div class="chart-box">
          <div class="chart-title">B. èˆ‡ä¸Šæœˆæ¯”è¼ƒï¼ˆä»¶æ•¸è®ŠåŒ–ï¼‰</div>
          <div class="chart-subtitle">è‡ªå‹•è¨ˆç®—ã€Œæœ¬æœˆ - ä¸Šæœˆã€ï¼Œç¶ è‰²ç‚ºæˆé•·ã€ç´…è‰²ç‚ºè¡°é€€ã€‚</div>
          <canvas id="momChart"></canvas>
        </div>

        <div class="chart-box">
          <div class="chart-title">C. GC vs éƒµå±€ å¯„ä»¶é‡</div>
          <div class="chart-subtitle">è§€å¯Ÿ GC ç®¡é“æ˜¯å¦é€æ­¥æ‹‰å¤§èˆ‡éƒµå±€çš„å·®è·ã€‚</div>
          <canvas id="gcPostChart"></canvas>
        </div>
      </div>
    </div>

    <div class="footer-note">
      è³‡æ–™ä¾†æºï¼šGCè´ˆç‰©ç¶² IBOX ä½¿ç”¨æƒ…æ³ï¼ˆGoogle è©¦ç®—è¡¨ï¼‰
    </div>
  </div>

  <script>
    // â˜…â˜…â˜… é€™è£¡æ”¹æˆä½ çš„ Web App URL â˜…â˜…â˜…
    const API_URL = 'https://script.google.com/macros/s/ä½ çš„_web_app_ID/exec';

    let totalChart = null;
    let momChart = null;
    let gcPostChart = null;

    async function loadData() {
      const summaryBox = document.getElementById('summaryBox');
      summaryBox.textContent = 'æ­£åœ¨å¾è©¦ç®—è¡¨è¼‰å…¥è³‡æ–™â€¦';

      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'API å›å‚³éŒ¯èª¤');

        const rows = data.rows || [];
        const labels = rows.map(r => r.month);
        const totals = rows.map(r => Number(r.totalCount || 0));
        const avgDaily = rows.map(r => r.avgDaily);
        const postCounts = rows.map(r => r.postCount);
        const gcCounts = rows.map(r => r.gcCount);
        const diffGCPost = rows.map(r => r.gcMinusPost);

        renderTable(rows);
        renderTotalChart(labels, totals);
        renderMomChart(labels, totals);
        renderGCPostChart(labels, gcCounts, postCounts);
        updateSummary(labels, totals);
        updateInsight(rows);

      } catch (err) {
        console.error(err);
        summaryBox.textContent = 'è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š' + err.message;
      }
    }

    function renderTable(rows) {
      const tbody = document.getElementById('dataBody');
      tbody.innerHTML = '';

      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.textContent = 'ç›®å‰è©¦ç®—è¡¨å°šç„¡è³‡æ–™ã€‚';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');

        const tdMonth  = document.createElement('td');
        const tdTotal  = document.createElement('td');
        const tdAvg    = document.createElement('td');
        const tdPost   = document.createElement('td');
        const tdGC     = document.createElement('td');
        const tdDiff   = document.createElement('td');

        tdMonth.textContent = r.month || '';
        tdTotal.textContent = (r.totalCount || 0).toLocaleString();

        // æ¯æ—¥å¹³å‡å¯èƒ½æ˜¯å…¬å¼çµæœï¼Œæˆ‘å€‘ä¸è™•ç†æ ¼å¼ï¼Œç›´æ¥é¡¯ç¤º
        tdAvg.textContent  = r.avgDaily === '' ? '' : String(r.avgDaily);

        tdPost.textContent = r.postCount == null ? '' : (r.postCount || 0).toLocaleString();
        tdGC.textContent   = r.gcCount   == null ? '' : (r.gcCount   || 0).toLocaleString();

        if (r.gcMinusPost != null) {
          const val = r.gcMinusPost || 0;
          tdDiff.textContent = val.toLocaleString();
          if (val > 0) {
            tdDiff.innerHTML = val.toLocaleString() + ' <span class="tag up">GC é«˜æ–¼éƒµå±€</span>';
          } else if (val < 0) {
            tdDiff.innerHTML = val.toLocaleString() + ' <span class="tag down">GC ä½æ–¼éƒµå±€</span>';
          }
        } else {
          tdDiff.textContent = '';
        }

        tr.appendChild(tdMonth);
        tr.appendChild(tdTotal);
        tr.appendChild(tdAvg);
        tr.appendChild(tdPost);
        tr.appendChild(tdGC);
        tr.appendChild(tdDiff);
        tbody.appendChild(tr);
      });
    }

    function renderTotalChart(labels, totals) {
      const ctx = document.getElementById('totalChart').getContext('2d');
      if (totalChart) totalChart.destroy();

      totalChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'å¯„ä»¶ç¸½æ•¸é‡ï¼ˆä»¶ï¼‰',
            data: totals,
            borderWidth: 2,
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius: 6,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const val = context.parsed.y || 0;
                  return ' ' + val.toLocaleString() + ' ä»¶';
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'æœˆä»½'
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'å¯„ä»¶ç¸½æ•¸é‡ï¼ˆä»¶ï¼‰'
              },
              ticks: {
                callback: function (value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    function renderMomChart(labels, totals) {
      const momLabels = [];
      const momValues = [];

      for (let i = 0; i < totals.length; i++) {
        if (i === 0) {
          momLabels.push(labels[i]);
          momValues.push(0);
        } else {
          momLabels.push(labels[i]);
          momValues.push((totals[i] || 0) - (totals[i - 1] || 0));
        }
      }

      const ctx = document.getElementById('momChart').getContext('2d');
      if (momChart) momChart.destroy();

      momChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: momLabels,
          datasets: [{
            label: 'èˆ‡ä¸Šæœˆå·®ç•°ï¼ˆä»¶ï¼‰',
            data: momValues,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const val = context.parsed.y || 0;
                  const sign = val > 0 ? '+' : '';
                  return ' ' + sign + val.toLocaleString() + ' ä»¶';
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'æœˆä»½' }
            },
            y: {
              title: { display: true, text: 'èˆ‡ä¸Šæœˆå·®ç•°ï¼ˆä»¶ï¼‰' },
              ticks: {
                callback: function (value) {
                  const sign = value > 0 ? '+' : '';
                  return sign + value.toLocaleString();
                }
              }
            }
          }
        }
      });

      // ä¾æ­£è² çµ¦é¡è‰²ï¼ˆéœ€ Chart.js 3+ æ”¯æ´ï¼‰
      const dataset = momChart.data.datasets[0];
      dataset.backgroundColor = momValues.map(v => v >= 0 ? 'rgba(34,197,94,0.35)' : 'rgba(248,113,113,0.5)');
      dataset.borderColor = momValues.map(v => v >= 0 ? 'rgba(22,163,74,1)' : 'rgba(185,28,28,1)');
      momChart.update();
    }

    function renderGCPostChart(labels, gcCounts, postCounts) {
      const ctx = document.getElementById('gcPostChart').getContext('2d');
      if (gcPostChart) gcPostChart.destroy();

      gcPostChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'GCæ•¸é‡',
              data: gcCounts,
              borderWidth: 1
            },
            {
              label: 'éƒµå±€æ•¸é‡',
              data: postCounts,
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const val = context.parsed.y || 0;
                  return ' ' + val.toLocaleString() + ' ä»¶';
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'æœˆä»½' },
              stacked: false
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'ä»¶æ•¸' },
              ticks: {
                callback: function (value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    function updateSummary(labels, totals) {
      const box = document.getElementById('summaryBox');
      if (!labels || labels.length === 0) {
        box.textContent = 'ç›®å‰å°šæœªè¼¸å…¥æœˆåº¦è³‡æ–™ã€‚è«‹å…ˆåœ¨è©¦ç®—è¡¨å¡«å¯«ã€Œæœˆä»½ã€èˆ‡ã€Œå¯„ä»¶ç¸½æ•¸é‡ã€ã€‚';
        return;
      }

      let total = 0;
      let minVal = null, maxVal = null;
      let minLabel = '', maxLabel = '';
      const nonZero = [];

      totals.forEach((v, i) => {
        const val = Number(v) || 0;
        total += val;
        if (val > 0) nonZero.push(val);
        if (minVal === null || val < minVal) {
          minVal = val;
          minLabel = labels[i];
        }
        if (maxVal === null || val > maxVal) {
          maxVal = val;
          maxLabel = labels[i];
        }
      });

      if (nonZero.length === 0) {
        box.textContent = 'ç›®å‰è³‡æ–™éƒ½æ˜¯ 0 æˆ–ç©ºç™½ï¼Œè«‹ç¢ºèªã€Œå¯„ä»¶ç¸½æ•¸é‡ã€æ¬„ä½ã€‚';
        return;
      }

      const avg = total / nonZero.length;
      box.innerHTML =
        'å·²è®€å– <span>' + labels.length + '</span> å€‹æœˆä»½ï¼Œ' +
        'ç¸½å¯„ä»¶é‡ <span>' + total.toLocaleString() + '</span> ä»¶ï¼Œ' +
        'å¹³å‡æ¯æœˆ <span>' + Math.round(avg).toLocaleString() + '</span> ä»¶ã€‚<br>' +
        'æœ€é«˜ç‚º <span>' + maxLabel + '</span>ï¼ˆ' + maxVal.toLocaleString() + ' ä»¶ï¼‰ï¼Œ' +
        'æœ€ä½ç‚º <span>' + minLabel + '</span>ï¼ˆ' + minVal.toLocaleString() + ' ä»¶ï¼‰ã€‚';
    }

    function updateInsight(rows) {
      const insightBox = document.getElementById('insightBox');
      const insightText = document.getElementById('insightText');

      if (!rows || rows.length === 0) {
        insightBox.style.display = 'none';
        return;
      }

      insightBox.style.display = 'block';

      const latest = rows[rows.length - 1];
      const prev   = rows.length >= 2 ? rows[rows.length - 2] : null;

      const latestMonth = latest.month || 'ï¼ˆæœªå¡«ï¼‰';
      const latestTotal = Number(latest.totalCount || 0);

      let momSentence = 'ç›®å‰åªæœ‰ä¸€å€‹æœˆä»½è³‡æ–™ï¼Œå°šç„¡æ³•æ¯”è¼ƒä¸Šæœˆè®ŠåŒ–ã€‚';
      if (prev) {
        const prevTotal = Number(prev.totalCount || 0);
        const diff = latestTotal - prevTotal;
        const diffSign = diff > 0 ? 'å¢åŠ ' : (diff < 0 ? 'æ¸›å°‘' : 'æŒå¹³');
        const diffAbs = Math.abs(diff);
        const rate = prevTotal > 0 ? (diff / prevTotal) * 100 : 0;

        if (diff === 0) {
          momSentence = `ç›¸è¼ƒä¸Šå€‹æœˆä»½ï¼ˆ${prev.month}ï¼‰ï¼Œå¯„ä»¶é‡æŒå¹³ï¼Œçš†ç‚º ${latestTotal.toLocaleString()} ä»¶ã€‚`;
        } else {
          momSentence =
            `ç›¸è¼ƒä¸Šå€‹æœˆä»½ï¼ˆ${prev.month}ï¼‰ï¼Œæœ¬æœˆå¯„ä»¶é‡${diffSign} <b>${diffAbs.toLocaleString()}</b> ä»¶ï¼Œ` +
            `ç´„ <b>${rate.toFixed(1)}%</b>ã€‚`;
        }
      }

      // éå»ä¸‰å€‹æœˆè¶¨å‹¢
      let trendSentence = '';
      if (rows.length >= 3) {
        const a = Number(rows[rows.length - 3].totalCount || 0);
        const b = Number(rows[rows.length - 2].totalCount || 0);
        const c = Number(rows[rows.length - 1].totalCount || 0);

        if (a <= b && b <= c && !(a === b && b === c)) {
          trendSentence = 'éå»ä¸‰å€‹æœˆä»½å‘ˆç¾ã€Œç©©å®šæˆé•·ã€è¶¨å‹¢ï¼Œé©åˆåŠ ç¢¼æ”¾å¤§æˆåŠŸåšæ³•ã€‚';
        } else if (a >= b && b >= c && !(a === b && b === c)) {
          trendSentence = 'éå»ä¸‰å€‹æœˆä»½å‘ˆç¾ã€Œé€£çºŒä¸‹æ»‘ã€è¶¨å‹¢ï¼Œå»ºè­°æª¢è¦–è¡ŒéŠ· / å¼•å°æµç¨‹æ˜¯å¦éœ€è¦èª¿æ•´ã€‚';
        } else {
          trendSentence = 'éå»ä¸‰å€‹æœˆä»½è®ŠåŒ–è¼ƒç‚ºæ³¢å‹•ï¼Œå¯èƒ½å—åˆ°æ´»å‹•æª”æœŸæˆ–å¤–éƒ¨å› ç´ å½±éŸ¿ï¼Œå»ºè­°æ­é…æ´»å‹•æ—¥æ›†ä¸€èµ·è§£è®€ã€‚';
        }
      }

      // GC vs éƒµå±€ åˆ†æï¼ˆåªçœ‹æœ€æ–°ä¸€åˆ—ï¼‰
      let gcSentence = '';
      if (latest.gcCount != null || latest.postCount != null) {
        const gc = Number(latest.gcCount || 0);
        const post = Number(latest.postCount || 0);
        const totalChannel = gc + post;
        const gcShare = totalChannel > 0 ? (gc / totalChannel) * 100 : 0;
        const diff = gc - post;
        const diffWord = diff > 0 ? 'é«˜æ–¼' : (diff < 0 ? 'ä½æ–¼' : 'èˆ‡â€¦ç›¸ç•¶');

        if (totalChannel > 0) {
          gcSentence =
            `åœ¨æœ€æ–°æœˆä»½ä¸­ï¼ŒGC ç®¡é“å¯„ä»¶é‡ç‚º <b>${gc.toLocaleString()}</b> ä»¶ï¼Œ` +
            `éƒµå±€ç‚º <b>${post.toLocaleString()}</b> ä»¶ï¼ŒGC ${diffWord}éƒµå±€ <b>${Math.abs(diff).toLocaleString()}</b> ä»¶ï¼Œ` +
            `ç´„ä½”å…©è€…ç¸½å’Œçš„ <b>${gcShare.toFixed(1)}%</b>ã€‚`;
        }
      }

      insightText.innerHTML =
        `â— æœ€æ–°æœˆä»½ç‚º <b>${latestMonth}</b>ï¼Œå¯„ä»¶ç¸½æ•¸é‡ç‚º <b>${latestTotal.toLocaleString()}</b> ä»¶ã€‚<br>` +
        `â— ${momSentence}<br>` +
        (trendSentence ? `â— ${trendSentence}<br>` : '') +
        (gcSentence ? `â— ${gcSentence}` : '');
    }

    function downloadMainChart() {
      if (!totalChart) {
        alert('åœ–è¡¨å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚');
        return;
      }
      const a = document.createElement('a');
      a.href = totalChart.toBase64Image('image/png', 1.0);
      a.download = 'ibox-monthly-total.png';
      a.click();
    }

    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('downloadMainBtn').addEventListener('click', downloadMainChart);

    window.addEventListener('load', loadData);
  </script>
</body>
</html>
