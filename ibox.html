<script>

const API_URL = "https://script.google.com/macros/s/AKfycbx9eVJpOxflNXwrMmTFFQsR74f74Vr9RYlOXi5NU7DKDVQE_05VDTraZ6TRtl-t8A6nXg/exec";

let globalRows = [];


// ---------- Utils ----------
function parseMonthFormat(v) {
  if (!v) return "";
  v = String(v).trim();

  if (/^\d{4}-\d{2}$/.test(v)) return v;

  const match = v.match(/(20\d{2})[^\d]{1,3}(\d{1,2})/);
  if (match) {
    return `${match[1]}-${String(match[2]).padStart(2,"0")}`;
  }

  const d = new Date(v);
  if (!isNaN(d.getTime())) {
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }

  return v;
}


// ---------- Load Data ----------
async function loadData() {
  const summaryBox = document.getElementById("summaryBox");
  summaryBox.textContent = "æ­£åœ¨è¼‰å…¥è³‡æ–™...";

  try {

    const res = await fetch(API_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "è³‡æ–™æ ¼å¼éŒ¯èª¤");

    globalRows = data.rows.map(r => ({
      month: parseMonthFormat(r.month),
      totalCount: Number(r.totalCount || 0),
      shareCount: Number(r.shareCount || 0),
      flashCount: Number(r.flashCount || 0),
      giftCount: Number(r.giftCount || 0),
      demandCount: Number(r.demandCount || 0),
    }));

    renderTable(globalRows);
    updateMonthlyReport();

    summaryBox.textContent = "è³‡æ–™æ›´æ–°å®Œæˆ âœ”ï¸";

  } catch (err) {
    console.error(err);
    summaryBox.innerHTML = `<span style="color:red;">âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼š${err.message}</span>`;
  }
}


// ---------- Table Render ----------
function renderTable(rows) {
  const tbody = document.getElementById("dataBody");
  tbody.innerHTML = "";

  rows.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.month}</td>
      <td>${row.totalCount.toLocaleString()}</td>
      <td>${row.shareCount}</td>
      <td>${row.flashCount}</td>
      <td>${row.giftCount}</td>
      <td>${row.demandCount}</td>
    `;
    tbody.appendChild(tr);
  });
}


// ---------- Monthly Summary ----------
function updateMonthlyReport() {

  const box = document.getElementById("monthlyReportText");
  if (!globalRows.length) {
    box.textContent = "å°šç„¡è³‡æ–™";
    return;
  }

  const latest = globalRows[globalRows.length - 1];
  const prev = globalRows.length > 1 ? globalRows[globalRows.length - 2] : null;

  const monthLabel = latest.month.replace("-", "/");
  const total = latest.totalCount;


  // MoM
  let momText = "ç›¸è¼ƒä¸Šæœˆï¼šç„¡è³‡æ–™";
  if (prev) {
    const diff = total - prev.totalCount;
    const rate = prev.totalCount > 0 ? (diff / prev.totalCount * 100).toFixed(1) : 0;
    const word = diff > 0 ? "æˆé•·" : diff < 0 ? "æ¸›å°‘" : "æŒå¹³";
    momText = `ç›¸è¼ƒä¸Šæœˆï¼š${word} ${Math.abs(diff)} ä»¶ï¼ˆ${rate}%ï¼‰`;
  }


  // YoY
  let yoyText = "èˆ‡å»å¹´åŒæœŸï¼šå°šç„¡è³‡æ–™";
  const [y,m] = latest.month.split("-");
  const lastYearTarget = `${Number(y)-1}-${m}`;
  const lastYear = globalRows.find(r => r.month === lastYearTarget);

  if (lastYear) {
    const diff = total - lastYear.totalCount;
    const rate = lastYear.totalCount > 0 ? (diff / lastYear.totalCount * 100).toFixed(1) : 0;
    const word = diff > 0 ? "æˆé•·" : diff < 0 ? "æ¸›å°‘" : "æŒå¹³";
    yoyText = `èˆ‡å»å¹´åŒæœŸï¼š${word} ${Math.abs(diff)} ä»¶ï¼ˆ${rate}%ï¼‰`;
  }


  // Channels
  const sum = latest.shareCount + latest.flashCount + latest.giftCount + latest.demandCount;
  const pct = v => sum ? (v/sum*100).toFixed(1)+"%" : "-";

  const channelText = `
    é€šè·¯ä½”æ¯”ï¼šåˆ†äº«é€š ${pct(latest.shareCount)}ã€é–ƒé€å€ ${pct(latest.flashCount)}ã€
    ç¦®ç‰©æ±  ${pct(latest.giftCount)}ã€éœ€æ±‚æ±  ${pct(latest.demandCount)}
  `;


  box.innerHTML = `
    ğŸ“¦ <b>${monthLabel} GC IBOX ç•¶æœˆå ±å‘Š</b><br><br>
    æœ¬æœˆå¯„ä»¶é‡ï¼š<b>${total.toLocaleString()} ä»¶</b><br><br>
    â€¢ ${momText}<br>
    â€¢ ${yoyText}<br>
    â€¢ ${channelText}
  `;
}


// ---- Run on page load ----
window.addEventListener("load", loadData);

</script>
