<!DOCTYPE html>
<html lang="zh-TN">
<head>
<meta charset="UTF-8">
<title>GC IBOX Dashboard</title>
<link rel="icon" href="data:,">
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  .report-box {
    margin-top: 25px;
    padding: 15px;
    border-radius: 10px;
    background: #f7f8fa;
    border: 1px solid #ddd;
    line-height: 1.7em;
  }
</style>
</head>

<body>

<h2>ğŸ“¦ GC IBOX æ•¸æ“šå„€è¡¨æ¿</h2>
<div id="summaryBox" style="margin-bottom:10px;">è³‡æ–™å°šæœªè¼‰å…¥â€¦</div>

<h3>ğŸ“‹ ç•¶æœˆå ±å‘Š</h3>
<div id="monthlyReportText" class="report-box">ï¼ˆç­‰å¾…è³‡æ–™ï¼‰</div>

<h3>ğŸ“Š å…¨éƒ¨å¯„ä»¶è³‡æ–™</h3>
<table>
<thead>
<tr>
<th>æœˆä»½</th><th>å¯„ä»¶ç¸½æ•¸</th><th>åˆ†äº«é€š</th><th>é–ƒé€å€</th><th>ç¦®ç‰©æ± </th><th>éœ€æ±‚æ± </th>
</tr>
</thead>
<tbody id="dataBody"></tbody>
</table>

<script>
// <<< ä¿®æ”¹é€™è¡Œæˆä½ çš„ GAS URL >>>
const API_URL = "https://script.google.com/macros/s/AKfycbx9eVJpOxflNXwrMmTFFQsR74f74Vr9RYlOXi5NU7DKDVQE_05VDTraZ6TRtl-t8A6nXg/exec";

let globalRows = [];

// --- å·¥å…·ï¼šæ ¼å¼åŒ–æœˆä»½ ---
function formatMonth(v) {
  if (!v) return "";
  v = String(v).trim();
  if (/^\d{4}-\d{2}$/.test(v)) return v;

  const m = v.match(/(20\d{2}).*?(\d{1,2})/);
  if (m) return `${m[1]}-${String(m[2]).padStart(2,"0")}`;

  const d = new Date(v);
  if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;

  return v;
}

// --- æ¸²æŸ“è¡¨æ ¼ ---
function renderTable(rows) {
  const tbody = document.getElementById("dataBody");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.month}</td>
      <td>${r.totalCount.toLocaleString()}</td>
      <td>${r.shareCount}</td>
      <td>${r.flashCount}</td>
      <td>${r.giftCount}</td>
      <td>${r.demandCount}</td>
    `;
    tbody.appendChild(tr);
  });
}

// --- ç•¶æœˆåˆ†æ ---
function updateMonthlyReport() {
  const box = document.getElementById("monthlyReportText");
  if (!globalRows.length) {
    box.textContent = "å°šç„¡è³‡æ–™";
    return;
  }

  const latest = globalRows[globalRows.length - 1];
  const prev = globalRows.length > 1 ? globalRows[globalRows.length - 2] : null;

  const monthLabel = latest.month.replace("-", "/");
  const total = latest.totalCount;

  // MoM
  let mom = "ç„¡å¯æ¯”è¼ƒè³‡æ–™";
  if (prev) {
    const diff = total - prev.totalCount;
    const rate = prev.totalCount ? ((diff/prev.totalCount)*100).toFixed(1) : "0";
    const word = diff > 0 ? "æˆé•·" : diff < 0 ? "æ¸›å°‘" : "æŒå¹³";
    mom = `${word} ${Math.abs(diff)} ä»¶ï¼ˆ${rate}%ï¼‰`;
  }

  // YoY
  let yoy = "å°šç„¡è³‡æ–™";
  const [y,m] = latest.month.split("-");
  const last = globalRows.find(r => r.month === `${Number(y)-1}-${m}`);

  if (last) {
    const diff = total - last.totalCount;
    const rate = ((diff/last.totalCount)*100).toFixed(1);
    const word = diff > 0 ? "æˆé•·" : diff < 0 ? "æ¸›å°‘" : "æŒå¹³";
    yoy = `${word} ${Math.abs(diff)} ä»¶ï¼ˆ${rate}%ï¼‰`;
  }

  // é€šè·¯ä½”æ¯”
  const sum = latest.shareCount + latest.flashCount + latest.giftCount + latest.demandCount;
  const pct = v => sum ? (v/sum*100).toFixed(1)+"%" : "-";

  box.innerHTML = `
    ğŸ“¦ <b>${monthLabel} GC IBOX ç•¶æœˆå ±å‘Š</b><br><br>
    æœ¬æœˆå¯„ä»¶é‡ï¼š<b>${total.toLocaleString()}</b><br><br>
    â€¢ ç›¸è¼ƒä¸Šæœˆï¼š${mom}<br>
    â€¢ èˆ‡å»å¹´åŒæœŸï¼š${yoy}<br>
    â€¢ é€šè·¯ä½”æ¯”ï¼šåˆ†äº«é€š ${pct(latest.shareCount)}ã€é–ƒé€å€ ${pct(latest.flashCount)}ã€
      ç¦®ç‰©æ±  ${pct(latest.giftCount)}ã€éœ€æ±‚æ±  ${pct(latest.demandCount)}
  `;
}

// --- è®€ API ---
async function loadData() {
  const box = document.getElementById("summaryBox");
  box.textContent = "è®€å–ä¸­â€¦";

  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    globalRows = data.rows.map(v => ({
      month: formatMonth(v.month),
      totalCount: Number(v.totalCount || 0),
      shareCount: Number(v.shareCount || 0),
      flashCount: Number(v.flashCount || 0),
      giftCount: Number(v.giftCount || 0),
      demandCount: Number(v.demandCount || 0)
    }));

    globalRows.sort((a,b)=> a.month.localeCompare(b.month));
    
    renderTable(globalRows);
    updateMonthlyReport();
    box.textContent = "è³‡æ–™è¼‰å…¥å®Œæˆ âœ”ï¸";
  } catch(err) {
    box.innerHTML = `<span style="color:red;">âŒ éŒ¯èª¤ï¼š${err.message}</span>`;
  }
}

window.addEventListener("load", loadData);
</script>

</body>
</html>
