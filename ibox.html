<script>
/* ★★★ 這裡改成你目前成功的 exec URL ★★★ */
const API_URL = "https://script.google.com/macros/s/AKfycbx9eVJpOxflNXwrMmTFFQsR74f74Vr9RYlOXi5NU7DKDVQE_05VDTraZ6TRtl-t8A6nXg/exec";

let totalChart = null;
let momChart = null;
let channelPieChart = null;
let globalRows = [];

/* ----------------- 日期解析 + 統一格式 ----------------- */
function parseYearMonth(label) {
  const text = String(label || "").trim();
  if (!text) return { year: null, month: null };

  let m = text.match(/(20\d{2})[^\d]{0,2}(\d{1,2})/);
  if (m) {
    return { year: parseInt(m[1]), month: parseInt(m[2]) };
  }

  const d = new Date(text);
  if (!isNaN(d)) {
    return { year: d.getFullYear(), month: d.getMonth() + 1 };
  }

  return { year: null, month: null };
}

function formatMonthLabel(raw) {
  const ym = parseYearMonth(raw);
  if (ym.year && ym.month) return `${ym.year}-${String(ym.month).padStart(2, "0")}`;
  return raw;
}

/* ----------------- 主流程載入資料 ----------------- */
async function loadData() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();

    if (!data.ok) throw new Error(data.error);

    globalRows = data.rows || [];

    renderTable(globalRows);
    buildRangeOptions(globalRows);
    buildYearMonthOptions(globalRows);

    redrawCharts();
    renderChannelPieBySelection();
    updateInsight(globalRows);

  } catch (err) {
    console.error("載入錯誤：", err);
  }
}

/* ----------------- 表格顯示 ----------------- */
function renderTable(rows) {
  const tbody = document.getElementById("dataBody");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");

    const fields = [
      formatMonthLabel(r.month),
      r.totalCount?.toLocaleString() || "",
      r.shareCount?.toLocaleString() || "",
      r.flashCount?.toLocaleString() || "",
      r.giftCount?.toLocaleString() || "",
      r.demandCount?.toLocaleString() || ""
    ];

    fields.forEach(text => {
      const td = document.createElement("td");
      td.textContent = text;
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

/* ----------------- 篩選範圍 ----------------- */
function buildRangeOptions(rows) {
  const select = document.getElementById("rangeSelect");
  if (!select) return;

  select.innerHTML = `
    <option value="all">全部</option>
    <option value="last12">最近12個月</option>
  `;

  [...new Set(rows.map(r => parseYearMonth(r.month).year))]
    .filter(y => y)
    .sort()
    .forEach(year => {
      let opt = document.createElement("option");
      opt.value = `year-${year}`;
      opt.textContent = `${year} 年`;
      select.appendChild(opt);
    });

  select.onchange = redrawCharts;
}

function getFilteredRows() {
  const select = document.getElementById("rangeSelect");
  if (!select || !globalRows) return globalRows;
  
  const v = select.value;

  if (v === "last12") return globalRows.slice(-12);
  if (v.startsWith("year-")) {
    const y = parseInt(v.replace("year-", ""));
    return globalRows.filter(r => parseYearMonth(r.month).year === y);
  }
  
  return globalRows;
}

/* ----------------- 圖表 ----------------- */
function redrawCharts() {
  const rows = getFilteredRows();
  const labels = rows.map(r => formatMonthLabel(r.month));
  const totals = rows.map(r => Number(r.totalCount || 0));

  renderTotalChart(labels, totals);
  renderMomChart(labels, totals);
}

function renderTotalChart(labels, totals) {
  const ctx = document.getElementById("totalChart");
  if (!ctx) return;

  if (totalChart) totalChart.destroy();

  totalChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{ label: "寄件量", data: totals, borderWidth: 2 }]
    }
  });
}

function renderMomChart(labels, totals) {
  const ctx = document.getElementById("momChart");
  if (!ctx) return;

  const diff = totals.map((v, i) => i === 0 ? 0 : v - totals[i - 1]);

  if (momChart) momChart.destroy();

  momChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{ label: "月增減", data: diff }]
    }
  });
}

/* ----------------- 圓餅圖 ----------------- */
function buildYearMonthOptions(rows) {
  const yearSel = document.getElementById("yearSelect");
  const monthSel = document.getElementById("monthSelect");
  if (!yearSel || !monthSel) return;

  yearSel.innerHTML = "";
  monthSel.innerHTML = "";

  const parsed = rows.map(r => ({ ...parseYearMonth(r.month), raw: r }));

  const years = [...new Set(parsed.map(x => x.year))];
  years.forEach(y => {
    let opt = document.createElement("option");
    opt.value = y;
    opt.textContent = `${y} 年`;
    yearSel.appendChild(opt);
  });

  yearSel.onchange = () => updateMonthOptions(parsed);
  monthSel.onchange = renderChannelPieBySelection;

  updateMonthOptions(parsed);
}

function updateMonthOptions(parsed) {
  const yearSel = document.getElementById("yearSelect");
  const monthSel = document.getElementById("monthSelect");

  monthSel.innerHTML = "";

  parsed
    .filter(x => x.year == yearSel.value)
    .forEach(x => {
      const opt = document.createElement("option");
      opt.value = x.month;
      opt.textContent = `${x.month} 月`;
      monthSel.appendChild(opt);
    });

  renderChannelPieBySelection();
}

function renderChannelPieBySelection() {
  const yearSel = document.getElementById("yearSelect");
  const monthSel = document.getElementById("monthSelect");
  const ctx = document.getElementById("channelPieChart");
  if (!ctx) return;

  const ym = globalRows.find(r => {
    const parsed = parseYearMonth(r.month);
    return parsed.year == yearSel.value && parsed.month == monthSel.value;
  });

  if (!ym) return;

  const labels = [];
  const values = [];

  [["分享通", ym.shareCount], ["閃送區", ym.flashCount], ["禮物池", ym.giftCount], ["需求池", ym.demandCount]]
    .forEach(([label, val]) => {
      if (val && val > 0) { labels.push(label); values.push(val); }
    });

  if (channelPieChart) channelPieChart.destroy();

  channelPieChart = new Chart(ctx, {
    type: "pie",
    data: { labels, datasets: [{ data: values }] }
  });
}

/* ----------------- Insight（可選） ----------------- */
function updateInsight(rows) {
  const el = document.getElementById("insightText");
  if (!el || rows.length < 2) return;
  const latest = rows.at(-1);
  const prev = rows.at(-2);

  el.innerHTML = `
    <b>${formatMonthLabel(latest.month)}</b>：${latest.totalCount} 件<br>
    月增減：${latest.totalCount - prev.totalCount} 件
  `;
}

/* ----------------- 初始化 ----------------- */
window.addEventListener("load", loadData);
</script>
