<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>GCè´ˆç‰©ç¶²ï½œIBOX æœˆåº¦è¶¨å‹¢ & è‡ªå‹•åˆ†æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      margin: 0;
      padding: 24px;
      background: #f6f7fb;
      color: #111827;
    }
    h1 { font-size: 24px; margin-bottom: 4px; }
    h2 { font-size: 18px; margin-top: 24px; }
    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      padding: 20px 20px 28px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.1fr 2fr;
      gap: 20px;
    }
    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead { background: #eff6ff; }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: center;
    }
    th { font-weight: 600; white-space: nowrap; }
    tr:nth-child(even) td { background: #f9fafb; }

    .buttons {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }
    button:hover { filter: brightness(1.05); }

    .summary {
      font-size: 13px;
      background: #f9fafb;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 12px;
      border: 1px dashed #d1d5db;
      color: #374151;
      line-height: 1.5;
    }
    .summary span { font-weight: 600; }

    .insight {
      margin-top: 18px;
      padding: 12px 14px;
      border-radius: 10px;
      background: #eef2ff;
      font-size: 13px;
      line-height: 1.6;
      color: #111827;
    }
    .insight-title {
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .insight-title span { font-size: 18px; }

    .chart-box {
      margin-top: 14px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 12px;
      background: #f9fafb;
      height: 230px;
    }
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .chart-subtitle {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .footer-note {
      margin-top: 16px;
      font-size: 12px;
      color: #9ca3af;
      text-align: right;
    }
    .selector-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    select {
      padding: 3px 6px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>IBOX æœˆåº¦è¶¨å‹¢ & è‡ªå‹•åˆ†æ</h1>
    <div class="subtitle">
      ä¿ç•™åŸæœ¬ã€Œæ¯æœˆå¡«å¤§è¡¨ã€çš„ç¿’æ…£ï¼Œé€™è£¡æœƒè‡ªå‹•è®€å–è©¦ç®—è¡¨ä¸¦ç”¢ç”Ÿåœ–è¡¨èˆ‡æ–‡å­—åˆ†æã€‚
    </div>

    <div class="grid">
      <!-- å·¦ï¼šè³‡æ–™è¡¨ + æŒ‰éˆ• + ç¸½çµ -->
      <div>
        <h2>1. æœˆåº¦è³‡æ–™ï¼ˆä¾†è‡ªå¤§è¡¨ï¼‰</h2>
        <table>
          <thead>
            <tr>
              <th>æœˆä»½</th>
              <th>ç¸½å¯„ä»¶</th>
              <th>åˆ†äº«é€š</th>
              <th>é–ƒé€å€</th>
              <th>ç¦®ç‰©æ± </th>
              <th>éœ€æ±‚æ± </th>
            </tr>
          </thead>
          <tbody id="dataBody">
            <!-- JS å‹•æ…‹å¡«å…¥ -->
          </tbody>
        </table>

        <div class="buttons">
          <button id="refreshBtn">ğŸ”„ é‡æ–°æŠ“è©¦ç®—è¡¨è³‡æ–™</button>
          <button id="downloadMainBtn" class="secondary">â¬‡ï¸ ä¸‹è¼‰ä¸»åœ–ï¼ˆPNGï¼‰</button>
        </div>

        <div id="summaryBox" class="summary">
          æ­£åœ¨è¼‰å…¥è³‡æ–™â€¦
        </div>

        <div id="insightBox" class="insight" style="display:none;">
          <div class="insight-title">
            <span>ğŸ“Š</span> è‡ªå‹•åˆ†æé‡é»
          </div>
          <div id="insightText"></div>
        </div>
      </div>

      <!-- å³ï¼šä¸‰å€‹åœ–è¡¨ -->
      <div>
        <h2>2. åœ–è¡¨å€</h2>

        <div class="chart-box">
          <div class="chart-title">A. æœˆåº¦ç¸½å¯„ä»¶é‡</div>
          <div class="selector-row">
            <span>é¡¯ç¤ºç¯„åœï¼š</span>
            <select id="rangeSelect"></select>
          </div>
          <div class="chart-subtitle">
            å¯åˆ‡æ›ã€Œå…¨éƒ¨å¹´åº¦ / æœ€è¿‘ 12 å€‹æœˆ / å–®ä¸€å¹´ã€ä¾†è§€å¯Ÿä¸åŒå±¤æ¬¡çš„è¶¨å‹¢ã€‚
          </div>
          <canvas id="totalChart"></canvas>
        </div>

        <div class="chart-box">
          <div class="chart-title">B. èˆ‡ä¸Šæœˆæ¯”è¼ƒï¼ˆä»¶æ•¸è®ŠåŒ–ï¼‰</div>
          <div class="chart-subtitle">ä¾ç›®å‰é¡¯ç¤ºç¯„åœè¨ˆç®—ã€Œæœ¬æœˆ âˆ’ ä¸Šæœˆã€ï¼Œç¶ è‰²ç‚ºæˆé•·ã€ç´…è‰²ç‚ºè¡°é€€ã€‚</div>
          <canvas id="momChart"></canvas>
        </div>

        <div class="chart-box">
          <div class="chart-title">C. ä¾†æºçµæ§‹ï¼ˆåœ“é¤…åœ–ï¼‰</div>
          <div class="selector-row">
            <span>æŸ¥çœ‹æœˆä»½ï¼š</span>
            <select id="yearSelect"></select>
            <select id="monthSelect"></select>
          </div>
          <div class="chart-subtitle">
            é¸æ“‡ä»»ä¸€å€‹å·²è¼¸å…¥çš„æœˆä»½ï¼ŒæŸ¥çœ‹ç•¶æœˆã€Œåˆ†äº«é€šï¼é–ƒé€å€ï¼ç¦®ç‰©æ± ï¼éœ€æ±‚æ± ã€åœ¨ç¸½å¯„ä»¶ä¸­çš„ä½”æ¯”ã€‚
          </div>
          <canvas id="channelPieChart"></canvas>
        </div>
      </div>
    </div>

    <div class="footer-note">
      è³‡æ–™ä¾†æºï¼šGCè´ˆç‰©ç¶² IBOX ä½¿ç”¨æƒ…æ³ï¼ˆGoogle è©¦ç®—è¡¨ï¼‰
    </div>
  </div>

  <script>
    // â˜…â˜…â˜… æ”¹æˆä½ çš„ Web App URL â˜…â˜…â˜…
    const API_URL = 'https://script.google.com/macros/s/AKfycbzV0q0WUo9hYlwAOs9UZQlUIU5uytPxVzg3CROwiSZFFVrjlAfGr6l7ZjQtd2RJz7CeDQ/exec';

    let totalChart = null;
    let momChart = null;
    let channelPieChart = null;
    let globalRows = [];   // å­˜å…¨éƒ¨æœˆä»½è³‡æ–™

    async function loadData() {
      const summaryBox = document.getElementById('summaryBox');
      summaryBox.textContent = 'æ­£åœ¨å¾è©¦ç®—è¡¨è¼‰å…¥è³‡æ–™â€¦';

      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'API å›å‚³éŒ¯èª¤');

        const rows = data.rows || [];
        globalRows = rows;

        renderTable(rows);
        buildRangeOptions(rows);       // é¡¯ç¤ºç¯„åœä¸‹æ‹‰é¸å–®
        buildYearMonthOptions(rows);   // å¹´/æœˆä¸‹æ‹‰ï¼Œçµ¦åœ“é¤…åœ–ç”¨
        redrawCharts();                // ä¾ç›®å‰ç¯„åœé‡ç•« A & B åœ–
        renderChannelPieBySelection(); // ä¾ç›®å‰é¸åˆ°çš„å¹´æœˆç•«åœ“é¤…
        updateInsight(rows);

      } catch (err) {
        console.error(err);
        summaryBox.textContent = 'è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š' + err.message;
      }
    }

    function renderTable(rows) {
      const tbody = document.getElementById('dataBody');
      tbody.innerHTML = '';

      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.textContent = 'ç›®å‰è©¦ç®—è¡¨å°šç„¡è³‡æ–™ã€‚';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement('tr');

        const tdMonth  = document.createElement('td');
        const tdTotal  = document.createElement('td');
        const tdShare  = document.createElement('td');
        const tdFlash  = document.createElement('td');
        const tdGift   = document.createElement('td');
        const tdDemand = document.createElement('td');

        const total = Number(r.totalCount || 0);
        const share = r.shareCount  == null ? null : Number(r.shareCount  || 0);
        const flash = r.flashCount  == null ? null : Number(r.flashCount  || 0);
        const gift  = r.giftCount   == null ? null : Number(r.giftCount   || 0);
        const dem   = r.demandCount == null ? null : Number(r.demandCount || 0);

        tdMonth.textContent = r.month || '';
        tdTotal.textContent = total.toLocaleString();
        tdShare.textContent  = share == null  ? '' : share.toLocaleString();
        tdFlash.textContent  = flash == null  ? '' : flash.toLocaleString();
        tdGift.textContent   = gift  == null  ? '' : gift.toLocaleString();
        tdDemand.textContent = dem   == null  ? '' : dem.toLocaleString();

        tr.appendChild(tdMonth);
        tr.appendChild(tdTotal);
        tr.appendChild(tdShare);
        tr.appendChild(tdFlash);
        tr.appendChild(tdGift);
        tr.appendChild(tdDemand);
        tbody.appendChild(tr);
      });
    }

    // è§£æã€Œæœˆä»½ã€å­—ä¸² â†’ {year, month}
    // æ”¯æ´ï¼š2024/01ã€2024-1ã€2024å¹´1æœˆã€2024.01 ç­‰ï¼Œåªè¦æœ‰ã€Œ4ä½å¹´ä»½ + 1~2ä½æœˆä»½ã€
    function parseYearMonth(label) {
      const text = String(label || '');
      const match = text.match(/(20\d{2})\D{0,2}(\d{1,2})/);
      if (match) {
        const year = parseInt(match[1], 10);
        const month = parseInt(match[2], 10);
        if (!isNaN(year) && !isNaN(month)) {
          return { year, month };
        }
      }
      return { year: null, month: null };
    }

    // é¡¯ç¤ºç¯„åœä¸‹æ‹‰é¸å–®ï¼šå…¨éƒ¨ / æœ€è¿‘12å€‹æœˆ / å„å¹´åº¦
    function buildRangeOptions(rows) {
      const rangeSelect = document.getElementById('rangeSelect');
      rangeSelect.innerHTML = '';

      if (!rows || rows.length === 0) return;

      // å…ˆæ”¾å›ºå®šå…©å€‹é¸é …
      let optAll = document.createElement('option');
      optAll.value = 'all';
      optAll.textContent = 'å…¨éƒ¨å¹´åº¦';
      rangeSelect.appendChild(optAll);

      let optLast12 = document.createElement('option');
      optLast12.value = 'last12';
      optLast12.textContent = 'æœ€è¿‘ 12 å€‹æœˆ';
      rangeSelect.appendChild(optLast12);

      // å†ä¾è³‡æ–™è‡ªå‹•åŠ å…¥å¹´åº¦é¸é …
      const yearSet = new Set();
      rows.forEach(r => {
        const ym = parseYearMonth(r.month);
        if (ym.year) yearSet.add(ym.year);
      });
      const years = Array.from(yearSet).sort((a, b) => a - b);
      years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = 'year-' + String(y);
        opt.textContent = 'åªçœ‹ ' + String(y) + ' å¹´';
        rangeSelect.appendChild(opt);
      });

      // é è¨­ï¼šè‹¥è³‡æ–™ç­†æ•¸ > 12ï¼Œé¸ã€Œæœ€è¿‘12å€‹æœˆã€ï¼Œå¦å‰‡ã€Œå…¨éƒ¨å¹´åº¦ã€
      if (rows.length > 12) {
        rangeSelect.value = 'last12';
      } else {
        rangeSelect.value = 'all';
      }

      rangeSelect.onchange = () => {
        redrawCharts();
      };
    }

    // æ ¹æ“šé¡¯ç¤ºç¯„åœï¼Œå›å‚³è¦çµ¦ A & B åœ–çš„è³‡æ–™
    function getFilteredRowsForCharts() {
      const rangeSelect = document.getElementById('rangeSelect');
      if (!globalRows || globalRows.length === 0 || !rangeSelect) {
        return [];
      }
      const range = rangeSelect.value || 'all';
      const rows = globalRows;

      if (range === 'all') {
        return rows;
      }

      if (range === 'last12') {
        if (rows.length <= 12) return rows;
        return rows.slice(rows.length - 12);
      }

      if (range.startsWith('year-')) {
        const year = parseInt(range.replace('year-', ''), 10);
        if (isNaN(year)) return rows;
        return rows.filter(r => {
          const ym = parseYearMonth(r.month);
          return ym.year === year;
        });
      }

      return rows;
    }

    // ä¾ç›®å‰ç¯„åœé‡ç•« A & B åœ– + æ›´æ–° summary
    function redrawCharts() {
      const filteredRows = getFilteredRowsForCharts();
      const labels = filteredRows.map(r => r.month);
      const totals = filteredRows.map(r => Number(r.totalCount || 0));

      renderTotalChart(labels, totals);
      renderMomChart(labels, totals);
      updateSummary(labels, totals);
    }

    function renderTotalChart(labels, totals) {
      const ctx = document.getElementById('totalChart').getContext('2d');
      if (totalChart) totalChart.destroy();

      totalChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ç¸½å¯„ä»¶é‡ï¼ˆä»¶ï¼‰',
            data: totals,
            borderWidth: 2,
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius: 6,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const val = context.parsed.y || 0;
                  return ' ' + val.toLocaleString() + ' ä»¶';
                }
              }
            }
          },
          scales: {
            x: { title: { display: true, text: 'æœˆä»½' } },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'ç¸½å¯„ä»¶é‡ï¼ˆä»¶ï¼‰' },
              ticks: { callback: value => value.toLocaleString() }
            }
          }
        }
      });
    }

    function renderMomChart(labels, totals) {
      const momLabels = [];
      const momValues = [];

      for (let i = 0; i < totals.length; i++) {
        if (i === 0) {
          momLabels.push(labels[i]);
          momValues.push(0);
        } else {
          momLabels.push(labels[i]);
          momValues.push((totals[i] || 0) - (totals[i - 1] || 0));
        }
      }

      const ctx = document.getElementById('momChart').getContext('2d');
      if (momChart) momChart.destroy();

      momChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: momLabels,
          datasets: [{
            label: 'èˆ‡ä¸Šæœˆå·®ç•°ï¼ˆä»¶ï¼‰',
            data: momValues,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const val = context.parsed.y || 0;
                  const sign = val > 0 ? '+' : '';
                  return ' ' + sign + val.toLocaleString() + ' ä»¶';
                }
              }
            }
          },
          scales: {
            x: { title: { display: true, text: 'æœˆä»½' } },
            y: {
              title: { display: true, text: 'èˆ‡ä¸Šæœˆå·®ç•°ï¼ˆä»¶ï¼‰' },
              ticks: {
                callback: value => {
                  const sign = value > 0 ? '+' : '';
                  return sign + value.toLocaleString();
                }
              }
            }
          }
        }
      });

      const dataset = momChart.data.datasets[0];
      dataset.backgroundColor = momValues.map(v => v >= 0 ? 'rgba(34,197,94,0.35)' : 'rgba(248,113,113,0.5)');
      dataset.borderColor     = momValues.map(v => v >= 0 ? 'rgba(22,163,74,1)'  : 'rgba(185,28,28,1)');
      momChart.update();
    }

    // å¹´ï¼æœˆä¸‹æ‹‰ï¼šçµ¦åœ“é¤…åœ–ç”¨
    function buildYearMonthOptions(rows) {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      yearSelect.innerHTML = '';
      monthSelect.innerHTML = '';

      if (!rows || rows.length === 0) return;

      const yearMonthList = rows.map(r => {
        const ym = parseYearMonth(r.month);
        return { raw: r.month, year: ym.year, month: ym.month };
      }).filter(x => x.year && x.month);

      if (yearMonthList.length === 0) {
        const option = document.createElement('option');
        option.value = 'ALL';
        option.textContent = 'å…¨éƒ¨';
        yearSelect.appendChild(option);

        const mOpt = document.createElement('option');
        mOpt.value = 'ALL';
        mOpt.textContent = 'å…¨éƒ¨';
        monthSelect.appendChild(mOpt);
        return;
      }

      const yearSet = new Set();
      const yearMonthMap = {}; // {year: Set(months)}

      yearMonthList.forEach(x => {
        yearSet.add(x.year);
        if (!yearMonthMap[x.year]) yearMonthMap[x.year] = new Set();
        yearMonthMap[x.year].add(x.month);
      });

      const years = Array.from(yearSet).sort((a, b) => a - b);
      years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y) + ' å¹´';
        yearSelect.appendChild(opt);
      });

      const last = yearMonthList[yearMonthList.length - 1];
      yearSelect.value = String(last.year);

      function fillMonthsForYear(year) {
        monthSelect.innerHTML = '';
        const monthsSet = yearMonthMap[year];
        if (!monthsSet) return;
        const months = Array.from(monthsSet).sort((a, b) => a - b);
        months.forEach(m => {
          const opt = document.createElement('option');
          opt.value = String(m);
          opt.textContent = m + ' æœˆ';
          monthSelect.appendChild(opt);
        });
      }

      fillMonthsForYear(last.year);
      monthSelect.value = String(last.month);

      yearSelect.onchange = () => {
        const y = parseInt(yearSelect.value, 10);
        if (!isNaN(y)) {
          fillMonthsForYear(y);
          renderChannelPieBySelection();
        }
      };
      monthSelect.onchange = () => {
        renderChannelPieBySelection();
      };
    }

    // ä¾å¹´/æœˆä¸‹æ‹‰é¸ï¼Œç•«ä¾†æºçµæ§‹åœ“é¤…åœ–
    function renderChannelPieBySelection() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      const ctx = document.getElementById('channelPieChart').getContext('2d');

      if (channelPieChart) channelPieChart.destroy();

      if (!globalRows || globalRows.length === 0) return;
      if (!yearSelect.value || !monthSelect.value) return;

      const selectedYear  = parseInt(yearSelect.value, 10);
      const selectedMonth = parseInt(monthSelect.value, 10);

      const targetRow = globalRows.find(r => {
        const ym = parseYearMonth(r.month);
        return ym.year === selectedYear && ym.month === selectedMonth;
      });

      if (!targetRow) return;

      const share = targetRow.shareCount  == null ? 0 : Number(targetRow.shareCount  || 0);
      const flash = targetRow.flashCount  == null ? 0 : Number(targetRow.flashCount  || 0);
      const gift  = targetRow.giftCount   == null ? 0 : Number(targetRow.giftCount   || 0);
      const dem   = targetRow.demandCount == null ? 0 : Number(targetRow.demandCount || 0);

      const labels = [];
      const data = [];

      if (share > 0) { labels.push('åˆ†äº«é€š'); data.push(share); }
      if (flash > 0) { labels.push('é–ƒé€å€'); data.push(flash); }
      if (gift  > 0) { labels.push('ç¦®ç‰©æ± '); data.push(gift); }
      if (dem   > 0) { labels.push('éœ€æ±‚æ± '); data.push(dem); }

      if (data.length === 0) {
        return;
      }

      channelPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const value = context.parsed || 0;
                  const rate = total > 0 ? (value / total) * 100 : 0;
                  return ` ${context.label}: ${value.toLocaleString()} ä»¶ï¼ˆ${rate.toFixed(1)}%ï¼‰`;
                }
              }
            }
          }
        }
      });
    }

    function updateSummary(labels, totals) {
      const box = document.getElementById('summaryBox');
      if (!labels || labels.length === 0) {
        box.textContent = 'ç›®å‰å°šæœªè¼¸å…¥æœˆåº¦è³‡æ–™ã€‚è«‹å…ˆåœ¨å¤§è¡¨å¡«å¯«ã€Œæœˆä»½ã€èˆ‡ã€Œå¯„ä»¶ç¸½æ•¸é‡ã€ã€‚';
        return;
      }

      let total = 0;
      let minVal = null, maxVal = null;
      let minLabel = '', maxLabel = '';
      const nonZero = [];

      totals.forEach((v, i) => {
        const val = Number(v) || 0;
        total += val;
        if (val > 0) nonZero.push(val);
        if (minVal === null || val < minVal) {
          minVal = val;
          minLabel = labels[i];
        }
        if (maxVal === null || val > maxVal) {
          maxVal = val;
          maxLabel = labels[i];
        }
      });

      if (nonZero.length === 0) {
        box.textContent = 'ç›®å‰è³‡æ–™éƒ½æ˜¯ 0 æˆ–ç©ºç™½ï¼Œè«‹ç¢ºèªã€Œå¯„ä»¶ç¸½æ•¸é‡ã€æ¬„ä½ã€‚';
        return;
      }

      const avg = total / nonZero.length;
      box.innerHTML =
        'ç›®å‰é¡¯ç¤ºç¯„åœå…§å…±æœ‰ <span>' + labels.length + '</span> å€‹æœˆä»½ï¼Œ' +
        'ç¸½å¯„ä»¶é‡ <span>' + total.toLocaleString() + '</span> ä»¶ï¼Œ' +
        'å¹³å‡æ¯æœˆ <span>' + Math.round(avg).toLocaleString() + '</span> ä»¶ã€‚<br>' +
        'æœ€é«˜ç‚º <span>' + maxLabel + '</span>ï¼ˆ' + maxVal.toLocaleString() + ' ä»¶ï¼‰ï¼Œ' +
        'æœ€ä½ç‚º <span>' + minLabel + '</span>ï¼ˆ' + minVal.toLocaleString() + ' ä»¶ï¼‰ã€‚';
    }

    function updateInsight(rows) {
      const insightBox = document.getElementById('insightBox');
      const insightText = document.getElementById('insightText');

      if (!rows || rows.length === 0) {
        insightBox.style.display = 'none';
        return;
      }
      insightBox.style.display = 'block';

      const latest = rows[rows.length - 1];
      const prev   = rows.length >= 2 ? rows[rows.length - 2] : null;

      const latestMonth = latest.month || 'ï¼ˆæœªå¡«ï¼‰';
      const latestTotal = Number(latest.totalCount || 0);

      let momSentence = 'ç›®å‰åªæœ‰ä¸€å€‹æœˆä»½è³‡æ–™ï¼Œå°šç„¡æ³•æ¯”è¼ƒä¸Šæœˆè®ŠåŒ–ã€‚';
      if (prev) {
        const prevTotal = Number(prev.totalCount || 0);
        const diff = latestTotal - prevTotal;
        const diffSign = diff > 0 ? 'å¢åŠ ' : (diff < 0 ? 'æ¸›å°‘' : 'æŒå¹³');
        const diffAbs = Math.abs(diff);
        const rate = prevTotal > 0 ? (diff / prevTotal) * 100 : 0;

        if (diff === 0) {
          momSentence =
            `ç›¸è¼ƒä¸Šå€‹æœˆä»½ï¼ˆ${prev.month}ï¼‰ï¼Œå¯„ä»¶é‡æŒå¹³ï¼Œçš†ç‚º ${latestTotal.toLocaleString()} ä»¶ã€‚`;
        } else {
          momSentence =
            `ç›¸è¼ƒä¸Šå€‹æœˆä»½ï¼ˆ${prev.month}ï¼‰ï¼Œæœ¬æœˆå¯„ä»¶é‡${diffSign} <b>${diffAbs.toLocaleString()}</b> ä»¶ï¼Œ` +
            `ç´„ <b>${rate.toFixed(1)}%</b>ã€‚`;
        }
      }

      let trendSentence = '';
      if (rows.length >= 3) {
        const a = Number(rows[rows.length - 3].totalCount || 0);
        const b = Number(rows[rows.length - 2].totalCount || 0);
        const c = Number(rows[rows.length - 1].totalCount || 0);

        if (a <= b && b <= c && !(a === b && b === c)) {
          trendSentence = 'éå»ä¸‰å€‹æœˆä»½å‘ˆç¾ã€Œç©©å®šæˆé•·ã€è¶¨å‹¢ï¼Œé©åˆåŠ ç¢¼æ”¾å¤§æˆåŠŸåšæ³•ã€‚';
        } else if (a >= b && b >= c && !(a === b && b === c)) {
          trendSentence = 'éå»ä¸‰å€‹æœˆä»½å‘ˆç¾ã€Œé€£çºŒä¸‹æ»‘ã€è¶¨å‹¢ï¼Œå»ºè­°æª¢è¦–è¡ŒéŠ·ï¼å¼•å°æµç¨‹æ˜¯å¦éœ€è¦èª¿æ•´ã€‚';
        } else {
          trendSentence = 'éå»ä¸‰å€‹æœˆä»½è®ŠåŒ–è¼ƒç‚ºæ³¢å‹•ï¼Œå¯èƒ½å—åˆ°æ´»å‹•æª”æœŸæˆ–å¤–éƒ¨å› ç´ å½±éŸ¿ï¼Œå»ºè­°æ­é…æ´»å‹•æ—¥æ›†ä¸€èµ·è§£è®€ã€‚';
        }
      }

      let channelSentence = '';
      const share = latest.shareCount  == null ? 0 : Number(latest.shareCount  || 0);
      const flash = latest.flashCount  == null ? 0 : Number(latest.flashCount  || 0);
      const gift  = latest.giftCount   == null ? 0 : Number(latest.giftCount   || 0);
      const dem   = latest.demandCount == null ? 0 : Number(latest.demandCount || 0);
      const total = latestTotal || 0;

      if (total > 0) {
        const shareRate = (share / total) * 100;
        const flashRate = (flash / total) * 100;
        const giftRate  = (gift  / total) * 100;
        const demRate   = (dem   / total) * 100;

        channelSentence =
          `åœ¨æœ€æ–°æœˆä»½ä¸­ï¼Œåˆ†äº«é€šç´„ä½” <b>${shareRate.toFixed(1)}%</b>ï¼Œ` +
          `é–ƒé€å€ç´„ä½” <b>${flashRate.toFixed(1)}%</b>ï¼Œ` +
          `ç¦®ç‰©æ± ç´„ä½” <b>${giftRate.toFixed(1)}%</b>ï¼Œ` +
          `éœ€æ±‚æ± ç´„ä½” <b>${demRate.toFixed(1)}%</b>ï¼ˆä»¥ç¸½å¯„ä»¶é‡ç‚ºåˆ†æ¯ï¼‰ã€‚`;
      }

      insightText.innerHTML =
        `â— æœ€æ–°æœˆä»½ç‚º <b>${latestMonth}</b>ï¼Œç¸½å¯„ä»¶é‡ç‚º <b>${latestTotal.toLocaleString()}</b> ä»¶ã€‚<br>` +
        `â— ${momSentence}<br>` +
        (trendSentence ? `â— ${trendSentence}<br>` : '') +
        (channelSentence ? `â— ${channelSentence}` : '');
    }

    function downloadMainChart() {
      if (!totalChart) {
        alert('åœ–è¡¨å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚');
        return;
      }
      const a = document.createElement('a');
      a.href = totalChart.toBase64Image('image/png', 1.0);
      a.download = 'ibox-monthly-total.png';
      a.click();
    }

    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('downloadMainBtn').addEventListener('click', downloadMainChart);

    window.addEventListener('load', loadData);
  </script>
</body>
</html>
