<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>GC IBOX æ•¸æ“šæœˆå ±</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Helvetica", "Microsoft JhengHei"; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f4f4f4; }
    h2 { margin-bottom: 6px; }
    .flex { display:flex; gap:20px; margin-top:20px; }
    .panel { border:1px solid #ddd; padding:10px; border-radius:6px; }
  </style>
</head>

<body>

<script>
/* ---- åªæ”¹é€™ä¸€æ®µ URL ---- */
const API_URL = "https://script.google.com/macros/s/AKfycbx9eVJpOxflNXwrMmTFFQsR74f74Vr9RYlOXi5NU7DKDVQE_05VDTraZ6TRtl-t8A6nXg/exec";

let globalRows = [];
let totalChart, momChart, channelPieChart;

/* ğŸ“Œ å·¥å…·ï¼šè§£ææœˆä»½ */
function parseMonth(text){
  if(!text) return null;
  const m=text.match(/(20\d{2}).*?(\d{1,2})/);
  return m?`${m[1]}-${String(m[2]).padStart(2,"0")}`:String(text);
}

/* ğŸ“Œ ä¸»æµç¨‹ */
async function loadData(){
  try{
    const res=await fetch(API_URL);
    const json=await res.json();
    globalRows=json.rows||[];
    renderTable();
    buildFilters();
    drawCharts();
    drawPie();
    writeInsight();
  }catch(e){
    console.error(e);
  }
}

/* ğŸ“Œ è¡¨æ ¼ */
function renderTable(){
  const tbody=document.getElementById("dataBody");
  tbody.innerHTML="";

  globalRows.forEach(r=>{
    tbody.innerHTML+=`
      <tr>
        <td>${parseMonth(r.month)}</td>
        <td>${r.totalCount ?? ""}</td>
        <td>${r.shareCount ?? ""}</td>
        <td>${r.flashCount ?? ""}</td>
        <td>${r.giftCount ?? ""}</td>
        <td>${r.demandCount ?? ""}</td>
      </tr>
    `;
  });
}

/* ğŸ“Œ ç¯©é¸ */
function buildFilters(){
  const sel=document.getElementById("rangeSelect");
  sel.innerHTML=`
    <option value="all">å…¨éƒ¨</option>
    <option value="last12">æœ€è¿‘12å€‹æœˆ</option>
  `;
}

/* ğŸ“Œ æŠ˜ç·š & å·®ç•°åœ– */
function drawCharts(){
  const ctx1=document.getElementById("totalChart");
  const ctx2=document.getElementById("momChart");

  const labels=globalRows.map(r=>parseMonth(r.month));
  const totals=globalRows.map(r=>Number(r.totalCount||0));
  const diff=totals.map((v,i)=>i===0?0:v-totals[i-1]);

  if(totalChart) totalChart.destroy();
  totalChart=new Chart(ctx1,{
    type:"line",
    data:{labels,datasets:[{label:"å¯„ä»¶é‡",data:totals,borderWidth:2,tension:0.2}]}
  });

  if(momChart) momChart.destroy();
  momChart=new Chart(ctx2,{
    type:"bar",
    data:{labels,datasets:[{label:"èˆ‡ä¸Šæœˆå¢æ¸›",data:diff}]}
  });
}

/* ğŸ“Œ åœ“é¤…åœ– */
function drawPie(){
  const row=globalRows[globalRows.length-1];
  const labels=["åˆ†äº«é€š","é–ƒé€å€","ç¦®ç‰©æ± ","éœ€æ±‚æ± "];
  const values=[row.shareCount,row.flashCount,row.giftCount,row.demandCount];

  if(channelPieChart) channelPieChart.destroy();
  channelPieChart=new Chart(document.getElementById("pieChart"),{
    type:"pie",
    data:{labels,datasets:[{data:values}]}
  });
}

/* ğŸ“Œ Insight */
function writeInsight(){
  const el=document.getElementById("insight");
  const row=globalRows.at(-1);
  const prev=globalRows.length>1?globalRows.at(-2):null;

  let txt=`ğŸ“Œ æœ€æ–°æœˆä»½ï¼š${parseMonth(row.month)}<br>ç¸½å¯„ä»¶é‡ï¼š<b>${row.totalCount}</b> ä»¶`;
  if(prev){
    const diff=row.totalCount-prev.totalCount;
    txt+=`<br>èˆ‡ä¸Šæœˆç›¸æ¯”ï¼š<b>${diff>0?`å¢åŠ  ${diff}`:diff<0?`æ¸›å°‘ ${Math.abs(diff)}`:"æŒå¹³"}</b>`;
  }
  el.innerHTML=txt;
}

window.onload=loadData;
</script>


<!-- ğŸ“¦ è¡¨æ ¼ -->
<h2>ğŸ“¦ å¯„ä»¶çµ±è¨ˆè¡¨</h2>
<table>
<thead>
<tr>
<th>æœˆä»½</th><th>å¯„ä»¶ç¸½é‡</th><th>åˆ†äº«é€š</th><th>é–ƒé€å€</th><th>ç¦®ç‰©æ± </th><th>éœ€æ±‚æ± </th>
</tr>
</thead>
<tbody id="dataBody"></tbody>
</table>

<br>

<!-- ğŸ“… ç¯©é¸ -->
é¡¯ç¤ºç¯„åœï¼š <select id="rangeSelect"></select>

<!-- ğŸ“ˆ åœ–è¡¨ -->
<div class="flex">
  <div class="panel" style="flex:1;">
    <h3>è¶¨å‹¢ç·š</h3>
    <canvas id="totalChart"></canvas>
  </div>
  <div class="panel" style="flex:1;">
    <h3>æœˆå¢æ¸›é‡</h3>
    <canvas id="momChart"></canvas>
  </div>
</div>

<!-- ğŸ¥§ åœ“é¤… -->
<div class="panel" style="width:300px;margin-top:20px;">
<h3>åˆ†å¸ƒæ¯”ä¾‹</h3>
<canvas id="pieChart"></canvas>
</div>

<!-- ğŸ§  Insight -->
<div id="insight" class="panel" style="margin-top:20px;background:#fef9c3;"></div>

</body>
</html>
