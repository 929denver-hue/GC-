<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>GC IBOX æ•¸æ“šå„€è¡¨æ¿</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --gc-green: #2DB57D;
      --gc-blue: #59C3FF;
      --gc-yellow: #FFD268;
      --gc-red: #FF7A7A;
      --text-dark: #1a1a1a;
      --text-light: #777;
    }
    body {
      font-family: "Inter","Microsoft JhengHei",Helvetica;
      background:#f7f7f7;
      max-width:1100px;
      margin:30px auto;
      padding:20px;
      color:var(--text-dark);
    }
    h2 { margin-bottom:8px; }
    h3 { margin-top:0; margin-bottom:8px; }
    .panel {
      background:white;
      padding:16px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
      margin-bottom:20px;
    }
    table {
      width:100%; border-collapse:collapse; background:white;
      border-radius:8px; overflow:hidden;
      font-size:14px;
    }
    th {
      background:var(--gc-green);
      color:white;
      padding:10px;
    }
    td {
      text-align:center;
      padding:8px;
      border-bottom:1px solid #eee;
    }
    tbody tr:hover { background:#f1fff7; transition:0.3s; }

    .flex { display:flex; gap:22px; flex-wrap:wrap; }
    .chart-box { flex:1; min-width:350px; height:260px; }

    /* MoM / YoY é¡è‰²ï¼šæˆé•·ç´…ã€æ¸›å°‘ç¶ ã€æŒå¹³ç° */
    .growth {
      color: #d91e18;
      font-weight:600;
    }
    .decline {
      color: #0f8b4b;
      font-weight:600;
    }
    .neutral {
      color:#7c7c7c;
    }

    /* RWD */
    @media(max-width:768px){
      body{padding:10px;}
      .chart-box{min-width:100%;}
    }
  </style>
</head>

<body>

<script>
// ğŸ”§ é€™è£¡æ”¹æˆä½ è‡ªå·±çš„ Web App URL
const API_URL = "https://script.google.com/macros/s/AKfycbx9eVJpOxflNXwrMmTFFQsR74f74Vr9RYlOXi5NU7DKDVQE_05VDTraZ6TRtl-t8A6nXg/exec";

let globalRows = [];
let totalChart, momChart, pieChart;

/* è§£æã€Œæœˆä»½ã€ç‚º 'YYYY-MM'ï¼Œå…ˆäº¤çµ¦ Date è™•ç†ï¼Œé˜²æ­¢ 2025-00 é€™ç¨®æƒ…æ³ */
function parseMonth(raw) {
  if (raw == null) return "";
  const s = String(raw).trim();

  // 1) å„ªå…ˆç”¨ Date è§£æï¼ˆè™•ç† Fri Nov 01 2024 00:00:00 GMT+0800 é€™ç¨®ï¼‰
  const d = new Date(s);
  if (!isNaN(d.getTime())) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    return `${y}-${m}`;
  }

  // 2) å·²ç¶“æ˜¯ YYYY-MM / YYYY/M / YYYYå¹´MMæœˆ
  let m = s.match(/^(\d{4})[-/](\d{1,2})$/);
  if (m) return `${m[1]}-${m[2].padStart(2,"0")}`;

  m = s.match(/(20\d{2})\D+(\d{1,2})\D*æœˆ?/);
  if (m) return `${m[1]}-${m[2].padStart(2,"0")}`;

  // 3) æœ€å¾Œä¿éšªï¼šæŠ“ç¬¬ä¸€å€‹å¹´ä»½èˆ‡ä¸€å€‹æ•¸å­—
  m = s.match(/(20\d{2}).*?(\d{1,2})/);
  if (m) return `${m[1]}-${m[2].padStart(2,"0")}`;

  return s;
}

/* æˆé•·/æ¸›å°‘ é¡è‰² classï¼šæˆé•·=ç´…ï¼Œæ¸›å°‘=ç¶  */
function diffClass(value) {
  if (value === null || value === 0) return "neutral";
  if (value > 0) return "growth";   // æˆé•·ï¼šç´…
  if (value < 0) return "decline";  // æ¸›å°‘ï¼šç¶ 
  return "neutral";
}

/* è®€å–è³‡æ–™ */
async function loadData() {
  try {
    const res  = await fetch(API_URL);
    const json = await res.json();
    globalRows  = json.rows || [];

    buildTableFilter();
    applyFilterToTable();

    drawCharts();
    drawPie();
  } catch (e) {
    console.error(e);
  }
}

/* ========== è¡¨æ ¼å€ï¼šç¯©é¸ ========== */
function buildTableFilter() {
  const sel = document.getElementById("tableFilter");
  sel.innerHTML = `
    <option value="all">å…¨éƒ¨å¹´ä»½</option>
    <option value="last12">æœ€è¿‘12å€‹æœˆ</option>
  `;
  const years = [...new Set(globalRows.map(r => parseMonth(r.month).slice(0,4)))].sort();
  years.forEach(y => {
    sel.innerHTML += `<option value="${y}">${y} å¹´</option>`;
  });
  sel.value = globalRows.length > 12 ? "last12" : "all";
  sel.onchange = applyFilterToTable;
}

function applyFilterToTable() {
  const mode = document.getElementById("tableFilter").value;
  let rows = [...globalRows];

  if (mode === "last12") {
    rows = rows.slice(-12);
  } else if (mode !== "all") {
    rows = rows.filter(r => parseMonth(r.month).startsWith(mode));
  }
  renderTable(rows);
}

/* ========== è¡¨æ ¼ï¼šå« MoM / YoY ========== */
function renderTable(rows) {
  const tbody = document.getElementById("dataBody");
  tbody.innerHTML = "";

  rows.forEach((r, idx) => {
    const monthKey = parseMonth(r.month);            // '2025-03'
    const displayMonth = `${monthKey.slice(0,4)} / ${monthKey.slice(5,7)}`; // '2025 / 03'
    const total = Number(r.totalCount || 0);

    // MoMï¼šèˆ‡ä¸Šä¸€åˆ—æ¯”è¼ƒï¼ˆåŒç¯©é¸ç¯„åœå…§ï¼‰
    let mom = null;
    if (idx > 0) {
      mom = total - Number(rows[idx - 1].totalCount || 0);
    }

    // YoYï¼šå¾ã€Œæ‰€æœ‰æ­·å² globalRowsã€ä¸­æ‰¾å»å¹´åŒæœˆ
    let yoy = null;
    const year  = parseInt(monthKey.slice(0,4), 10);
    const month = monthKey.slice(5,7);
    const lastYearRow = globalRows.find(row => parseMonth(row.month) === `${year-1}-${month}`);
    if (lastYearRow) {
      yoy = total - Number(lastYearRow.totalCount || 0);
    }

    tbody.innerHTML += `
      <tr>
        <td>${displayMonth}</td>
        <td>${total.toLocaleString()}</td>
        <td>${r.shareCount ?? ""}</td>
        <td>${r.flashCount ?? ""}</td>
        <td>${r.giftCount ?? ""}</td>
        <td>${r.demandCount ?? ""}</td>

        <td class="${diffClass(mom)}">
          ${mom === null ? "-" : (mom > 0 ? "+" : "") + mom.toLocaleString()}
        </td>
        <td class="${diffClass(yoy)}">
          ${yoy === null ? "-" : (yoy > 0 ? "+" : "") + yoy.toLocaleString()}
        </td>
      </tr>
    `;
  });
}

/* ========== åœ–è¡¨å€ ========== */
function drawCharts() {
  const labels = globalRows.map(r => {
    const m = parseMonth(r.month);
    return `${m.slice(0,4)}/${m.slice(5,7)}`;
  });
  const totals = globalRows.map(r => Number(r.totalCount || 0));
  const diff   = totals.map((v,i) => i===0 ? 0 : v - totals[i-1]);

  // æŠ˜ç·šï¼šå¯„ä»¶è¶¨å‹¢
  if (totalChart) totalChart.destroy();
  totalChart = new Chart(document.getElementById("totalChart"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "å¯„ä»¶é‡",
        data: totals,
        borderColor: "#2DB57D",
        backgroundColor: "rgba(45,181,125,.2)",
        fill: true,
        tension: .35,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y.toLocaleString()} ä»¶`
          }
        }
      }
    }
  });

  // æœˆå¢æ¸›ï¼šæˆé•·ç´…ã€æ¸›å°‘ç¶ 
  if (momChart) momChart.destroy();
  momChart = new Chart(document.getElementById("momChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "èˆ‡ä¸Šæœˆå·®ç•°",
        data: diff,
        backgroundColor: diff.map(v => v >= 0 ? "#d91e18" : "#0f8b4b")
      }]
    },
    options: {
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y > 0 ? "+" : ""}${ctx.parsed.y.toLocaleString()} ä»¶`
          }
        }
      }
    }
  });
}

/* æœ€æ–°æœˆä»½ï¼šä¾†æºåˆ†å¸ƒåœ“é¤… */
function drawPie() {
  const r = globalRows.at(-1);
  if (!r) return;

  if (pieChart) pieChart.destroy();
  pieChart = new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels:["åˆ†äº«é€š","é–ƒé€å€","ç¦®ç‰©æ± ","éœ€æ±‚æ± "],
      datasets:[{
        data:[r.shareCount,r.flashCount,r.giftCount,r.demandCount],
        backgroundColor:["#2DB57D","#59C3FF","#FFD268","#FF7A7A"]
      }]
    }
  });
}

window.onload = loadData;
</script>


<!-- ====================== UI ====================== -->

<div class="panel">
  <h2>ğŸ“¦iéƒµç®±å¯„ä»¶çµ±è¨ˆè¡¨</h2>
  <div style="margin-bottom:10px;">
    é¡¯ç¤ºæ–¹å¼ï¼š
    <select id="tableFilter"></select>
  </div>

  <table>
    <thead>
      <tr>
        <th>æœˆä»½</th>
        <th>å¯„ä»¶ç¸½é‡</th>
        <th>åˆ†äº«é€š</th>
        <th>é–ƒé€å€</th>
        <th>ç¦®ç‰©æ± </th>
        <th>éœ€æ±‚æ± </th>
        <th>èˆ‡ä¸Šå€‹æœˆæ¯”è¼ƒ</th>
        <th>èˆ‡å»å¹´åŒæœŸæ¯”è¼ƒ</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

<div class="flex">
  <div class="panel chart-box">
    <h3>ğŸ“ˆ å¯„ä»¶è¶¨å‹¢</h3>
    <canvas id="totalChart"></canvas>
  </div>
  <div class="panel chart-box">
    <h3>ğŸ“Š å¯„ä»¶æ•¸æœˆåº¦è®ŠåŒ–</h3>
    <canvas id="momChart"></canvas>
  </div>
</div>

<div class="panel chart-box">
  <h3>ğŸ¥§ æœ€æ–°æœˆä»½ä¾†æºåˆ†å¸ƒ</h3>
  <canvas id="pieChart"></canvas>
</div>

</body>
</html>
