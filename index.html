<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GCè´ˆç‰©ç¶²ï½œåŒ…è£¹ç•°å¸¸é€šå ±</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f8f9fa; padding:20px; }
    h1 { color:#2c7a7b; text-align:center; }
    form { background:white; padding:20px; border-radius:12px; max-width:800px; margin:auto; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    label { display:block; margin-top:12px; font-weight:bold; }
    input, select, textarea { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-top:4px; }

    /* è®“ checkbox ä¸å—å…¨åŸŸ input{width:100%} å½±éŸ¿ */
    input[type="checkbox"] { width:auto; margin:0; }

    .checkbox-group { display:flex; flex-wrap:wrap; gap:16px; margin-top:8px; }
    .checkbox-group label { font-weight:normal; display:flex; align-items:center; gap:4px; white-space:nowrap; }

    .inline-checkbox { display:flex; align-items:center; gap:8px; margin-top:8px; }

    button { margin-top:20px; padding:10px 20px; background:#2c7a7b; color:white; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#285e61; }

    #status { text-align:center; margin-top:20px; font-weight:bold; }

    .card {
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:16px;
      max-width:800px;
      margin:16px auto;
      box-shadow:0 1px 4px rgba(0,0,0,0.06);
    }
    .card h2 { margin:0 0 8px; font-size:18px; color:#1f2937; }

    .meta {
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      font-size:14px;
      color:#374151;
    }
    @media (min-width: 720px) {
      .meta { grid-template-columns:1fr 1fr; }
    }
    .meta div {
      background:#f9fafb;
      border:1px solid #eef2f7;
      border-radius:8px;
      padding:8px 10px;
    }
    .meta b {
      display:block;
      font-weight:600;
      color:#111827;
      margin-bottom:2px;
    }

    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip {
      background:#e6f4ff;
      border:1px solid #bfdbfe;
      color:#0f172a;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
    }

    .badge {
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }
    .badge.ok {
      background:#ecfdf5;
      color:#065f46;
      border:1px solid #a7f3d0;
    }
    .badge.warn {
      background:#fff7ed;
      color:#9a3412;
      border:1px solid #fed7aa;
    }
    .badge.close {
      background:#f1f5f9;
      color:#0f172a;
      border:1px solid #cbd5e1;
    }
  </style>
</head>
<body>
  <h1>GCè´ˆç‰©ç¶²ï½œåŒ…è£¹ç•°å¸¸é€šå ±è¡¨å–®</h1>

  <!-- åªè®€å±•ç¤ºå€ï¼šè¼‰å…¥å–®è™Ÿå¾Œé¡¯ç¤ºæ‘˜è¦ -->
  <section id="overviewCard" class="card" aria-live="polite">
    <h2>æ¡ˆä»¶æ‘˜è¦</h2>
    <div id="overviewStatus"><span class="badge warn">å°šæœªè¼‰å…¥å–®è™Ÿ</span></div>
    <div class="meta" id="overviewMeta" style="display:none"></div>
  </section>

  <!-- é€šå ±è€…è¡¨å–® -->
  <form id="reportForm">
    <label>è¨—é‹å–®è™Ÿ</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="text" id="waybill" required style="flex:1;">
      <button type="button" id="load_report_waybill" style="white-space:nowrap;">è¼‰å…¥æ­¤å–®è™Ÿè³‡æ–™</button>
    </div>

    <label>è´ˆç‰©åç¨±</label>
    <input type="text" id="item_name">

    <label>è´ˆç‰©é€£çµ</label>
    <input type="url" id="item_url">

    <label>è´ˆé€æ—¥æœŸ</label>
    <input type="date" id="ship_date">

    <label>å¯„ä»¶æ–¹å¼</label>
    <select id="ship_method">
      <option value="iéƒµç®±">iéƒµç®±</option>
      <option value="èŠçˆ¾å¯Œ">èŠçˆ¾å¯Œ</option>
      <option value="7-11">7-11</option>
      <option value="å…¨å®¶">å…¨å®¶</option>
    </select>

    <label>æ”¶ä»¶äººå§“å</label>
    <input type="text" id="recv_name">

    <label>æ”¶ä»¶äººé›»è©±</label>
    <input type="text" id="recv_phone">

    <label>æ”¶ä»¶åœ°å€æˆ–æ“šé»åç¨±</label>
    <textarea id="recv_addr"></textarea>

    <label>å•é¡Œé¡å‹</label>
    <select id="issue_type">
      <option value="åŒ…è£¹åœæ»¯æœªæ›´æ–°">åŒ…è£¹åœæ»¯æœªæ›´æ–°</option>
      <option value="æ“ä½œæœ‰èª¤ï¼ŒåŒ…è£¹æœªæŠ•å…¥">æ“ä½œæœ‰èª¤ï¼ŒåŒ…è£¹æœªæŠ•å…¥</option>
      <option value="æ”¶ä»¶äººæœªæ”¶åˆ°">æ”¶ä»¶äººæœªæ”¶åˆ°</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>

    <label>ç•°å¸¸ç°¡è¿°</label>
    <textarea id="brief"></textarea>

    <label>åæ‡‰æ™‚é–“</label>
    <input type="date" id="report_date">

    <button type="submit">å„²å­˜ï¼æ›´æ–°åˆ°è©¦ç®—è¡¨</button>
  </form>

  <h1 style="margin-top:32px; text-align:center; color:#2c7a7b;">æŸ¥è©¢è€…æ›´æ–°å€</h1>

  <!-- æŸ¥è©¢è€…æ›´æ–°å€ -->
  <form id="queryForm">
    <label>è¨—é‹å–®è™Ÿï¼ˆèˆ‡ä¸Šæ–¹ç›¸åŒï¼‰</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="text" id="q_waybill" required style="flex:1;">
      <button type="button" id="load_query_waybill" style="white-space:nowrap;">è¼‰å…¥æ­¤å–®è™Ÿè³‡æ–™</button>
    </div>

    <label>æŸ¥è©¢æ—¥æœŸï¼ˆGCçª—å£è©¢å•â†’éƒµå±€ï¼‰</label>
    <input type="date" id="query_date">

    <label>æŸ¥è©¢çµæœï¼ˆå¯è¤‡é¸ï¼‰</label>
    <div class="checkbox-group">
      <label><input type="checkbox" class="q_query_result" value="é€šçŸ¥éƒµå±€çª—å£"> é€šçŸ¥éƒµå±€çª—å£</label>
      <label><input type="checkbox" class="q_query_result" value="æä¾›æŸ¥å–®"> æä¾›æŸ¥å–®</label>
      <label><input type="checkbox" class="q_query_result" value="éƒµå±€è‡´é›»ç¢ºèª"> éƒµå±€è‡´é›»ç¢ºèª</label>
    </div>

    <label>ç‹€æ…‹æ›´æ–°æ—¥æœŸï¼ˆæ›´æ–°å¾Œï¼Œmailä¸»å‹•é€šçŸ¥infoï¼‰</label>
    <input type="date" id="status_date">

    <div class="inline-checkbox">
      <input type="checkbox" id="need_follow">
      <label for="need_follow">éœ€æŒçºŒè¿½è¹¤ï¼ˆmailæé†’ 09:00 ï¼‰</label>
    </div>

    <label>æé†’æ—¥æœŸï¼ˆfollow_dateï¼‰</label>
    <input type="date" id="follow_date">

    <label>é€šçŸ¥ä¿¡ç®±ï¼ˆå¯é€—è™Ÿåˆ†éš”å¤šäººï¼›ç•™ç©ºç”¨é è¨­ï¼‰</label>
    <input type="email" id="notify_email" placeholder="shin@give-circle.com">

    <label>æœ€çµ‚çµæœ</label>
    <select id="final_result">
      <option value="">ï¼ˆæœªé¸ï¼‰</option>
      <option value="å·²ç¢ºèªå¯ä»¥é€€é»">å·²ç¢ºèªå¯ä»¥é€€é»</option>
      <option value="å·²æˆåŠŸé€é”">å·²æˆåŠŸé€é”</option>
      <option value="éºå¤±ç†è³ ">éºå¤±ç†è³ </option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>

    <label>è£œå„Ÿæˆ–å¾ŒçºŒè™•ç†èªªæ˜</label>
    <textarea id="after_note"></textarea>

    <label>çµæ¡ˆæ—¥æœŸï¼ˆå¡«å…¥å¾Œå°‡ä¸å†å¯„å‡ºæœªä¾†æé†’ï¼‰</label>
    <input type="date" id="close_date">

    <button type="submit">å„²å­˜ï¼æ›´æ–°ï¼ˆæŸ¥è©¢è€…ï¼‰</button>
  </form>

  <div id="status"></div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbwD6TWuDmswXDvxh1mEXYazs29gxfHWR06_zSCfQiUa-eiWaXubq4zzRdtkRccEmL4U/exec";
    const statusEl = document.getElementById('status');

    // âœ… å…±ç”¨ï¼šfire-and-forget å‘¼å« APIï¼Œé¿å… CORS å°è‡´ Failed to fetch
    async function saveToSheet(data, okMessage) {
      statusEl.textContent = 'è³‡æ–™é€å‡ºä¸­â€¦';

      try {
        // mode: 'no-cors' è®“ç€è¦½å™¨ä¸è¦æª¢æŸ¥ CORSï¼Œç•¶æˆã€Œé€å‡ºå°±å¥½ã€
        await fetch(API_BASE, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(data)
        });

        // ç„¡æ³•è®€å–å›æ‡‰å…§å®¹ï¼Œä½†å¾Œç«¯ç¢ºå¯¦æœ‰æ”¶åˆ°ï¼ˆä½ å·²åœ¨è©¦ç®—è¡¨é©—è­‰ï¼‰
        statusEl.textContent = okMessage || 'âœ… å·²é€å‡ºï¼Œç³»çµ±å°‡è³‡æ–™å¯«å…¥è©¦ç®—è¡¨';
        console.log('âœ… å·²é€å‡º payloadï¼š', data);
      } catch (err) {
        console.error('âŒ saveToSheet ç™¼ç”ŸéŒ¯èª¤ï¼š', err);
        statusEl.textContent = 'âŒ é€£ç·šå¤±æ•—æˆ–ç€è¦½å™¨é˜»æ“‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n' + err.message;
        throw err;
      }
    }

    // é€šå ±è€…é€å‡º
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        role: 'report',
        waybill: document.getElementById('waybill').value.trim(),
        item_name: document.getElementById('item_name').value.trim(),
        item_url: document.getElementById('item_url').value.trim(),
        ship_date: document.getElementById('ship_date').value,
        ship_method: document.getElementById('ship_method').value,
        recv_name: document.getElementById('recv_name').value.trim(),
        recv_phone: document.getElementById('recv_phone').value.trim(),
        recv_addr: document.getElementById('recv_addr').value.trim(),
        issue_type: document.getElementById('issue_type').value,
        brief: document.getElementById('brief').value.trim(),
        report_date: document.getElementById('report_date').value
      };

      if (!data.waybill) {
        statusEl.textContent = 'âŒ è«‹è¼¸å…¥è¨—é‹å–®è™Ÿ';
        return;
      }

      try {
        await saveToSheet(data, 'âœ… é€šå ±è³‡æ–™å·²æˆåŠŸå¯«å…¥è©¦ç®—è¡¨ï¼');
        // æˆåŠŸå¾Œé‡æ–°è¼‰å…¥æ‘˜è¦ï¼ˆæ³¨æ„ï¼šå› ç‚º GET ä»å— CORS ç´„æŸï¼Œè‹¥æœ‰å•é¡Œå¯ä»¥ç•¥éï¼‰
        loadByWaybill(data.waybill);
      } catch (err) {
        // éŒ¯èª¤å·²åœ¨ saveToSheet è™•ç†
      }
    });

    // å·¥å…·ï¼šæ”¶é›†æŸ¥è©¢çµæœ checkbox
    function collectCheckedValues(cls) {
      return Array.from(document.querySelectorAll('.' + cls + ':checked')).map(el => el.value);
    }

    // æŸ¥è©¢è€…é€å‡º
    document.getElementById('queryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        role: 'query',
        waybill: document.getElementById('q_waybill').value.trim(),
        query_date: document.getElementById('query_date').value,
        query_result: collectCheckedValues('q_query_result'),
        status_date: document.getElementById('status_date').value,
        need_follow: document.getElementById('need_follow').checked,
        follow_date: document.getElementById('follow_date').value,
        notify_email: document.getElementById('notify_email').value.trim(),
        final_result: document.getElementById('final_result').value,
        after_note: document.getElementById('after_note').value.trim(),
        close_date: document.getElementById('close_date').value
      };

      if (!payload.waybill) {
        statusEl.textContent = 'âŒ è«‹è¼¸å…¥è¨—é‹å–®è™Ÿ';
        return;
      }

      try {
        await saveToSheet(payload, 'âœ… æŸ¥è©¢è€…è³‡æ–™å·²æ›´æ–°ï¼ˆå¦‚å‹¾é¸éœ€è¿½è¹¤ï¼Œå°‡æ–¼æé†’æ—¥ 09:00 å¯„ä¿¡ï¼‰');
        loadByWaybill(payload.waybill);
      } catch (err) {
        // éŒ¯èª¤å·²åœ¨ saveToSheet è™•ç†
      }
    });

    // --- åªè®€å±•ç¤ºå€ï¼šæ¸²æŸ“æ‘˜è¦ ---
    function renderOverview(d){
      const statusBox = document.getElementById('overviewStatus');
      const metaBox = document.getElementById('overviewMeta');

      if(!d){
        statusBox.innerHTML = '<span class="badge warn">å°šæœªè¼‰å…¥å–®è™Ÿ</span>';
        metaBox.style.display='none';
        metaBox.innerHTML='';
        return;
      }

      const closed = !!d.close_date;
      const need = String(d.need_follow).toLowerCase()==='true';
      let badge = '<span class="badge ok">è¿½è¹¤ä¸­</span>';
      if (closed) badge = '<span class="badge close">å·²çµæ¡ˆ</span>';
      else if (need) badge = '<span class="badge ok">éœ€è¿½è¹¤</span>';
      else badge = '<span class="badge warn">æœªè¨­å®šè¿½è¹¤</span>';

      const qr = Array.isArray(d.query_result)
        ? d.query_result
        : (d.query_result ? String(d.query_result).split(',').map(s=>s.trim()) : []);
      const chips = qr.length
        ? qr.map(s=>`<span class="chip">${s}</span>`).join('')
        : '<span style="color:#6b7280">ï¼ˆç„¡ï¼‰</span>';

      statusBox.innerHTML = `${badge}ã€€<b>è¨—é‹å–®è™Ÿï¼š</b>${d.waybill || ''}`;

      const itemLink = d.item_url
        ? `<a href="${d.item_url}" target="_blank" rel="noopener">${d.item_name||'(æœªå¡«)'} â†—</a>`
        : (d.item_name||'(æœªå¡«)');

      metaBox.style.display='grid';
      metaBox.innerHTML = `
        <div><b>è´ˆç‰©</b>${itemLink}</div>
        <div><b>å¯„ä»¶æ–¹å¼ï¼æ—¥æœŸ</b>${d.ship_method||''} ï¼ ${d.ship_date||''}</div>
        <div><b>æ”¶ä»¶äºº</b>${d.recv_name||''}ï¼${d.recv_phone||''}</div>
        <div><b>æ“šé»</b>${d.recv_addr||''}</div>
        <div><b>å•é¡Œé¡å‹</b>${d.issue_type||''}</div>
        <div><b>ç•°å¸¸ç°¡è¿°</b>${d.brief||''}</div>
        <div><b>æŸ¥è©¢æ—¥æœŸ</b>${d.query_date||''}</div>
        <div><b>æŸ¥è©¢çµæœ</b><div class="chips">${chips}</div></div>
        <div><b>ç‹€æ…‹æ›´æ–°</b>${d.status_date||''}</div>
        <div><b>æœ€çµ‚çµæœ</b>${d.final_result||''}</div>
        <div><b>å¾ŒçºŒèªªæ˜</b>${d.after_note||''}</div>
        <div><b>çµæ¡ˆæ—¥æœŸ</b>${d.close_date||''}</div>
      `;
    }

    function clearOverview(){ renderOverview(null); }

    // --- è¼‰å…¥ï¼šä¾è¨—é‹å–®è™ŸæŸ¥è©¢ä¸¦å¸¶å…¥è¡¨å–®æ¬„ä½ ---
    async function loadByWaybill(wb){
      const waybill = (wb || '').trim();
      if(!waybill){
        statusEl.textContent='âŒ è«‹è¼¸å…¥è¨—é‹å–®è™Ÿ';
        return;
      }
      statusEl.textContent = 'æŸ¥è©¢ä¸­â€¦';
      try{
        const res = await fetch(`${API_BASE}?waybill=${encodeURIComponent(waybill)}`);
        const json = await res.json();
        if(!json || json.ok !== true){
          throw new Error('API å›å‚³é ok');
        }
        const d = json.data;
        if(!d){
          statusEl.textContent = 'ğŸ” æŸ¥ç„¡æ­¤å–®è™Ÿçš„è¨˜éŒ„';
          clearOverview();
          return;
        }
        // åŒæ­¥å…©å€‹å–®è™Ÿæ¬„ä½
        document.getElementById('waybill').value = waybill;
        document.getElementById('q_waybill').value = waybill;

        // åŸºæœ¬è¡¨å–®ï¼ˆè´ˆé€è€…ï¼‰
        setIf('item_name', d.item_name);
        setIf('item_url', d.item_url);
        setIf('ship_date', d.ship_date);
        setIf('ship_method', d.ship_method);
        setIf('recv_name', d.recv_name);
        setIf('recv_phone', d.recv_phone);
        setIf('recv_addr', d.recv_addr);
        setIf('issue_type', d.issue_type);
        setIf('brief', d.brief);
        setIf('report_date', d.report_date);

        // æŸ¥è©¢è€…æ›´æ–°å€
        setIf('query_date', d.query_date);
        setIf('status_date', d.status_date);

        const qrs = Array.isArray(d.query_result)
          ? d.query_result
          : (d.query_result ? String(d.query_result).split(',').map(s=>s.trim()) : []);
        document.querySelectorAll('.q_query_result').forEach(el=>{
          el.checked = qrs.includes(el.value);
        });

        document.getElementById('need_follow').checked =
          String(d.need_follow).toLowerCase()==='true';
        setIf('follow_date', d.follow_date);
        setIf('notify_email', d.notify_email);
        setIf('final_result', d.final_result);
        setIf('after_note', d.after_note);
        setIf('close_date', d.close_date);

        renderOverview(d);
        statusEl.textContent = 'âœ… å·²è¼‰å…¥è³‡æ–™';
      }catch(err){
        console.error(err);
        statusEl.textContent = 'âŒ æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
      }
    }

    function setIf(id, val){
      if(val != null && document.getElementById(id)){
        document.getElementById(id).value = val;
      }
    }

    // æŒ‰éˆ•äº‹ä»¶ï¼šè¼‰å…¥æ­¤å–®è™Ÿè³‡æ–™
    document.getElementById('load_report_waybill').addEventListener('click',()=>{
      loadByWaybill(document.getElementById('waybill').value);
    });
    document.getElementById('load_query_waybill').addEventListener('click',()=>{
      loadByWaybill(document.getElementById('q_waybill').value);
    });
  </script>
</body>
</html>
